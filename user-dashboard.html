<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sportova User Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --success-color: #4cc9f0;
      --warning-color: #f9c74f;
      --danger-color: #f94144;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --sidebar-width: 250px;
      --header-height: 70px;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fb;
      overflow-x: hidden;
      height: 100vh;
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: var(--sidebar-width);
      background-color: var(--dark-color);
      color: white;
      padding: 1rem;
      z-index: 1000;
      transition: all 0.3s;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .sidebar.collapsed {
      width: 70px;
    }

    .sidebar.collapsed .sidebar-text {
      display: none;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      padding: 1rem 0;
      margin-bottom: 1rem;
      border-bottom: 1px solid #495057;
    }

    .sidebar-logo {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      margin-right: 10px;
    }

    .sidebar-title {
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 0;
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
    }

    .sidebar-menu li {
      margin-bottom: 0.3rem;
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: #bdc3c7;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .sidebar-menu a:hover,
    .sidebar-menu a.active {
      background-color: var(--primary-color);
      color: white;
    }

    .sidebar-menu i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 1rem;
      border-top: 1px solid #495057;
    }

    /* Main Content Styles */
    .main-content {
      margin-left: var(--sidebar-width);
      padding: 20px;
      transition: all 0.3s;
      height: 100vh;
      overflow-y: auto;
    }

    .main-content.expanded {
      margin-left: 70px;
    }

    .header {
      background-color: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      margin-bottom: 0;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--dark-color);
    }

    .header-actions {
      display: flex;
      align-items: center;
    }

    .user-profile {
      display: flex;
      align-items: center;
      margin-left: 20px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }

    /* Dashboard Cards */
    .stats-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
      transition: all 0.3s;
    }

    .stats-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }

    .stats-card .number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 5px;
    }

    .stats-card .label {
      font-size: 0.9rem;
      color: #6c757d;
    }

    .stats-card i {
      font-size: 2.5rem;
      color: var(--primary-color);
      margin-bottom: 15px;
    }
    .toast {
      pointer-events: auto !important;
      cursor: pointer;
    }

    /* Table Styles */
    .table-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      padding: 20px;
      margin-bottom: 20px;
    }

    .table th {
      font-weight: 600;
      border-top: none;
      color: #495057;
      background-color: #f8f9fa;
    }

    /* Form Styles */
    .form-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      padding: 25px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
    }

    /* Toast Styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1055;
    }

    /* Toggle Button */
    .sidebar-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      margin-right: 10px;
    }

    /* Calendar Styles */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 20px;
    }

    .calendar-header {
      background-color: var(--primary-color);
      color: white;
      padding: 10px;
      text-align: center;
      font-weight: 600;
    }

    .calendar-day {
      background-color: white;
      border: 1px solid #eaeaea;
      padding: 10px;
      min-height: 120px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .calendar-day:hover {
      background-color: #f8f9fa;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .calendar-day.today {
      background-color: #e3f2fd;
      border-color: var(--primary-color);
      border-width: 2px;
    }

    .calendar-day.has-booking {
      background-color: #f0f8ff;
      border-color: #b3d9ff;
    }

    .calendar-day.empty {
      background-color: #f8f9fa;
      border-color: #e9ecef;
      cursor: default;
    }

    .calendar-day.empty:hover {
      background-color: #f8f9fa;
      transform: none;
      box-shadow: none;
    }

    .calendar-event {
      font-size: 0.7rem;
      padding: 6px 8px;
      margin: 3px 0;
      border-radius: 6px;
      display: block;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.3);
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .calendar-event:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    /* Badge styling */
    .badge-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      color: white !important;
      border: none;
    }

    .badge-approved {
      background-color: #198754 !important;
      color: white !important;
    }

    .badge-pending {
      background-color: #ffc107 !important;
      color: #212529 !important;
    }

    .badge-rejected,
    .badge-cancelled {
      background-color: #dc3545 !important;
      color: white !important;
    }

    .badge-completed {
      background-color: #0d6efd !important;
      color: white !important;
    }

    .badge-confirmed {
      background-color: #20c997 !important;
      color: white !important;
    }

    /* Promo Badge */
    .promo-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #ff6b6b;
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: bold;
      z-index: 10;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 70px;
      }

      .sidebar .sidebar-text {
        display: none;
      }

      .main-content {
        margin-left: 70px;
      }

      .sidebar.collapsed {
        width: 0;
        overflow: hidden;
      }

      .main-content.expanded {
        margin-left: 0;
      }
    }

    /* Facility Cards */
    .facility-card {
      transition: transform 0.2s;
      border-radius: 10px;
      overflow: hidden;
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      height: 100%;
      position: relative;
    }

    .facility-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    .facility-image {
      height: 200px;
      object-fit: cover;
    }

    /* Event Cards */
    .event-card {
      transition: all 0.3s;
      cursor: pointer;
    }

    .event-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .event-image {
      height: 150px;
      object-fit: cover;
    }

    /* Friend Cards */
    .friend-card {
      border: none;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      background: #fff;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .friend-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    .friend-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .skill-level {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .beginner {
      background-color: #d4edda;
      color: #155724;
    }

    .intermediate {
      background-color: #cce5ff;
      color: #004085;
    }

    .advanced {
      background-color: #fff3cd;
      color: #856404;
    }

    .post-card {
  margin-bottom: 20px;
  box-shadow: 0 0 8px rgba(0,0,0,0.05);
  border-radius: 8px;
  overflow: hidden; /* prevent image overflow */
}

.post-card .carousel-inner {
  max-height: 350px; /* fixed height for all posts */
  overflow: hidden;
}

.post-card .carousel-item img {
  width: 100%;
  max-height: 350px;
  object-fit: cover; /* fill the area without stretching */
}
.post-card .user-info img {
  margin-left: 10px;
  margin-top: 10px;
  width: 40px;
  height: 40px;
  object-fit: cover; /* crop to fit */
  border-radius: 50%; /* circle */
}


    .media {
      width: 100%;
      height: auto;       
      max-height: none;        
      object-fit: contain;
      border-radius: .75rem;
      background: #00000010;
    }
    .post-card img.media {
      width: 100% !important;
      height: auto !important;
      max-height: 350px !important;
      object-fit: contain !important;
    }


    @keyframes fadeSlide {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Booking Steps */
    .booking-step {
      display: none;
    }

    .booking-step.active {
      display: block;
    }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
      position: relative;
    }

    .step-indicator::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background-color: #e9ecef;
      z-index: 1;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-bottom: 0.5rem;
      transition: all 0.3s;
    }

    .step.active .step-number {
      background-color: var(--primary-color);
      color: white;
    }

    .step.completed .step-number {
      background-color: #198754;
      color: white;
    }

    .step-label {
      font-size: 0.85rem;
      font-weight: 500;
    }
    .step:not(.active):not(.completed) {
      opacity: 0.4;
      pointer-events: auto;
    }

#timeSlots {
  gap: 10px;
}

.time-slot {
  padding: 14px;
  min-width: 120px;
  border-radius: 8px;
  border: 2px solid #dee2e6;
  text-align: center;
  font-weight: 600;
  cursor: pointer;
  background-color: #f8f9fa; /* default */
}

/* üü¢ AVAILABLE */
.time-slot.available {
  background-color: #e6f4ea !important;
  border-color: #28a745 !important;
  color: #155724 !important;
}

/* üî¥ BOOKED */
.time-slot.booked {
  background-color: #fdecea !important;
  border-color: #dc3545 !important;
  color: #721c24 !important;
  cursor: not-allowed;
}

/* üîµ SELECTED */
.time-slot.selected {
  background-color: #cce5ff !important;
  border-color: #0d6efd !important;
  color: #084298 !important;
}

    /* Coach Card */
    .coach-card {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }

    .coach-card:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .coach-card.selected {
      border-color: #0d6efd;
      background-color: #f0f8ff;
    }

    /* Snack Card */
    .snack-card {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }

    .snack-card:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Summary Card */
    .summary-card {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .summary-total {
      font-weight: bold;
      font-size: 1.2rem;
      border-top: 1px solid #dee2e6;
      padding-top: 10px;
      margin-top: 10px;
    }

    /* Monthly Calendar */
    .month-calendar {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .calendar-header-month {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background-color: #e9ecef;
      border: 1px solid #e9ecef;
    }

    .calendar-day-month {
      background: white;
      padding: 10px;
      min-height: 100px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .calendar-day-month:hover {
      background-color: #f8f9fa;
    }

    .calendar-day-month.today {
      background-color: #e3f2fd;
    }

    .calendar-day-month.selected {
      background-color: #0d6efd;
      color: white;
    }

    .calendar-day-month.disabled {
      background-color: #f8f9fa;
      color: #6c757d;
      cursor: not-allowed;
    }

    .day-number {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .calendar-events {
      font-size: 0.7rem;
    }

    .calendar-event-small {
      background-color: #4cc9f0;
      color: white;
      padding: 2px 5px;
      border-radius: 3px;
      margin-bottom: 2px;
      font-size: 0.6rem;
    }

    /* Chat Styles */
    .chat-container {
      background-color: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
    }

    .message-text {
      word-wrap: break-word;
    }

    .message-time {
      font-size: 0.75rem;
    }

    .friend-card {
      border: none;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .friend-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    /* Enhanced Chat Styles */
    .chat-modal-content {
      height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      border-radius: 10px 10px 0 0;
    }

    .chat-user-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 12px;
    }

    .chat-user-info h6 {
      font-weight: 600;
    }

    .chat-actions {
      display: flex;
      align-items: center;
    }

    .chat-body {
      flex: 1;
      overflow: hidden;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
    }

    .chat-body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.03"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
      pointer-events: none;
    }

    .chat-messages {
      height: 100%;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
    }

    .chat-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid #e9ecef;
      background: white;
      border-radius: 0 0 10px 10px;
    }

    .chat-input-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .message-input-wrapper {
      flex: 1;
      position: relative;
    }

    .message-input {
      border-radius: 25px;
      padding: 12px 50px 12px 20px;
      border: 1px solid #e0e0e0;
      font-size: 0.9rem;
    }

    .emoji-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      color: #6c757d;
    }

    .chat-action-btn,
    .send-btn {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e0e0e0;
    }

    .send-btn {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }

    .send-btn:hover {
      background: var(--secondary-color);
      border-color: var(--secondary-color);
    }

    /* Message Bubbles */
    .message-container {
      margin-bottom: 1rem;
      display: flex;
      animation: messageSlideIn 0.3s ease-out;
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-container.sent {
      justify-content: flex-end;
    }

    .message-container.received {
      justify-content: flex-start;
    }

    .message-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .message-bubble.sent {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message-bubble.received {
      background: white;
      color: #333;
      border-bottom-left-radius: 4px;
    }

    .message-text {
      margin-bottom: 4px;
      line-height: 1.4;
    }

    .message-time {
      font-size: 0.75rem;
      opacity: 0.8;
      text-align: right;
    }

    .message-bubble.received .message-time {
      text-align: left;
      color: #666;
    }

    .message-status {
      font-size: 0.7rem;
      margin-left: 5px;
    }

    /* Typing Indicator */
    .typing-indicator {
      padding: 8px 0;
      display: flex;
      align-items: center;
    }

    .typing-dots {
      display: inline-flex;
      margin-left: 8px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: #6c757d;
      margin: 0 2px;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) {
      animation-delay: -0.32s;
    }

    .typing-dot:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes typingAnimation {

      0%,
      80%,
      100% {
        transform: scale(0.8);
        opacity: 0.5;
      }

      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Chat Date Separator */
    .chat-date-separator {
      text-align: center;
      margin: 1rem 0;
      position: relative;
    }

    .chat-date-separator::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: rgba(255, 255, 255, 0.2);
    }

    .chat-date-separator span {
      background: rgba(255, 255, 255, 0.1);
      padding: 4px 12px;
      border-radius: 12px;
      color: white;
      font-size: 0.8rem;
      position: relative;
      backdrop-filter: blur(10px);
    }

    /* Scrollbar Styling */
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* Message Reactions */
    .message-reactions {
      display: flex;
      gap: 4px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .reaction {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .reaction:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    /* Online Status Indicator */
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #28a745;
      position: absolute;
      bottom: 2px;
      right: 2px;
      border: 2px solid white;
    }

    .status-offline {
      background: #6c757d;
    }

    /* Marketplace Styles */
    .sold-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #dc3545;
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: bold;
      z-index: 10;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .product-card {
      position: relative;
      transition: transform 0.2s;
      border-radius: 10px;
      overflow: hidden;
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      height: 520px;
      display: flex;
      flex-direction: column;
    }

    /* IMAGE CONTAINER */
    .product-img-wrapper {
      height: 220px;              /* ‚úÖ fixed image area */
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      overflow: hidden;           /* ‚úÖ prevents overflow */
    }

    /* IMAGE */
    .product-img {
      max-height: 100%;
      max-width: 100%;
      object-fit: contain;        /* ‚úÖ no cropping */
    }

    /* TEXT */
    .product-card .card-body {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .product-card .card-text {
      max-height: 3em;
      overflow: hidden;
      font-size: 0.85rem;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    /* Community Post Styles */
    .post-actions {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }

    .post-action-btn {
      background: none;
      border: none;
      color: #6c757d;
      cursor: pointer;
      transition: color 0.2s;
    }

    .post-action-btn:hover {
      color: var(--primary-color);
    }

    .post-action-btn.active {
      color: var(--primary-color);
    }

    .comments-section {
      margin-top: 15px;
      border-top: 1px solid #e9ecef;
      padding-top: 15px;
    }

    .comment {
      padding: 10px 0;
      border-bottom: 1px solid #f8f9fa;
    }

    .comment:last-child {
      border-bottom: none;
    }

    .comment-user {
      font-weight: 600;
      margin-right: 5px;
    }

    .comment-actions {
      display: flex;
      gap: 10px;
      margin-top: 5px;
    }

    .comment-action-btn {
      background: none;
      border: none;
      color: #6c757d;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .comment-action-btn:hover {
      color: var(--primary-color);
    }

    .emoji-picker {
      position: absolute;
      bottom: 50px;
      right: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      padding: 10px;
      z-index: 1000;
      display: none;
    }

    .emoji-picker.show {
      display: block;
    }

    .emoji-option {
      display: inline-block;
      padding: 5px;
      cursor: pointer;
      font-size: 1.2rem;
    }

    .emoji-option:hover {
      background-color: #f8f9fa;
      border-radius: 5px;
    }

    .contact-details {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      font-size: 0.9rem;
    }

    .contact-label {
      font-weight: 600;
      color: #495057;
    }

    /* WhatsApp Button Styles */
    .whatsapp-btn {
      background-color: #25D366 !important;
      border-color: #25D366 !important;
      color: white !important;
      transition: all 0.3s ease;
    }

    .whatsapp-btn:hover {
      background-color: #128C7E !important;
      border-color: #128C7E !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(37, 211, 102, 0.3);
    }

    /* Contact Details Enhancement */
    .contact-details {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
      font-size: 0.9rem;
      border-left: 4px solid #25D366;
    }

    .contact-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 5px;
    }

    .contact-actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    /* Event Card Styles */
    .event-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        height: 100%;
    }

    .event-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
    }

    .event-card .card-img-top {
        height: 200px;
        object-fit: cover;
    }

    .event-card .card-body {
        display: flex;
        flex-direction: column;
    }

    .event-card .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .event-card .card-text {
        flex-grow: 1;
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 1rem;
    }

    .event-card .badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }

    /* Event modal styles */
    #eventDetailsModal .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }

    #eventDetailsModal img {
        max-height: 300px;
        object-fit: cover;
    }

    /* Event filter form */
    #createEventForm input:invalid,
    #createEventForm select:invalid {
        border-color: #dc3545;
    }

    #createEventForm input:valid,
    #createEventForm select:valid {
        border-color: #28a745;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .event-card .card-img-top {
            height: 150px;
        }

        .event-card .card-title {
            font-size: 1rem;
        }
    }
    /* üîç Floating image zoom (outside card) */
    .zoom-wrapper {
      position: relative;
      display: inline-block;
    }

    .zoom-thumb {
      width: 60px;
      height: 60px;
      object-fit: cover;
      cursor: zoom-in;
    }

    /* Hidden big preview */
    .zoom-preview {
      position: absolute;
      top: 0;
      left: 80px; /* appears outside card */
      width: 200px;
      height: 200px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      display: none;
      z-index: 9999;
    }

    .zoom-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 12px;
    }

    /* Show preview on hover */
    .zoom-wrapper:hover .zoom-preview {
      display: block;
    }

    /* Disable hover zoom on touch devices */
    @media (hover: none) {
      .zoom-preview {
        display: none !important;
      }
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      <img src="img/logo.jpg" alt="Sportova Logo" class="sidebar-logo">
      <h5 class="sidebar-title sidebar-text">Sportova User</h5>
    </div>

    <ul class="sidebar-menu">
      <li><a href="#" class="active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> <span
            class="sidebar-text">Dashboard</span></a></li>
      <li><a href="#" data-page="book-facility"><i class="fas fa-calendar-plus"></i> <span class="sidebar-text">Book a
            Court</span></a></li>
      <li><a href="#" data-page="find-friends"><i class="fas fa-users"></i> <span class="sidebar-text">Find
            Friends</span></a></li>
      <li><a href="#" data-page="my-bookings"><i class="fas fa-calendar-check"></i> <span class="sidebar-text">My
            Bookings</span></a></li>
      <li><a href="#" data-page="marketplace"><i class="fas fa-store"></i> <span
            class="sidebar-text">Marketplace</span></a></li>
      <li><a href="#" data-page="community"><i class="fas fa-comments"></i> <span
            class="sidebar-text">Community</span></a></li>
      <li><a href="#" data-page="events"><i class="fas fa-calendar-alt"></i> <span 
            class="sidebar-text">Events</span></a></li>
      <li><a href="#" data-page="profile"><i class="fas fa-user"></i> <span 
            class="sidebar-text">My Profile</span></a>
      </li>
    </ul>

    <div class="sidebar-footer">
      <div class="user-profile mb-3">
        <img src="https://via.placeholder.com/40" alt="User" class="user-avatar" id="userAvatar">
        <div class="sidebar-text">
          <div class="fw-bold" id="userName">User</div>
          <small id="userEmail">user@sportova.com</small>
        </div>
      </div>
      <button class="btn btn-danger btn-sm w-100 mb-2" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> <span class="sidebar-text">Logout</span>
      </button>
      <a href="index.html" class="btn btn-outline-light btn-sm w-100">
        <i class="fas fa-home"></i> <span class="sidebar-text">Back to Homepage</span>
      </a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="header">
      <h1 id="pageTitle">Dashboard</h1>
    </div>

    <!-- Page Content will be loaded here -->
    <div id="pageContent">
      <!-- Dashboard content will be loaded here by default -->
      <div class="row">
        <div class="col-md-3">
          <div class="stats-card">
            <i class="fas fa-calendar-check"></i>
            <div class="number" id="totalBookings">0</div>
            <div class="label">My Bookings</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <i class="fas fa-users"></i>
            <div class="number" id="totalFriends">0</div>
            <div class="label">Friends</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <i class="fas fa-trophy"></i>
            <div class="number" id="loyaltyPoints">0</div>
            <div class="label">Loyalty Points</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <i class="fas fa-calendar-day"></i>
            <div class="number" id="upcomingEvents">0</div>
            <div class="label">Upcoming Events</div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-8">
          <div class="table-card">
            <h4>Recent Bookings</h4>
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Facility</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="recentBookings">
                  <!-- Bookings will be loaded dynamically -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="table-card">
            <h4>Upcoming Events</h4>
            <div class="list-group" id="upcomingEventsList">
              <!-- Events will be loaded dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Enhanced Chat Modal -->
  <div class="modal fade" id="chatModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content chat-modal-content">
        <div class="chat-header">
          <div class="d-flex align-items-center">
            <img src="" alt="" class="chat-user-avatar" id="chatUserAvatar">
            <div class="chat-user-info">
              <h6 class="mb-0" id="chatUserName">User</h6>
              <small class="text-muted" id="chatUserStatus">Online</small>
            </div>
          </div>
          <div class="chat-actions">
            <button class="btn btn-sm btn-outline-secondary me-2" id="callBtn">
              <i class="fas fa-phone"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary me-2" id="videoCallBtn">
              <i class="fas fa-video"></i>
            </button>
            <button id="deleteChatBtn" class="btn btn-sm btn-outline-danger ms-2" title="Clear Chat">
              <i class="fas fa-trash"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" data-bs-dismiss="modal">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <div class="chat-body">
          <div class="chat-messages" id="chatMessages">
            <!-- Messages will be loaded here -->
          </div>
        </div>

        <div class="chat-footer">
          <div class="chat-input-container">
            <button class="btn btn-sm btn-outline-secondary chat-action-btn" id="attachBtn">
              <input type="file" id="chatAttachmentInput" class="d-none" accept="image/*,video/*">
              <i class="fas fa-paperclip"></i>
            </button>
            <!-- Your HTML -->
            <div class="message-input-wrapper">
              <input type="text" class="form-control message-input" id="messageInput" placeholder="Type a message...">
              <button class="btn btn-sm btn-outline-secondary emoji-btn" id="emojiBtn">
                <i class="fas fa-smile"></i>
              </button>
              <div class="emoji-picker" id="emojiPicker">
                <div class="emoji-option" data-emoji="üòÄ">üòÄ</div>
                <div class="emoji-option" data-emoji="üòÇ">üòÇ</div>
                <div class="emoji-option" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</div>
                <div class="emoji-option" data-emoji="üëç">üëç</div>
                <div class="emoji-option" data-emoji="üëè">üëè</div>
                <div class="emoji-option" data-emoji="üéâ">üéâ</div>
                <div class="emoji-option" data-emoji="üî•">üî•</div>
                <div class="emoji-option" data-emoji="‚≠ê">‚≠ê</div>
              </div>
            </div>
            <button class="btn btn-primary send-btn" id="sendMessageBtn">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
          <div class="typing-indicator" id="typingIndicator" style="display: none;">
            <small class="text-muted">
              <i class="fas fa-pencil-alt me-1"></i>
              <span id="typingUserName">User</span> is typing...
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="notificationContainer" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;"></div>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    emailjs.init("xyWs0sJY-xyTCFDAo");
  </script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDjMwv9Bxff1bUE7CR_S-DPx3NV5kkinTU",
      authDomain: "nste-booking-system.firebaseapp.com",
      projectId: "nste-booking-system",
      storageBucket: "nste-booking-system.appspot.com",
      messagingSenderId: "574207536433",
      appId: "1:574207536433:web:0d2aeaacdc280cec019410"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // DOM elements
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const pageTitle = document.getElementById('pageTitle');
    const pageContent = document.getElementById('pageContent');
    const logoutBtn = document.getElementById('logoutBtn');
    const userName = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    const userAvatar = document.getElementById('userAvatar');

    // Global variables
    let userDataLoaded = false;
    let currentPage = localStorage.getItem('currentPage') || 'dashboard';
    let currentUser = null;
    let activeChatListener = null;
    let activeChatId = null;
    let activeReceiverId = null;
    let unsubscribeRealtimeNotifications = null;
    let bookingInProgress = false;
    let maxStepReached = 1;

    // Booking process variables
    let selectedFacility = null;
    let selectedDate = null;
    let selectedTimeSlot = null;
    let selectedCoach = null;
    let selectedSnacks = [];
    let availableCoaches = [];
    let availableSnacks = [];
    let userLoyaltyPoints = 0;
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let selectedFacilityData = null;   // global
    let selectedFileUrl = null;
    let selectedAmenities = [];
    const MALAYSIA_LOCATIONS = {
      "Selangor": ["Petaling", "Hulu Langat", "Gombak", "Klang"],
      "Kuala Lumpur": ["Bukit Bintang", "Cheras", "Setapak"],
      "Johor": ["Johor Bahru", "Batu Pahat", "Muar"],
      "Penang": ["George Town", "Bayan Lepas"],
      "Perak": ["Ipoh", "Taiping"],
      "Negeri Sembilan": ["Seremban"],
      "Melaka": ["Melaka Tengah"]
    };

    // Authentication state observer
    auth.onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        userName.textContent = user.displayName || 'User';
        userEmail.textContent = user.email;

        // Load user data from Firestore
        loadUserData(user.uid).then(() => {
          userDataLoaded = true;
        });

        // Set up beforeunload event for logout confirmation
        window.addEventListener('beforeunload', handleBeforeUnload);
        // Initialize notification system
        startNotificationListener();

        // Add event listener for mark all as read
        document.getElementById('markAllReadBtn')?.addEventListener('click', async (e) => {
          e.preventDefault();
          await markAllNotificationsAsRead(currentUser.uid);
          await loadNotifications();
        });

      } else {
        // Redirect to login page if not authenticated
        window.location.href = 'login.html';
      }
    });

    // Load user data from Firestore
    async function loadUserData(userId) {
      try {
        const userDoc = await db.collection('users').doc(userId).get();
        if (userDoc.exists) {
          const userData = userDoc.data();

          // Store user data for later use
          window.userProfileData = userData;
          userLoyaltyPoints = userData.loyaltyPoints || 0;

          // Update avatar with photoUrl from users collection
          if (userData.photoURL) {
            userAvatar.src = userData.photoURL;
          } else {
            // Use a default avatar based on user's name
            userAvatar.src = generateDefaultAvatar(userData.name || user.email);
          }

          // Always update dashboard stats when loading user data
          await updateDashboardStats(userId);
        } else {
          // Create user document if it doesn't exist
          await initializeUserDocument(userId);
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        showToast('Error loading user data', 'danger');
      }
    }

    // Initialize user document if it doesn't exist
    async function initializeUserDocument(userId) {
      try {
        const userData = {
          name: currentUser.displayName || 'User',
          email: currentUser.email,
          photoUrl: currentUser.photoURL || '',
          phone: '',
          location: '',
          primarySport: 'tennis',
          skillLevel: 'intermediate',
          bio: '',
          loyaltyPoints: 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('users').doc(userId).set(userData);
        window.userProfileData = userData;

        // Update avatar
        if (currentUser.photoURL) {
          userAvatar.src = currentUser.photoURL;
        } else {
          userAvatar.src = generateDefaultAvatar(currentUser.displayName || currentUser.email);
        }

      } catch (error) {
        console.error('Error initializing user document:', error);
      }
    }
    let notificationUnsubscribe = null;
function startNotificationListener() {
  console.log("üîî Notification listener started");

  notificationUnsubscribe = db.collection("notifications")
    .where("userId", "==", currentUser.uid)
    .where("isRead", "==", false)   // ‚úÖ FIXED
    .onSnapshot(snapshot => {

      console.log("üì© Notification snapshot fired");
      console.log("Docs count:", snapshot.size);

      snapshot.docChanges().forEach(change => {
        if (change.type === "added") {
          const notif = change.doc.data();

          showToast(
            `üí¨ ${notif.title}: ${notif.message}`,
            "info"
          );
        }
      });
    });
}
function showIncomingMessageNotification(notification) {
  showToast(
    `üí¨ ${notification.title}: ${notification.message}`,
    "info",
    () => {
      if (notification.data?.chatId) {
        openChat(notification.data.chatId); // üß† mark happens inside openChat
      }
    }
  );
}
async function markNotificationAsRead(chatId) {
  try {
    console.log("üîÑ Marking notifications as read for chat:", chatId);

    const snap = await db.collection("notifications")
      .where("userId", "==", currentUser.uid)
      .where("data.chatId", "==", chatId)
      .where("isRead", "==", false)
      .get();

    if (snap.empty) {
      console.log("‚ÑπÔ∏è No unread notifications found for this chat");
      return;
    }

    const batch = db.batch();
    snap.forEach(doc => {
      batch.update(doc.ref, { isRead: true }); // ‚úÖ CORRECT
    });

    await batch.commit();

    console.log("‚úÖ Notifications marked as read");
    updateNotificationBadge();

  } catch (err) {
    console.error("‚ùå Error marking notification as read:", err);
  }
}
async function updateNotificationBadge() {
  const snap = await db.collection("notifications")
    .where("userId", "==", currentUser.uid)
    .where("isRead", "==", false)
    .get();

  const badge = document.getElementById("notificationCount");
  if (!badge) return;

  if (snap.size > 0) {
    badge.textContent = snap.size;
    badge.style.display = "inline-block";
  } else {
    badge.style.display = "none";
  }
}
    // Generate default avatar based on name (make sure this function exists)
    function generateDefaultAvatar(name) {
      const colors = ['#4361ee', '#3f37c9', '#4cc9f0', '#f9c74f', '#f94144'];
      const color = colors[name.length % colors.length];
      const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);

      return `https://via.placeholder.com/60/${color.replace('#', '')}/ffffff?text=${initials}`;
    }

    // Handle page refresh/close
    function handleBeforeUnload(e) {
      // You can add confirmation here if needed
      sessionStorage.clear();
      localStorage.removeItem('firebase:authUser:AIzaSyDjMwv9Bxff1bUE7CR_S-DPx3NV5kkinTU:[DEFAULT]');
    }

    // Calculate user bookings from bookings collection
    async function calculateUserBookings(userId) {
      try {
        const bookingsSnapshot = await db.collection('bookings')
          .where('userId', '==', userId)
          .get();

        return bookingsSnapshot.size;
      } catch (error) {
        console.error('Error calculating bookings:', error);
        return 0;
      }
    }

    

    // Load page content based on selection
    function loadPageContent(page) {
      let content = '';

      switch (page) {
        case 'dashboard':
          content = loadDashboardPage();
          break;
        case 'book-facility':
          content = loadBookFacilityPage();
          break;
        case 'find-friends':
          content = loadFindFriendsPage();
          break;
        case 'my-bookings':
          content = loadMyBookingsPage();
          break;
        case 'marketplace':
          content = loadMarketplacePage();
          break;
        case 'community':
          content = loadCommunityPage();
          break;
        case 'events':
          content = loadEventsPage();
          break;
        case 'profile':
          content = loadProfilePage();
          break;
        default:
          content = '<div class="alert alert-info">Page under development</div>';
      }

      pageContent.innerHTML = content;

      // Update page title immediately
      updatePageTitle(page);

      // Initialize any page-specific functionality
      initializePageFunctionality(page);
    }

    // Add this function to update page title
    function updatePageTitle(page) {
      const pageTitles = {
        'dashboard': 'Dashboard',
        'book-facility': 'Book a Court',
        'find-friends': 'Find Friends',
        'my-bookings': 'My Bookings',
        'marketplace': 'Marketplace',
        'community': 'Community',
        'events': 'Events',
        'profile': 'My Profile'
      };

      pageTitle.textContent = pageTitles[page] || 'Dashboard';

      // Also update the active menu item
      document.querySelectorAll('.sidebar-menu a').forEach(a => {
        a.classList.remove('active');
        if (a.getAttribute('data-page') === page) {
          a.classList.add('active');
        }
      });
    }

    // Initialize page functionality
    function initializePageFunctionality(page) {
      switch (page) {
        case 'dashboard':
          // Ensure dashboard data is loaded
          if (currentUser && userDataLoaded) {
            setTimeout(() => {
              loadDashboardData();
            }, 100);
          }
          break;
        case 'book-facility':
          initializeBookFacilityPage();
          break;
        case 'events':
          initializeEventsPage();
          break;
        case 'find-friends':
          initializeFindFriendsPage();
          break;
        case 'my-bookings':
          initializeMyBookingsPage();
          break;
        case 'marketplace':
          initializeMarketplacePage();
          break;
        case 'community':
          initializeCommunityPage();
          break;
        case 'events':
          initializeEventsPage();
          break;
        case 'profile':
          initializeProfilePage();
          break;
      }
    }
// Add session management
    function setupSessionManagement() {
      // Check for existing auth state
      auth.onAuthStateChanged((user) => {
        if (user) {
          console.log('User is signed in:', user.email);
        } else {
          console.log('User is signed out');
          // Optional: Redirect to login after a delay if no user found
          setTimeout(() => {
            if (!auth.currentUser) {
              window.location.href = 'login.html';
            }
          }, 2000);
        }
      });

      // Handle browser/tab close
      window.addEventListener('beforeunload', () => {
        // You can add cleanup here, but Firebase handles session persistence
      });
    }

// Helper function to create notifications
async function createNotification(userId, type, title, message, data = {}) {
    try {
        await db.collection('notifications').add({
            userId: userId,
            type: type,
            title: title,
            message: message,
            data: data,
            isRead: false,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (error) {
        console.error('Error creating notification:', error);
    }
}
    // Function to be called when admin approves a booking
    async function onBookingApproved(bookingId, bookingData) {
      try {
        await createNotification(
          bookingData.userId,
          'booking_approved',
          'Booking Approved!',
          `Your booking for ${bookingData.facilityName} on ${bookingData.date.toDate().toLocaleDateString()} at ${bookingData.time} has been approved.`,
          {
            bookingId: bookingId,
            facilityName: bookingData.facilityName,
            date: bookingData.date,
            time: bookingData.time
          }
        );
      } catch (error) {
        console.error('Error creating approval notification:', error);
      }
    }

    // Function to be called when admin rejects a booking
    async function onBookingRejected(bookingId, bookingData) {
      try {
        await createNotification(
          bookingData.userId,
          'booking_rejected',
          'Booking Rejected',
          `Your booking for ${bookingData.facilityName} on ${bookingData.date.toDate().toLocaleDateString()} at ${bookingData.time} has been rejected.`,
          {
            bookingId: bookingId,
            facilityName: bookingData.facilityName,
            date: bookingData.date,
            time: bookingData.time
          }
        );
      } catch (error) {
        console.error('Error creating rejection notification:', error);
      }
    }
    // Call this when the app loads
    setupSessionManagement();
       async function uploadToCloudinary(file) {
  const CLOUD_NAME = "dagqzn57w";  
  const UPLOAD_PRESET = "ml_default";  

  const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`;

  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", UPLOAD_PRESET);

  const res = await fetch(url, {
    method: "POST",
    body: formData
  });

  const data = await res.json();
  return data.secure_url;
}
<!--Dashboard page-->
// Calculate user friends (all other users in the system)
    async function calculateUserFriends(userId) {
      try {
        const usersSnapshot = await db.collection('users').get();
        return Math.max(0, usersSnapshot.size - 1); // Exclude current user
      } catch (error) {
        console.error('Error calculating friends:', error);
        return 0;
      }
    }

    // Fixed version of calculateUpcomingEvents
async function calculateUpcomingEvents() {
  try {
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    let eventsSnapshot;
    let upcomingCount = 0;

    try {
      eventsSnapshot = await db.collection('events')
        .where('startDate', '>=', today)
        .get();
    } catch (error) {
      try {
        eventsSnapshot = await db.collection('tournaments')
          .where('startDate', '>=', today)
          .get();
      } catch (error2) {
        console.log('No events collection found');
        return 0;
      }
    }

    if (eventsSnapshot && !eventsSnapshot.empty) {
      upcomingCount = eventsSnapshot.size;
    }

    return upcomingCount;
  } catch (error) {
    console.error('Error calculating upcoming events:', error);
    return 0;
  }
}

    // Fixed version of loadRecentBookings
async function loadRecentBookings(userId) {
  try {
    const bookingsSnapshot = await db.collection('bookings')
      .where('userId', '==', userId)
      .orderBy('createdAt', 'desc')
      .limit(5)
      .get();

    const bookingsTable = document.getElementById('recentBookings');
    if (!bookingsTable) {
      console.log('Recent bookings table not found in DOM');
      return;
    }

    bookingsTable.innerHTML = '';

    if (bookingsSnapshot.empty) {
      bookingsTable.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No bookings yet. Book your first court!</td></tr>';
      return;
    }

    const bookingsData = [];

    bookingsSnapshot.forEach(doc => {
      const booking = doc.data();
      bookingsData.push({ id: doc.id, ...booking });
    });

    // Render bookings
    bookingsData.forEach(booking => {
      const row = document.createElement('tr');

      // Format date - handle different date formats
      let formattedDate = 'Date not set';
      if (booking.date) {
        try {
           const bookingDate = booking.date.toDate ? booking.date.toDate() : new Date(booking.date);
        formattedDate = bookingDate.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      } catch (error) {
        console.error('Error formatting date:', error);
        formattedDate = 'Invalid date';
      }
      }

      // Get facility name from different possible fields
      const facilityName = booking.facilityName || booking.facility?.name || booking.name || 'Facility';

      // Get time from different possible fields
      const time = booking.time || booking.slot || (booking.slot && booking.slots.length > 0 ? booking.slots[0] : 'Time not set');

      // Create status badge with better error handling
      let statusClass = 'badge-pending';
      let statusText = 'pending';

      if (booking.status) {
        const status = booking.status.toLowerCase();
        if (status === 'confirmed' || status === 'approved') {
          statusClass = 'badge-confirmed';
          statusText = 'confirmed';
        } else if (status === 'completed') {
          statusClass = 'badge-completed';
          statusText = 'completed';
        } else if (status === 'cancelled' || status === 'rejected') {
          statusClass = 'badge-cancelled';
          statusText = 'cancelled';
        } else if (status === 'active') {
          statusClass = 'badge-confirmed';
          statusText = 'active';
        } else {
          statusText = status;
        }
      }

      row.innerHTML = `
        <td>${facilityName}</td>
        <td>${formattedDate}</td>
        <td>${time}</td>
        <td><span class="badge badge-status ${statusClass}">${statusText}</span></td>
      `;

      bookingsTable.appendChild(row);
    });
  } catch (error) {
    console.error('Error loading bookings:', error);
    const bookingsTable = document.getElementById('recentBookings');
    if (bookingsTable) {
      bookingsTable.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Error loading bookings</td></tr>';
    }
  }
}

    // Fixed version of loadUpcomingEvents
async function loadUpcomingEvents() {
  try {
    const today = new Date();
    today.setHours(0, 0, 0, 0); // Start of today
    
    console.log('Loading upcoming events...');
    
    let eventsSnapshot;
    
    // Try to get events from either 'events' or 'tournaments' collection
    try {
      eventsSnapshot = await db.collection('events')
        .where('startDate', '>=', today)
        .orderBy('startDate')
        .limit(3)
        .get();
    } catch (error) {
      console.log('Trying tournaments collection...');
      try {
        eventsSnapshot = await db.collection('tournaments')
          .where('startDate', '>=', today)
          .orderBy('startDate')
          .limit(3)
          .get();
      } catch (error2) {
        console.log('No events or tournaments collection found');
        eventsSnapshot = { empty: true, forEach: () => {} };
      }
    }

    const eventsList = document.getElementById('upcomingEventsList');
    if (!eventsList) {
      console.log('Upcoming events list element not found');
      return;
    }

    eventsList.innerHTML = '';

    if (!eventsSnapshot || eventsSnapshot.empty) {
      eventsList.innerHTML = `
        <div class="text-center p-3 text-muted">
          <i class="fas fa-calendar-times fa-2x mb-2"></i>
          <p class="mb-0">No upcoming events</p>
        </div>
      `;
      return;
    }

    console.log(`Found ${eventsSnapshot.size} upcoming events`);

    eventsSnapshot.forEach(doc => {
      const event = doc.data();
      console.log('Event data:', event);
      
      let eventDate;
      let eventTime = '';
      
      // Handle different date field names and formats
      if (event.startDate) {
        try {
          eventDate = event.startDate.toDate ? event.startDate.toDate() : new Date(event.startDate);
        } catch (error) {
          console.error('Error parsing startDate:', error);
          eventDate = new Date(); // Fallback to current date
        }
      } else if (event.date) {
        try {
          eventDate = event.date.toDate ? event.date.toDate() : new Date(event.date);
        } catch (error) {
          console.error('Error parsing date:', error);
          eventDate = new Date(); // Fallback to current date
        }
      } else {
        eventDate = new Date(); // Fallback if no date field
      }
      
      // Calculate days until event
      const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
      
      // Format time if available
      if (event.time) {
        eventTime = event.time;
      } else if (event.startTime) {
        eventTime = event.startTime;
      }

      const eventItem = document.createElement('a');
      eventItem.href = '#';
      eventItem.className = 'list-group-item list-group-item-action';
      eventItem.style.border = 'none';
      eventItem.style.borderBottom = '1px solid #e9ecef';

      eventItem.innerHTML = `
        <div class="d-flex w-100 justify-content-between align-items-start">
          <div class="flex-grow-1">
            <h6 class="mb-1 text-primary">${event.name || 'Unnamed Event'}</h6>
            <p class="mb-1 small">${event.description ? event.description.substring(0, 60) + '...' : 'No description available'}</p>
            <small class="text-muted">
              <i class="fas fa-calendar-alt me-1"></i>${eventDate.toLocaleDateString()}
              ${eventTime ? ` ‚Ä¢ <i class="fas fa-clock me-1"></i>${eventTime}` : ''}
            </small>
          </div>
          <div class="ms-2 text-end">
            <span class="badge bg-primary rounded-pill">${daysUntil} ${daysUntil === 1 ? 'day' : 'days'}</span>
            ${event.sport ? `<div class="mt-1"><small class="badge bg-secondary">${event.sport}</small></div>` : ''}
          </div>
        </div>
      `;

      // Add click event to view event details
      eventItem.addEventListener('click', (e) => {
        e.preventDefault();
        showEventPreview(event, doc.id);
      });

      eventsList.appendChild(eventItem);
    });

  } catch (error) {
    console.error('Error loading upcoming events:', error);
    const eventsList = document.getElementById('upcomingEventsList');
    if (eventsList) {
      eventsList.innerHTML = `
        <div class="text-center p-3 text-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Error loading events
        </div>
      `;
    }
  }
}

// Helper function to show event preview
function showEventPreview(event, eventId) {
  let eventDate = 'Date not set';
  if (event.startDate) {
    try {
      const dateObj = event.startDate.toDate ? event.startDate.toDate() : new Date(event.startDate);
      eventDate = dateObj.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    } catch (error) {
      console.error('Error formatting date:', error);
    }
  }

  const modalHtml = `
    <div class="modal fade" id="eventPreviewModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">Event Details</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <h6 class="text-primary">${event.name || 'Unnamed Event'}</h6>
            <p class="mb-2"><strong>Date:</strong> ${eventDate}</p>
            ${event.time ? `<p class="mb-2"><strong>Time:</strong> ${event.time}</p>` : ''}
            ${event.sport ? `<p class="mb-2"><strong>Sport:</strong> ${event.sport}</p>` : ''}
            ${event.type ? `<p class="mb-2"><strong>Type:</strong> ${event.type}</p>` : ''}
            <p><strong>Location:</strong> ${locationText}</p>           
            ${event.description ? `<p class="mb-3"><strong>Description:</strong><br>${event.description}</p>` : ''}
            ${event.contactInfo ? `<p class="mb-0"><strong>Contact:</strong> ${event.contactInfo}</p>` : ''}
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="registerForEvent('${eventId}')">Register</button>
          </div>
        </div>
      </div>
    </div>
  `;

  // Remove existing modal if any
  const existingModal = document.getElementById('eventPreviewModal');
  if (existingModal) {
    existingModal.remove();
  }

  // Add modal to page
  document.body.insertAdjacentHTML('beforeend', modalHtml);

  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('eventPreviewModal'));
  modal.show();

  // Remove modal when hidden
  document.getElementById('eventPreviewModal').addEventListener('hidden.bs.modal', function() {
    this.remove();
  });
}

// Function to register for event
async function registerForEvent(eventId) {
  try {
    const eventDoc = await db.collection('events').doc(eventId).get();
    if (!eventDoc.exists) {
      showToast('Event not found', 'danger');
      return;
    }

    const event = eventDoc.data();
    
    // Check if user is already registered
    const participants = event.participants || [];
    if (participants.includes(currentUser.uid)) {
      showToast('You are already registered for this event', 'warning');
      return;
    }

    // Check if event is full
    if (event.maxParticipants && participants.length >= event.maxParticipants) {
      showToast('This event is already full', 'warning');
      return;
    }

    // Add user to participants
    await db.collection('events').doc(eventId).update({
      participants: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showToast('Successfully registered for the event!', 'success');
    
    // Close the modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('eventPreviewModal'));
    modal.hide();

  } catch (error) {
    console.error('Error registering for event:', error);
    showToast('Error registering for event', 'danger');
  }
}

    // Sidebar toggle functionality
    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      mainContent.classList.toggle('expanded');

      // Change icon based on state
      if (sidebar.classList.contains('collapsed')) {
        sidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
      } else {
        sidebarToggle.innerHTML = '<i class="fas fa-times"></i>';
      }
    });

    // Page navigation
    document.querySelectorAll('.sidebar-menu a').forEach(link => {
      link.addEventListener('click', function (e) {
        e.preventDefault();

        // Update active menu item
        document.querySelectorAll('.sidebar-menu a').forEach(a => {
          a.classList.remove('active');
        });
        this.classList.add('active');

        // Get page name from data attribute
        const page = this.getAttribute('data-page');
        currentPage = page;

        // Store current page in localStorage
        localStorage.setItem('currentPage', page);

        // Update page title and content
        updatePageTitle(page);

        // Load page content
        loadPageContent(page);

        // If dashboard, reload the data specifically
        if (page === 'dashboard') {
          if (currentUser) {
            updateDashboardStats(currentUser.uid);
          }
        }
      });
    });

    document.addEventListener('DOMContentLoaded', function () {
  const params = new URLSearchParams(window.location.search);
  const pageFromUrl = params.get('page');

  const pageToLoad =
    pageFromUrl ||
    localStorage.getItem('currentPage') ||
    'dashboard';

  localStorage.setItem('currentPage', pageToLoad);

  updatePageTitle(pageToLoad);
  loadPageContent(pageToLoad); // ‚úÖ THIS is critical
});

    // Logout function
    logoutBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to logout?')) {
        auth.signOut().then(() => {
          showToast('Logged out successfully', 'success');
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 1000);
        }).catch((error) => {
          console.error('Logout error:', error);
          showToast('Error logging out', 'danger');
        });
      }
    });

    // Toast notification function
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');

      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;

      document.getElementById('toastContainer').appendChild(toast);

      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();

      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }

    // Update dashboard stats
    async function updateDashboardStats(userId) {
      try {
        // Calculate values from collections
        const bookingsCount = await calculateUserBookings(userId);
        const friendsCount = await calculateUserFriends(userId);
        const upcomingEventsCount = await calculateUpcomingEvents();
        const userData = window.userProfileData || {};

        // Update dashboard elements if they exist
        const totalBookingsEl = document.getElementById('totalBookings');
        const totalFriendsEl = document.getElementById('totalFriends');
        const loyaltyPointsEl = document.getElementById('loyaltyPoints');
        const upcomingEventsEl = document.getElementById('upcomingEvents');

        if (totalBookingsEl) totalBookingsEl.textContent = bookingsCount;
        if (totalFriendsEl) totalFriendsEl.textContent = friendsCount;
        if (loyaltyPointsEl) loyaltyPointsEl.textContent = userData.loyaltyPoints || 0;
        if (upcomingEventsEl) upcomingEventsEl.textContent = upcomingEventsCount;

        // Load recent bookings
        await loadRecentBookings(userId);

        // Load upcoming events
        await loadUpcomingEvents();
      } catch (error) {
        console.error('Error updating dashboard stats:', error);
        showToast('Error loading dashboard data', 'danger');
      }
    }
// Load dashboard data specifically for dashboard page
    async function loadDashboardData() {
      if (!currentUser) return;

      try {
        await updateDashboardStats(currentUser.uid);
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        showToast('Error loading dashboard data', 'danger');
      }
    }

    // Page content loaders
    function loadDashboardPage() {
      return `
        <div class="row">
          <div class="col-md-3">
            <div class="stats-card">
              <i class="fas fa-calendar-check"></i>
              <div class="number" id="totalBookings">0</div>
              <div class="label">My Bookings</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <i class="fas fa-users"></i>
              <div class="number" id="totalFriends">0</div>
              <div class="label">Friends</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <i class="fas fa-trophy"></i>
              <div class="number" id="loyaltyPoints">0</div>
              <div class="label">Loyalty Points</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <i class="fas fa-calendar-day"></i>
              <div class="number" id="upcomingEvents">0</div>
              <div class="label">Upcoming Events</div>
            </div>
          </div>
        </div>

        <div class="row mt-4">
          <div class="col-md-8">
            <div class="table-card">
              <h4>Recent Bookings</h4>
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Facility</th>
                      <th>Date</th>
                      <th>Time</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="recentBookings">
                    <!-- Bookings will be loaded dynamically -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="table-card">
              <h4>Upcoming Events</h4>
              <div class="list-group" id="upcomingEventsList">
                <!-- Events will be loaded dynamically -->
              </div>
            </div>
          </div>
        </div>
      `;
    }
    //Book Facility page
    function loadBookFacilityPage() {
      return `
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="form-card">
                    <h4>Search Facilities</h4>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">Court Type</label>
                                <select class="form-select" id="sportType">
                                    <option value="all">All Courts</option>
                                    <option value="Tennis Court" selected>Tennis Court</option>
                                    <option value="Badminton Court">Badminton Court</option>
                                    <option value="Basketball Court">Basketball Court</option>
                                    <option value="Volleyball Court">Volleyball Court</option>
                                    <option value="Football Field">Football Field</option>
                                    <option value="Swimming Pool">Swimming Pool</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">Location</label>
                                <div class="input-group">
                                    <select class="form-select" id="bookinglocation">
                                        <option value="" selected>Select or type location</option>
                                        <option value="custom">Type Custom Location...</option>
                                        <!-- Locations will be loaded dynamically from Firestore -->
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">Date</label>
                                <input type="date" 
                                       class="form-control" 
                                       id="bookingDate"
                                       min="${new Date().toISOString().split('T')[0]}">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label class="form-label">Time Slot</label>
                                <select class="form-select" id="bookingTime">
                                    <option value="all">Any Time</option>
                                    <option value="morning">Morning (8AM-12PM)</option>
                                    <option value="afternoon">Afternoon (12PM-5PM)</option>
                                    <option value="evening">Evening (5PM-10PM)</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button class="btn btn-primary w-100 me-2" id="searchFacilitiesBtn">
                                <i class="fas fa-search"></i> Search Facilities
                            </button>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <button class="btn btn-outline-secondary w-100" id="clearFiltersBtn">
                                <i class="fas fa-times"></i> Clear Filters
                            </button>
                        </div>
                    </div>
                    
                    <!-- Custom Location Input (Hidden by default) -->
                    <div class="row mt-2" id="customLocationSection" style="display: none;">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Custom Location</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="customLocationInput"
                                       placeholder="Enter your location...">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row" id="facilitiesList">
          <!-- Facilities will be loaded dynamically -->
        </div>

        <!-- Booking Steps -->
        <div id="bookingSteps" style="display: none;">
          <div class="step-indicator">
            <div class="step active" id="step1">
              <div class="step-number">1</div>
              <div class="step-label">Select Date</div>
            </div>
            <div class="step" id="step2">
              <div class="step-number">2</div>
              <div class="step-label">Select Time</div>
            </div>
            <div class="step" id="step3">
              <div class="step-number">3</div>
              <div class="step-label">Coach</div>
            </div>
            <div class="step" id="step4">
              <div class="step-number">4</div>
              <div class="step-label">Snacks</div>
            </div>
            <div class="step" id="step5">
              <div class="step-number">5</div>
              <div class="step-label">Payment</div>
            </div>
          </div>

          <!-- Step 1: Select Date -->
          <div class="booking-step active" id="step1-content">
            <div class="form-card">
              <h4>Select a Date</h4>
              <div id="bookingCalendar"></div>
              <div class="mt-3 d-flex justify-content-end">
                <button class="btn btn-primary" id="nextToStep2">Next</button>
              </div>
            </div>
          </div>

          <!-- Step 2: Select Time -->
          <div class="booking-step" id="step2-content">
            <div class="form-card">
              <h4>Select a Time Slot</h4>
              <div id="timeSlots" class="d-flex flex-wrap"></div>
              <div class="mt-3 d-flex justify-content-between">
                <button class="btn btn-secondary" id="backToStep1">Back</button>
                <button class="btn btn-primary" id="nextToStep3">Next</button>
              </div>
            </div>
          </div>

          <!-- Step 3: Coach Selection -->
          <div class="booking-step" id="step3-content">
            <div class="form-card">
              <h4>Do you need a coach?</h4>
              <div class="form-check mb-3">
                <input class="form-check-input" type="radio" name="coachNeeded" id="coachYes" value="yes">
                <label class="form-check-label" for="coachYes">
                  Yes, I need a coach
                </label>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="radio" name="coachNeeded" id="coachNo" value="no" checked>
                <label class="form-check-label" for="coachNo">
                  No, I don't need a coach
                </label>
              </div>
              
              <div id="coachSelection" style="display: none;">
                <h5 class="mt-4">Available Coaches</h5>
                <div id="coachesList"></div>
              </div>
              
              <div class="mt-3 d-flex justify-content-between">
                <button class="btn btn-secondary" id="backToStep2">Back</button>
                <button class="btn btn-primary" id="nextToStep4">Next</button>
              </div>
            </div>
          </div>

          <!-- Step 4: Snacks Selection -->
          <div class="booking-step" id="step4-content">
            <div class="form-card">
              <h4>Do you want to order snacks?</h4>
              <div class="form-check mb-3">
                <input class="form-check-input" type="radio" name="snacksNeeded" id="snacksYes" value="yes">
                <label class="form-check-label" for="snacksYes">
                  Yes, I want snacks
                </label>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="radio" name="snacksNeeded" id="snacksNo" value="no" checked>
                <label class="form-check-label" for="snacksNo">
                  No, I don't want snacks
                </label>
              </div>
              
              <div id="snacksSelection" style="display: none;">
                <h5 class="mt-4">Available Snacks</h5>
                <div id="snacksList"></div>
              </div>
              <div id="snacksSelectList">
                <h5 class="mt-4">Amenities</h5>
                <div id="amenitiesSelectList"></div>
              </div>

              <div class="mt-3 d-flex justify-content-between">
                <button class="btn btn-secondary" id="backToStep3">Back</button>
                <button class="btn btn-primary" id="nextToStep5">Next</button>
              </div>
            </div>
          </div>

          <!-- Step 5: Payment -->
          <div class="booking-step" id="step5-content">
            <div class="form-card">
              <h4>Booking Summary & Payment</h4>
              <div class="summary-card mb-4">
                <h5>Booking Details</h5>
                <div class="summary-item">
                  <span>Facility:</span>
                  <span id="summaryFacility">-</span>
                </div>
                <div class="summary-item">
                  <span>Date:</span>
                  <span id="summaryDate">-</span>
                </div>
                <div class="summary-item">
                  <span>Time:</span>
                  <span id="summaryTime">-</span>
                </div>
                <div class="summary-item">
                  <span>Court Fee:</span>
                  <span id="summaryCourtFee">RM 0</span>
                </div>
                <div class="summary-item">
                  <span>Coach:</span>
                  <span id="summaryCoach">-</span>
                </div>
                <div class="summary-item">
                  <span>Snacks:</span>
                  <span id="summarySnacks">-</span>
                </div>
                <div class="summary-item">
                  <span>Amenities:</span>
                  <span id="summaryAmenities">-</span>
                </div>
                <div class="summary-item">
                  <span>Promo Discount:</span>
                  <span id="summaryDiscount">RM 0</span>
                </div>
                <div class="summary-item">
                  <span>Loyalty Points Discount:</span>
                  <span id="summaryLoyaltyDiscount">RM 0</span>
                </div>
                <div class="summary-item">
                  <span>Subtotal:</span>
                  <span id="summarySubtotal">RM 0</span>
                </div>

                <div class="form-check mt-3">
                  <input class="form-check-input" type="checkbox" id="useLoyaltyPoints">
                  <label class="form-check-label" for="useLoyaltyPoints">
                    Use Loyalty Points (You have <span id="availablePoints">0</span> points)
                  </label>
                </div>

                <div class="summary-item summary-total">
                  <span>Total Amount:</span>
                  <span id="summaryTotal">RM 0</span>
                </div>
              </div>

              <!-- Terms and Conditions -->
              <div class="form-card mb-4">
                <h5>Terms & Conditions</h5>
                <div class="terms-content mb-3" id="termsContent" style="max-height: 200px; overflow-y: auto; padding: 15px; background-color: #f8f9fa; border-radius: 5px;">
                  <!-- Terms text will be loaded here -->
                  <p id="termsText">Loading terms and conditions...</p>
                </div>
                <div class="text-center">
                  <a href="#" target="_blank" class="btn btn-outline-secondary btn-sm" id="viewTermsPDF">
                    <i class="fas fa-file-pdf me-1"></i> View Full Terms (PDF)
                  </a>
                </div>

                <div class="form-check mt-3">
                  <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                  <label class="form-check-label" for="agreeTerms">
                    I have read and agree to the Terms and Conditions
                  </label>
                  <div class="invalid-feedback">
                    You must agree to the terms and conditions to proceed.
                  </div>
                </div>
              </div>

              <div class="mt-3 d-flex justify-content-between">
                <button class="btn btn-secondary" id="backToStep4">Back</button>
                <button class="btn btn-success" id="submitBooking">Submit Booking</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

// Load unique locations from Firestore
async function loadLocationsFromFirestore() {
    try {
        const facilitiesSnapshot = await db.collection('facilities').get();
        const locationsSet = new Set();
        
        facilitiesSnapshot.forEach(doc => {
            const facility = doc.data();
            if (facility.location && facility.location.trim() !== '') {
                locationsSet.add(facility.location.trim());
            }
        });
        
        // Convert set to array and sort alphabetically
        const locations = Array.from(locationsSet).sort();
        
        // Get the location dropdown
        const locationDropdown = document.getElementById('bookinglocation');
        
        // Clear existing options except first two
        while (locationDropdown.options.length > 2) {
            locationDropdown.remove(2);
        }
        
        // Add locations from Firestore
        locations.forEach(location => {
            const option = document.createElement('option');
            option.value = location;
            option.textContent = location;
            locationDropdown.appendChild(option);
        });
        
        console.log(`Loaded ${locations.length} locations from Firestore`);
        
    } catch (error) {
        console.error('Error loading locations from Firestore:', error);
        showToast('Error loading locations', 'danger');
    }
}

// Handle location selection
function handleLocationSelection(selectedValue) {
    const customLocationSection = document.getElementById('customLocationSection');
    const customLocationInput = document.getElementById('customLocationInput');
    
    if (selectedValue === 'custom') {
        // Show custom location input
        customLocationSection.style.display = 'block';
        customLocationInput.focus();
        
        // Clear any previous custom location value
        customLocationInput.value = '';
    } else {
        // Hide custom location input
        customLocationSection.style.display = 'none';
        customLocationInput.value = '';
    }
}

// Updated searchFacilities function to handle both dropdown and custom location
async function searchFacilities() {
    const sportType = document.getElementById('sportType').value;
    const locationSelect = document.getElementById('bookinglocation');
    const selectedLocation = locationSelect.value;
    const customLocation = document.getElementById('customLocationInput').value.trim();
    const date = document.getElementById('bookingDate').value;
    const time = document.getElementById('bookingTime').value;
    
    // Determine which location to use
    let location = '';
    if (selectedLocation === 'custom' && customLocation) {
        location = customLocation;
    } else if (selectedLocation && selectedLocation !== 'custom' && selectedLocation !== '') {
        location = selectedLocation;
    }
    
    // Show loading state
    const facilitiesList = document.getElementById('facilitiesList');
    facilitiesList.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
    
    try {
        // Build filters object
        const filters = {};
        
        if (sportType && sportType !== 'all') {
            filters.sportType = sportType;
        }
        
        if (location) {
            filters.location = location;
        }
        
        if (date) {
            filters.date = date;
        }
        
        if (time && time !== 'all') {
            filters.timeSlots = mapTimeFilterToSlots(time);
        }
        
        // Load facilities with filters
        await loadFacilities(filters);
        
        // Show results count
        const facilityCards = document.querySelectorAll('.facility-card');
        if (facilityCards.length > 0) {
            let locationText = location ? ` in ${location}` : '';
            showToast(`Found ${facilityCards.length} facilities${locationText}`, 'success');
        }
        
    } catch (error) {
        console.error('Error searching facilities:', error);
        showToast('Error searching facilities', 'danger');
    }
}

// Updated clearFilters function
function clearFacilityFilters() {
    document.getElementById('sportType').value = 'all';
    document.getElementById('bookinglocation').value = '';
    document.getElementById('bookingDate').value = '';
    document.getElementById('bookingTime').value = 'all';
    document.getElementById('customLocationInput').value = '';
    document.getElementById('customLocationSection').style.display = 'none';
    
    loadFacilities(); // Load all facilities
}
function isDateAvailable(facility, selectedDate) {
  if (!facility.availableDates || !Array.isArray(facility.availableDates)) {
    return false;
  }
  return facility.availableDates.includes(selectedDate);
}
async function getBookedSlotsForFacility(facilityId, dateStr) {
  const snapshot = await db.collection('bookings')
    .where('facilityId', '==', facilityId)
    .where('date', '==', dateStr)
    .where('status', 'in', ['approved', 'confirmed', 'active'])
    .get();

  const bookedSlots = [];
  snapshot.forEach(doc => bookedSlots.push(doc.data().time));
  return bookedSlots;
}
function mapTimeFilterToSlots(timeFilter) {
  const map = {
    morning: ['05:00-06:00', '06:00-07:00', '07:00-08:00'],
    afternoon: ['12:00-13:00', '13:00-14:00', '14:00-15:00'],
    evening: ['17:00-18:00', '18:00-19:00', '19:00-20:00']
  };
  return map[timeFilter] || [];
}
    // Load all facilities with filters
    async function loadFacilities(filters = {}) {
    try {
        let facilitiesQuery = db.collection('facilities');
        
        // Apply filters if provided
        if (filters.sportType && filters.sportType !== 'all') {
            facilitiesQuery = facilitiesQuery.where('type', '==', filters.sportType);
        }
        
        if (filters.location) {
            // Use case-insensitive search for location
            // First get all facilities and filter client-side for better flexibility
            const facilitiesSnapshot = await facilitiesQuery.get();
            const facilitiesList = document.getElementById('facilitiesList');
            facilitiesList.innerHTML = '';

            if (facilitiesSnapshot.empty) {
                facilitiesList.innerHTML = '<div class="col-12 text-center"><div class="alert alert-info">No facilities found matching your criteria.</div></div>';
                return;
            }

            const facilities = [];

for (const doc of facilitiesSnapshot.docs) {
  const facility = {
    id: doc.id,
    ...doc.data()
  };

  /* -------- DATE FILTER -------- */
  if (filters.date) {
    if (!isDateAvailable(facility, filters.date)) {
      continue;
    }
  }

  /* -------- TIME FILTER -------- */
  if (filters.timeSlots && filters.date) {
    const bookedSlots = await getBookedSlotsForFacility(
      facility.id,
      filters.date
    );

    // Only consider slots that exist in the facility
    const validSlots = filters.timeSlots.filter(slot =>
      facility.slots.includes(slot)
    );

    const hasFreeSlot = validSlots.some(
      slot => !bookedSlots.includes(slot)
    );

    if (!hasFreeSlot) continue;
  }

  facilities.push(facility);
}

            if (facilities.length === 0) {
                facilitiesList.innerHTML = `
                    <div class="col-12 text-center">
                        <div class="alert alert-warning">
                            <i class="fas fa-search me-2"></i>
                            No available facilities match your search criteria.
                            ${filters.location ? `<br><small>Trying searching for a different location.</small>` : ''}
                        </div>
                    </div>
                `;
                return;
            }

            renderFacilities(facilities);
            
        } else {
            // No location filter, proceed normally
            const facilitiesSnapshot = await facilitiesQuery.get();
            const facilitiesList = document.getElementById('facilitiesList');
            facilitiesList.innerHTML = '';

            if (facilitiesSnapshot.empty) {
                facilitiesList.innerHTML = '<div class="col-12 text-center"><div class="alert alert-info">No facilities found.</div></div>';
                return;
            }

            const facilities = [];
            
            for (const doc of facilitiesSnapshot.docs) {
  const facility = {
    id: doc.id,
    ...doc.data()
  };

  /* -------- DATE FILTER -------- */
  if (filters.date) {
    if (!isDateAvailable(facility, filters.date)) {
      continue;
    }
  }

  /* -------- TIME FILTER -------- */
  if (filters.timeSlots && filters.date) {
    const bookedSlots = await getBookedSlotsForFacility(
      facility.id,
      filters.date
    );

    // Only consider slots that exist in the facility
    const validSlots = filters.timeSlots.filter(slot =>
      facility.slots.includes(slot)
    );

    const hasFreeSlot = validSlots.some(
      slot => !bookedSlots.includes(slot)
    );

    if (!hasFreeSlot) continue;
  }

  facilities.push(facility);
}
            if (facilities.length === 0) {
                facilitiesList.innerHTML = '<div class="col-12 text-center"><div class="alert alert-warning">No available facilities match your search criteria.</div></div>';
                return;
            }

            renderFacilities(facilities);
        }
        
        // Add event listeners to book buttons
        document.querySelectorAll('.book-facility-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const facilityId = this.getAttribute('data-id');
                startBookingProcess(facilityId);
            });
        });

    } catch (error) {
        console.error('Error loading facilities:', error);
        showToast('Error loading facilities', 'danger');
    }
}

    // Render facilities list
    function renderFacilities(facilities) {
        const facilitiesList = document.getElementById('facilitiesList');

        facilities.forEach(facility => {
            const col = document.createElement('div');
            col.className = 'col-md-4 mb-4';

            const amenitiesHtml = Array.isArray(facility.amenities)
             ? facility.amenities.map(a => `
                 <span class="badge bg-secondary me-1 mb-1">
                   ${a.amenity}
                   ${a.amenityPrice && a.amenityPrice !== "0" ? `(RM${a.amenityPrice})` : ''}
                 </span>
               `).join('')
             : '';

            // Add promo badge if promo exists
            const promoBadge = facility.promo ? `<div class="promo-badge">${facility.promo}</div>` : '';

            // Get availability status
            const availabilityStatus = getAvailabilityStatus(facility);
            const statusBadge = `<span class="badge ${availabilityStatus.class} float-end">${availabilityStatus.text}</span>`;

            col.innerHTML = `
                <div class="facility-card card h-100">
                    ${promoBadge}
                    <img src="${facility.imageUrl || 'https://via.placeholder.com/300x200'}" 
                         class="card-img-top facility-image" alt="${facility.name}"
                         style="height: 200px; object-fit: cover;"
                         onerror="this.src='https://via.placeholder.com/300x200'">
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title">
                            ${facility.name}
                            ${statusBadge}
                        </h5>
                        <p class="card-text flex-grow-1">${facility.description || 'No description available'}</p>
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt"></i> ${facility.location || 'Location not specified'}
                            </small>
                            <br>
                            <small class="text-muted">
                                <i class="fas fa-basketball-ball"></i> ${facility.sportType || 'Various sports'}
                            </small>
                        </div>
                        <div class="mb-2">
                            ${amenitiesHtml}
                        </div>
                        <div class="mt-auto">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-primary">RM${facility.price || '0'}/hour</span>
                                <button class="btn btn-sm btn-outline-primary book-facility-btn" data-id="${facility.id}">
                                    Book Now
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
              
            facilitiesList.appendChild(col);
        });
    }
function renderAmenitiesForSelection(amenities) {
  const container = document.getElementById("amenitiesSelectList");
  if (!container) return;

  container.innerHTML = amenities.map((a, index) => `
    <div class="snack-card amenity-card"
         onclick="toggleAmenity(${index})"
         id="amenity-${index}">
      
      <div class="d-flex align-items-center">
        <div class="zoom-wrapper me-3" onclick="event.stopPropagation()">
          <img 
            src="${a.amenityImage}"
            class="zoom-thumb"
            style="width:50px;height:50px;object-fit:contain;border-radius:8px"
          >
          <div class="zoom-preview">
            <img src="${a.amenityImage}">
          </div>
        </div>

        <div class="flex-grow-1">
          <h6 class="mb-1">${a.amenity}</h6>
          <small class="text-muted">
            ${a.amenityPrice && a.amenityPrice !== "0"
              ? `RM${a.amenityPrice}`
              : 'Free'}
          </small>
        </div>

        <i class="fas fa-check-circle text-success d-none"></i>
      </div>
    </div>
  `).join("");
}
function toggleAmenity(index) {
  const amenity = window.facilityAmenities[index];
  const card = document.getElementById(`amenity-${index}`);
  const icon = card.querySelector("i");

  const exists = selectedAmenities.find(a => a.amenity === amenity.amenity);

  if (exists) {
    // REMOVE
    selectedAmenities = selectedAmenities.filter(
      a => a.amenity !== amenity.amenity
    );
    card.classList.remove("selected");
    icon.classList.add("d-none");
  } else {
    // ADD
    selectedAmenities.push(amenity);
    card.classList.add("selected");
    icon.classList.remove("d-none");
  }

  updateBookingSummary();
}

    // Search facilities based on filters
    async function searchFacilities() {
        const sportType = document.getElementById('sportType').value;
        const location = document.getElementById('bookinglocation').value.trim();
        const date = document.getElementById('bookingDate').value;
        const time = document.getElementById('bookingTime').value;

        // Show loading state
        const facilitiesList = document.getElementById('facilitiesList');
        facilitiesList.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

        try {
            // Build filters object
            const filters = {};

            if (sportType && sportType !== 'all') {
                filters.sportType = sportType;
            }

            if (location) {
                filters.location = location;
            }

            if (date) {
                filters.date = date;
            }

            if (time && time !== 'all') {
              filters.timeSlots = mapTimeFilterToSlots(time);
            }

            // Load facilities with filters
            await loadFacilities(filters);

            // Show results count
            const facilityCards = document.querySelectorAll('.facility-card');
            if (facilityCards.length > 0) {
                showToast(`Found ${facilityCards.length} facilities matching your criteria`, 'success');
            }

        } catch (error) {
            console.error('Error searching facilities:', error);
            showToast('Error searching facilities', 'danger');
        }
    }

    // Helper function to check facility availability on a specific date
    function isFacilityAvailableOnDate(facility, date) {
        // If facility has openingHours, check if it's open on that day
        if (facility.openingHours) {
            const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const dayName = dayNames[dayOfWeek];

            if (facility.openingHours[dayName] && facility.openingHours[dayName].isOpen) {
                return true;
            }
            return false;
        }

        // If no opening hours specified, assume always available
        return true;
    }

    // Helper function to check facility availability at a specific time
    function isFacilityAvailableAtTime(facility, timeSlot) {
        if (!facility.availableSlots || facility.availableSlots.length === 0) {
            return true; // If no slots specified, assume always available
        }

        // Check if time slot is in available slots
        const timeSlots = {
            'morning': ['08:00', '09:00', '10:00', '11:00'],
            'afternoon': ['12:00', '13:00', '14:00', '15:00', '16:00'],
            'evening': ['17:00', '18:00', '19:00', '20:00', '21:00']
        };

        const slotsToCheck = timeSlots[timeSlot] || [timeSlot];

        // Check if any of the slots are available
        return slotsToCheck.some(slot => 
            facility.availableSlots.includes(slot) || 
            facility.slots && facility.slots.includes(slot)
        );
    }

    // Get availability status text and class
    function getAvailabilityStatus(facility) {
        const today = new Date();
        const isTodayAvailable = isFacilityAvailableOnDate(facility, today);

        if (!isTodayAvailable) {
            return { text: 'Closed Today', class: 'bg-danger' };
        }

        // Check if facility is fully booked today
        const currentHour = today.getHours();
        if (currentHour >= 22 || currentHour < 6) {
            return { text: 'Opens Tomorrow', class: 'bg-warning' };
        }

        return { text: 'Available', class: 'bg-success' };
    }

    // Add this function to clear filters
    function clearFacilityFilters() {
        document.getElementById('sportType').value = 'tennis';
        document.getElementById('bookinglocation').value = '';
        document.getElementById('bookingDate').value = '';
        document.getElementById('bookingTime').value = 'morning';
        loadFacilities(); // Load all facilities
    }

    // Add a clear filters button to your HTML in the search form
    // Add this line after the search button in your HTML:
    // <button class="btn btn-outline-secondary w-100 mt-2" id="clearFiltersBtn">Clear Filters</button>

    // Start the booking process
    async function startBookingProcess(facilityId) {
      bookingInProgress = true;
      try {
        const facilityDoc = await db.collection('facilities').doc(facilityId).get();
        if (!facilityDoc.exists) {
          showToast('Facility not found', 'danger');
          return;
        }

        selectedFacility = {
          id: facilityId,
          ...facilityDoc.data()
        };
        selectedFacilityData = facilityDoc.data(); // store globally

        // Show booking steps and hide facilities list
        document.getElementById('facilitiesList').style.display = 'none';
        document.getElementById('bookingSteps').style.display = 'block';
        setTimeout(() => {
          initializeStepClicks();
        }, 0);

        // Initialize step 1: Calendar
        initializeMonthlyCalendar();

        // Load available coaches for this facility
        await loadAvailableCoachesForFacility(facilityId);

        // Load available snacks from facility data
        loadAvailableSnacksFromFacility();

        // Load amenities from facility data
        loadAmenitiesFromFacility(selectedFacility.id);

        // Load terms from facility data
        loadTermsFromFacility();

        // Update loyalty points display
        document.getElementById('availablePoints').textContent = userLoyaltyPoints;

      } catch (error) {
        console.error('Error starting booking process:', error);
        showToast('Error starting booking process', 'danger');
      }
    }

    // Load available snacks from facility's foods array
    function loadAvailableSnacksFromFacility() {
      try {
        const snacksListEl = document.getElementById('snacksList');
        snacksListEl.innerHTML = '';
      
        // Check if facility has foods array
        if (!selectedFacility.foods || !Array.isArray(selectedFacility.foods) || selectedFacility.foods.length === 0) {
          snacksListEl.innerHTML = `
            <div class="alert alert-info">
              <i class="fas fa-info-circle me-2"></i>
              No snacks available at this facility.
            </div>
          `;
          return;
        }
      
        // Use the foods array from facility data
        availableSnacks = selectedFacility.foods.map((food, index) => ({
          id: `snack-${index}`,
          name: food.name || 'Snack',
          price: parseFloat(food.price) || 0,
          description: '',
          image: food.image || ''
        }));
      
        // Populate snacks list
        availableSnacks.forEach(snack => {
          const snackCard = document.createElement('div');
          snackCard.className = 'snack-card';

          // Add image if available (with hover zoom preview)
          const imageHtml = snack.image ? 
            `
            <div class="zoom-wrapper">
              <img 
                src="${snack.image}" 
                class="rounded mb-2 zoom-thumb" 
                alt="${snack.name}"
              >
              <div class="zoom-preview">
                <img src="${snack.image}" alt="${snack.name}">
              </div>
            </div>
            ` 
            : '';

          snackCard.innerHTML = `
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="snack-${snack.id}" value="${snack.id}">
              <label class="form-check-label w-100" for="snack-${snack.id}">
                <div class="d-flex align-items-start">
                  ${imageHtml}
                  <div class="flex-grow-1 ms-2">
                    <div class="d-flex justify-content-between align-items-start">
                      <div>
                        <span class="fw-bold">${snack.name}</span>
                        <p class="mb-0 small text-muted">${snack.description || ''}</p>
                      </div>
                      <span class="badge bg-primary">RM${snack.price.toFixed(2)}</span>
                    </div>
                  </div>
                </div>
              </label>
            </div>
          `;
          snacksListEl.appendChild(snackCard);
        });
      
        // Add event listeners to snack selection
        document.querySelectorAll('input[type="checkbox"][id^="snack-"]').forEach(checkbox => {
          checkbox.addEventListener('change', function () {
            const snackId = this.value;
            const snack = availableSnacks.find(s => s.id === snackId);
          
            if (this.checked) {
              selectedSnacks.push(snack);
            } else {
              selectedSnacks = selectedSnacks.filter(s => s.id !== snackId);
            }
            updateBookingSummary();
          });
        });
      
      } catch (error) {
        console.error('Error loading snacks from facility:', error);
        showToast('Error loading snacks', 'danger');
        availableSnacks = [];
      }
    }
    async function loadAmenitiesFromFacility(facilityId) {
  try {
    const snap = await db.collection("facilities").doc(facilityId).get();

    if (!snap.exists) {
      window.facilityAmenities = [];
      renderAmenitiesForSelection([]);
      return;
    }

    const data = snap.data();
    window.facilityAmenities = data.amenities || [];

    console.log("Amenities loaded:", window.facilityAmenities);

    renderAmenitiesForSelection(window.facilityAmenities);

  } catch (err) {
    console.error("Amenity fetch error:", err);
    window.facilityAmenities = [];
    renderAmenitiesForSelection([]);
  }
}
function calculateAmenitiesTotal() {
  return selectedAmenities.reduce(
    (total, a) => total + Number(a.amenityPrice || 0),
    0
  );
}

    // Load terms and conditions from facility data
    function loadTermsFromFacility() {
      try {
        // Store terms for later use
        window.facilityTerms = {
          termsPDF: selectedFacility.termsPDF || '',
          termsText: selectedFacility.termsText || ''
        };
      } catch (error) {
        console.error('Error loading terms:', error);
        window.facilityTerms = {};
      }
    }

    function initializeMonthlyCalendar() {
  const calendarEl = document.getElementById('bookingCalendar');
  calendarEl.innerHTML = '';

  const monthCalendar = document.createElement('div');
  monthCalendar.className = 'month-calendar';

  const calendarHeader = document.createElement('div');
  calendarHeader.className = 'calendar-header-month';

  const monthNames = ["January", "February", "March", "April", "May", "June",
    "July", "August", "September", "October", "November", "December"];

  const prevButton = document.createElement('button');
  prevButton.className = 'btn btn-outline-primary';
  prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
  prevButton.addEventListener('click', () => {
    currentMonth--;
    if (currentMonth < 0) {
      currentMonth = 11;
      currentYear--;
    }
    initializeMonthlyCalendar();
  });

  const nextButton = document.createElement('button');
  nextButton.className = 'btn btn-outline-primary';
  nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
  nextButton.addEventListener('click', () => {
    currentMonth++;
    if (currentMonth > 11) {
      currentMonth = 0;
      currentYear++;
    }
    initializeMonthlyCalendar();
  });

  const monthTitle = document.createElement('h5');
  monthTitle.textContent = `${monthNames[currentMonth]} ${currentYear}`;
  monthTitle.className = 'mb-0';

  calendarHeader.appendChild(prevButton);
  calendarHeader.appendChild(monthTitle);
  calendarHeader.appendChild(nextButton);
  monthCalendar.appendChild(calendarHeader);

  const calendarGrid = document.createElement('div');
  calendarGrid.className = 'calendar-grid';

  const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  dayHeaders.forEach(day => {
    const dayHeader = document.createElement('div');
    dayHeader.className = 'calendar-header';
    dayHeader.textContent = day;
    calendarGrid.appendChild(dayHeader);
  });

  const firstDay = new Date(currentYear, currentMonth, 1);
  const lastDay = new Date(currentYear, currentMonth + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startingDay = firstDay.getDay();

  for (let i = 0; i < startingDay; i++) {
    const emptyCell = document.createElement('div');
    emptyCell.className = 'calendar-day-month disabled';
    calendarGrid.appendChild(emptyCell);
  }

  const today = new Date();
  
  for (let day = 1; day <= daysInMonth; day++) {
    const dayCell = document.createElement('div');
    dayCell.className = 'calendar-day-month';

    const currentDate = new Date(currentYear, currentMonth, day);
    const formattedDate = currentDate.toISOString().split("T")[0];

    // Disable past dates OR dates NOT in Firestore
    if (currentDate < today || 
        !selectedFacilityData.availableDates.includes(formattedDate)) {
      dayCell.classList.add('disabled');
    } else {
      dayCell.addEventListener('click', () => selectDate(currentDate, dayCell));
    }

    if (currentDate.toDateString() === today.toDateString()) {
      dayCell.classList.add('today');
    }

    const dayNumber = document.createElement('div');
    dayNumber.className = 'day-number';
    dayNumber.textContent = day;
    dayCell.appendChild(dayNumber);

    const eventsContainer = document.createElement('div');
    eventsContainer.className = 'calendar-events';

    // Show AVAILABLE indicator
    if (selectedFacilityData.availableDates.includes(formattedDate)) {
      const availableIndicator = document.createElement('div');
      availableIndicator.className = 'calendar-event-small';
      availableIndicator.textContent = 'Available';
      eventsContainer.appendChild(availableIndicator);
    }

    dayCell.appendChild(eventsContainer);
    calendarGrid.appendChild(dayCell);
  }

  monthCalendar.appendChild(calendarGrid);
  calendarEl.appendChild(monthCalendar);
}

    // Select a date for booking
    function selectDate(date, element) {
      selectedDate = date;

      // Remove selected class from all days
      document.querySelectorAll('.calendar-day-month').forEach(day => {
        day.classList.remove('selected');
      });

      // Add selected class to clicked day
      element.classList.add('selected');

      // Enable next button
      document.getElementById('nextToStep2').disabled = false;
    }

    // Load available coaches for specific facility
    async function loadAvailableCoachesForFacility(facilityId) {
      try {
        const coachesSnapshot = await db.collection('coaches')
          .where('facilities', 'array-contains', facilityId)
          .where('availableForHire', '==', true)
          .get();

        availableCoaches = [];
        coachesSnapshot.forEach(doc => {
          availableCoaches.push({
            id: doc.id,
            ...doc.data()
          });
        });

        // Populate coaches list
        const coachesListEl = document.getElementById('coachesList');
        coachesListEl.innerHTML = '';

        if (availableCoaches.length === 0) {
          coachesListEl.innerHTML = '<p>No coaches available for this facility.</p>';
          return;
        }

        availableCoaches.forEach(coach => {
          const coachCard = document.createElement('div');
          coachCard.className = 'coach-card';
          coachCard.innerHTML = `
            <div class="form-check">
              <input class="form-check-input" type="radio" name="coachSelection" id="coach-${coach.id}" value="${coach.id}">
              <label class="form-check-label w-100" for="coach-${coach.id}">
                <div class="d-flex align-items-center">
                  <div class="zoom-wrapper me-3">
                    <img 
                      src="${coach.photoURL || 'https://via.placeholder.com/60'}"
                      class="rounded-circle zoom-thumb"
                      alt="${coach.name}"
                    >
                    <div class="zoom-preview">
                      <img src="${coach.photoURL || 'https://via.placeholder.com/60'}" alt="${coach.name}">
                    </div>
                  </div>
                  <div>
                    <h6 class="mb-1">${coach.name}</h6>
                    <p class="mb-1">Experience: ${coach.experience} years</p>
                    <p class="mb-1">Rate: RM${coach.rate}/hour</p>
                    <p class="mb-0">${coach.specialties ? coach.specialties.join(', ') : ''}</p>
                  </div>
                </div>
              </label>
            </div>
          `;
          coachesListEl.appendChild(coachCard);
        });

        // Add event listeners to coach selection
        document.querySelectorAll('input[name="coachSelection"]').forEach(radio => {
          radio.addEventListener('change', function () {
            if (this.checked) {
              selectedCoach = availableCoaches.find(coach => coach.id === this.value);
            }
          });
        });

      } catch (error) {
        console.error('Error loading coaches:', error);
        showToast('Error loading coaches', 'danger');
      }
    }

    // Load available snacks
    async function loadAvailableSnacks() {
      try {
        // In a real app, you would fetch from a snacks collection
        // For now, we'll use mock data
        availableSnacks = [
          { id: '1', name: 'Energy Bar', price: 5 },
          { id: '2', name: 'Protein Shake', price: 8 },
          { id: '3', name: 'Banana', price: 2 },
          { id: '4', name: 'Sports Drink', price: 4 },
          { id: '5', name: 'Trail Mix', price: 6 }
        ];

        // Populate snacks list
        const snacksListEl = document.getElementById('snacksList');
        snacksListEl.innerHTML = '';

        availableSnacks.forEach(snack => {
          const snackCard = document.createElement('div');
          snackCard.className = 'snack-card';
          snackCard.innerHTML = `
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="snack-${snack.id}" value="${snack.id}">
              <label class="form-check-label w-100" for="snack-${snack.id}">
                <div class="d-flex justify-content-between align-items-center">
                  <span>${snack.name}</span>
                  <span>RM${snack.price}</span>
                </div>
              </label>
            </div>
          `;
          snacksListEl.appendChild(snackCard);
        });

        // Add event listeners to snack selection
        document.querySelectorAll('input[type="checkbox"][id^="snack-"]').forEach(checkbox => {
          checkbox.addEventListener('change', function () {
            const snackId = this.value;
            const snack = availableSnacks.find(s => s.id === snackId);

            if (this.checked) {
              selectedSnacks.push(snack);
            } else {
              selectedSnacks = selectedSnacks.filter(s => s.id !== snackId);
            }
          });
        });

      } catch (error) {
        console.error('Error loading snacks:', error);
        showToast('Error loading snacks', 'danger');
      }
    }

    // Initialize step navigation
    document.addEventListener('click', function (e) {
      // Step 1 to Step 2
      if (e.target && e.target.id === 'nextToStep2') {
        if (!selectedDate) {
          showToast('Please select a date', 'warning');
          return;
        }

        goToStep(2);
        initializeTimeSlots();
      }

      // Step 2 to Step 1
      if (e.target && e.target.id === 'backToStep1') {
        goToStep(1);
      }

      // Step 2 to Step 3
      if (e.target && e.target.id === 'nextToStep3') {
        if (!selectedTimeSlot) {
          showToast('Please select a time slot', 'warning');
          return;
        }

        goToStep(3);
      }

      // Step 3 to Step 2
      if (e.target && e.target.id === 'backToStep2') {
        goToStep(2);
      }

      // Step 3 to Step 4
      if (e.target && e.target.id === 'nextToStep4') {
        goToStep(4);
      }

      // Step 4 to Step 3
      if (e.target && e.target.id === 'backToStep3') {
        goToStep(3);
      }

      // Step 4 to Step 5
      if (e.target && e.target.id === 'nextToStep5') {
        goToStep(5);
        updateBookingSummary();
      }

      // Step 5 to Step 4
      if (e.target && e.target.id === 'backToStep4') {
        goToStep(4);
      }

      // Submit booking
      if (e.target && e.target.id === 'submitBooking') {
        submitBooking();
      }
    });

    // Toggle coach selection based on radio button
    document.addEventListener('change', function (e) {
      if (e.target && e.target.name === 'coachNeeded') {
        const coachSelectionEl = document.getElementById('coachSelection');
        if (e.target.value === 'yes') {
          coachSelectionEl.style.display = 'block';
        } else {
          coachSelectionEl.style.display = 'none';
          selectedCoach = null;
        }
      }

      if (e.target && e.target.name === 'snacksNeeded') {
        const snacksSelectionEl = document.getElementById('snacksSelection');
        if (e.target.value === 'yes') {
          snacksSelectionEl.style.display = 'block';
        } else {
          snacksSelectionEl.style.display = 'none';
          selectedSnacks = [];
        }
      }

      // Update summary when loyalty points checkbox changes
      if (e.target && e.target.id === 'useLoyaltyPoints') {
        updateBookingSummary();
      }
    });

    // Navigate to a specific step
    function goToStep(stepNumber) {

      if (!canProceedToStep(stepNumber)) {
        showToast("Please complete the previous step first", "warning");
        return;
      }
    
      if (stepNumber > maxStepReached + 1) {
        showToast("Please complete previous steps first", "warning");
        return;
      }
    
      document.querySelectorAll('.booking-step').forEach(step => {
        step.classList.remove('active');
      });
    
      document.getElementById(`step${stepNumber}-content`).classList.add('active');
    
      document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active', 'completed');
      });
    
      for (let i = 1; i <= stepNumber; i++) {
        document.getElementById(`step${i}`).classList.add(
          i < stepNumber ? 'completed' : 'active'
        );
      }
    
      maxStepReached = Math.max(maxStepReached, stepNumber);
    }
    function canProceedToStep(stepNumber) {
      if (stepNumber >= 2 && !selectedDate) return false;
      if (stepNumber >= 3 && !selectedTimeSlot) return false;
      return true;
    }
    function initializeStepClicks() {
      document.querySelectorAll('.step').forEach((stepEl, index) => {
        stepEl.style.cursor = 'pointer';
      
        stepEl.onclick = () => {
          const stepNumber = index + 1;
        
          if (stepNumber <= maxStepReached) {
            goToStep(stepNumber);
          } else {
            showToast("Please complete the current step first", "warning");
          }
        };
      });
    }

    async function initializeTimeSlots() {
  const timeSlotsEl = document.getElementById('timeSlots');
  timeSlotsEl.innerHTML = '';

  const availableSlots = selectedFacility.slots || [];

  const bookedSlots = await getBookedSlots(); // already normalized

  availableSlots.forEach(slot => {
    const slotEl = document.createElement('div');
    slotEl.className = 'time-slot';
    slotEl.textContent = slot;

    // üîë normalize facility slot BEFORE comparison
    const normalizedSlot = slot.replace(/\s+/g, '').toLowerCase();

    if (bookedSlots.includes(normalizedSlot)) {
      // üî¥ BOOKED SLOT
      slotEl.classList.add('booked');
      slotEl.innerHTML += `<small class="d-block text-danger">Booked</small>`;
      slotEl.style.pointerEvents = 'none';
    } else {
      // üü¢ AVAILABLE SLOT
      slotEl.classList.add('available');
      slotEl.addEventListener('click', () => selectTimeSlot(slot, slotEl));
    }

    timeSlotsEl.appendChild(slotEl);
  });
}
    async function getBookedSlots() {
  try {
    const startOfDay = new Date(
      selectedDate.getFullYear(),
      selectedDate.getMonth(),
      selectedDate.getDate(),
      0, 0, 0
    );

    const endOfDay = new Date(
      selectedDate.getFullYear(),
      selectedDate.getMonth(),
      selectedDate.getDate(),
      23, 59, 59
    );

    const bookingsSnapshot = await db.collection('bookings')
      .where('facilityId', '==', selectedFacility.id)
      .where('date', '>=', startOfDay)
      .where('date', '<=', endOfDay)
      .where('status', 'in', ['approved', 'confirmed', 'active'])
      .get();

    const bookedSlots = [];

    bookingsSnapshot.forEach(doc => {
      bookedSlots.push(doc.data().time);
    });

    console.log("‚úÖ Booked slots found:", bookedSlots);
    return bookedSlots;

  } catch (error) {
    console.error('Error getting booked slots:', error);
    return [];
  }
}

    // Select a time slot
    function selectTimeSlot(slot, element) {
      selectedTimeSlot = slot;

      // Remove selected class from all slots
      document.querySelectorAll('.time-slot').forEach(slotEl => {
        slotEl.classList.remove('selected');
      });

      // Add selected class to clicked slot
      element.classList.add('selected');
    }
    // Update amenities display in summary
    function updateAmenitiesDisplay() {
      //const amenitiesContainer = document.getElementById('summaryAmenities');
      amenitiesContainer.innerHTML = '';

      if (window.facilityAmenities && window.facilityAmenities.length > 0) {
        window.facilityAmenities.forEach(amenity => {
          const badge = document.createElement('span');
          badge.className = 'badge bg-secondary me-2 mb-2';
          badge.textContent = amenity;
          amenitiesContainer.appendChild(badge);
        });
      } else {
        amenitiesContainer.innerHTML = '<p class="text-muted">No amenities listed</p>';
      }
    }

    // Update terms display in summary
    function updateTermsDisplay() {
      const termsTextEl = document.getElementById('termsText');
      const viewTermsPDFBtn = document.getElementById('viewTermsPDF');

      if (window.facilityTerms.termsText) {
        termsTextEl.textContent = window.facilityTerms.termsText;
      } else {
        termsTextEl.textContent = 'Please review the full terms and conditions document.';
      }

      if (window.facilityTerms.termsPDF) {
        viewTermsPDFBtn.href = window.facilityTerms.termsPDF;
        viewTermsPDFBtn.style.display = 'inline-block';
      } else {
        viewTermsPDFBtn.style.display = 'none';
      }
    }
    // Update booking summary
    function updateBookingSummary() {
      // Calculate costs
      const courtFee = selectedFacility.price || 0;
      const coachFee = selectedCoach ? selectedCoach.rate : 0;
      const snacksFee = selectedSnacks.reduce((total, snack) => total + (snack.price || 0), 0);

      const amenitiesEl = document.getElementById("summaryAmenities");
          if (selectedAmenities.length === 0) {
        amenitiesEl.innerHTML = `<span class="text-muted">No amenities selected</span>`;
      } else {
        amenitiesEl.innerHTML = selectedAmenities.map(a => `
          <div class="d-flex justify-content-between">
            <span>${a.amenity} : </span>
            <span>RM ${Number(a.amenityPrice || 0).toFixed(2)}</span>
          </div>
        `).join("");
      }
    
      // ‚úÖ include amenities in total
      const amenitiesTotal = calculateAmenitiesTotal();
    
      // Calculate promo discount (10% for NEWUSER10)
      let discount = 0;
      if (selectedFacility.promo === 'NEWUSER10') {
        discount = courtFee * 0.1;
      }
    
      // Calculate subtotal before loyalty points
      const subtotalBeforeLoyalty = courtFee + coachFee + snacksFee + amenitiesTotal - discount;
    
      // Calculate loyalty points discount (1 point = RM0.10)
      let loyaltyDiscount = 0;
      const useLoyaltyPoints = document.getElementById('useLoyaltyPoints').checked;
      if (useLoyaltyPoints) {
        loyaltyDiscount = Math.min(userLoyaltyPoints * 0.1, subtotalBeforeLoyalty);
      }
    
      // Calculate final total
      const total = subtotalBeforeLoyalty - loyaltyDiscount;
    
      // Update summary display
      document.getElementById('summaryFacility').textContent = selectedFacility.name;
      document.getElementById('summaryDate').textContent = selectedDate.toLocaleDateString();
      document.getElementById('summaryTime').textContent = selectedTimeSlot;
      document.getElementById('summaryCourtFee').textContent = `RM ${courtFee}`;
      document.getElementById('summaryCoach').textContent = selectedCoach ? `${selectedCoach.name} (RM${coachFee})` : 'No coach';
      
      // Update snacks summary
      if (selectedSnacks.length > 0) {
        const snacksList = selectedSnacks.map(s => `${s.name} (RM${s.price})`).join(', ');
        document.getElementById('summarySnacks').textContent = snacksList;
      } else {
        document.getElementById('summarySnacks').textContent = 'No snacks';
      }
      
      document.getElementById('summaryDiscount').textContent = `- RM ${discount.toFixed(2)}`;
      document.getElementById('summaryLoyaltyDiscount').textContent = `- RM ${loyaltyDiscount.toFixed(2)}`;
      document.getElementById('summarySubtotal').textContent = `RM ${subtotalBeforeLoyalty.toFixed(2)}`;
      document.getElementById('summaryTotal').textContent = `RM ${total.toFixed(2)}`;
    
      // Update amenities display
      updateAmenitiesDisplay();
      
      // Update terms display
      updateTermsDisplay();
    }

    // Reset booking process
    function resetBookingProcess() {
      selectedFacility = null;
      selectedDate = null;
      selectedTimeSlot = null;
      selectedCoach = null;
      selectedSnacks = [];
      currentMonth = new Date().getMonth();
      currentYear = new Date().getFullYear();
      maxStepReached = 1;
    }
    // Initialize Book Facility Page with Search
async function initializeBookFacilityPage() {
    // Load locations from Firestore
    await loadLocationsFromFirestore();
    
    // Load facilities from Firestore initially
    await loadFacilities();

    // Search facilities functionality
    document.getElementById('searchFacilitiesBtn').addEventListener('click', () => {
      confirmBookingInterruption(() => {
        searchFacilities();});
    });

    // Clear filters button
    document.getElementById('clearFiltersBtn').addEventListener('click', () => {
      confirmBookingInterruption(() => {
        clearFacilityFilters();
      });
    });

    // Add enter key support for search
    const searchInputs = ['sportType', 'bookingLocation', 'bookingDate', 'bookingTime', 'customLocationInput'];
    searchInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchFacilities();
                }
            });
        }
    });

    searchInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
            input.addEventListener('change', function() {
                confirmBookingInterruption(() => {
                    
                });
            });
        }
    });

    // Handle custom location selection
    document.getElementById('bookinglocation').addEventListener('change', function() {
        handleLocationSelection(this.value);
    });
}
function confirmBookingInterruption(onProceed) {
  if (!bookingInProgress) {
    onProceed();
    return;
  }

  const confirmChange = confirm(
    "‚ö† You have an ongoing booking.\n\n" +
    "Press OK to discard booking and apply filters.\n" +
    "Press Cancel to continue booking."
  );

  if (confirmChange) {
    // Reset booking state
    bookingInProgress = false;

    // Hide booking UI, show facilities again
    document.getElementById('bookingSteps').style.display = 'none';
    document.getElementById('facilitiesList').style.display = 'block';

    // Clear selected data (optional but recommended)
    selectedFacility = null;
    selectedDate = null;
    selectedTimeSlot = null;
    selectedCoach = null;
    selectedSnacks = [];
    selectedAmenities = [];

    onProceed();
  }
}
// Submit booking - UPDATED VERSION with notification and correct Firestore structure
async function submitBooking() {
    try {
        if (!selectedFacility || !selectedDate || !selectedTimeSlot) {
            showToast('Please complete all booking steps', 'warning');
            return;
        }

        // Calculate costs
        const courtFee = selectedFacility.price || 0;
        const coachFee = selectedCoach ? selectedCoach.rate : 0;
        const snacksFee = selectedSnacks.reduce((total, snack) => total + snack.price, 0);
        const amenitiesFee = selectedAmenities.reduce(
          (total, a) => total + Number(a.amenityPrice || 0),
          0
        );
        
        // Check if terms are agreed
        const agreeTerms = document.getElementById('agreeTerms').checked;
        if (!agreeTerms) {
          showToast('You must agree to the terms and conditions', 'warning');
          document.getElementById('agreeTerms').focus();
          return;
        }

        // Calculate promo discount (10% for NEWUSER10)
        let discount = 0;
        if (selectedFacility.promo === 'NEWUSER10') {
            discount = courtFee * 0.1;
        }

        // Calculate loyalty points discount (1 point = RM0.10)
        let loyaltyDiscount = 0;
        let loyaltyPointsUsed = 0;
        const useLoyaltyPoints = document.getElementById('useLoyaltyPoints').checked;
        
        if (useLoyaltyPoints && userLoyaltyPoints > 0) {
            // Maximum discount that can be applied is the subtotal before loyalty
            const subtotalBeforeLoyalty = courtFee + coachFee + snacksFee + amenitiesFee - discount;
            const maxLoyaltyPoints = Math.floor(subtotalBeforeLoyalty / 0.1);
            loyaltyPointsUsed = Math.min(userLoyaltyPoints, maxLoyaltyPoints);
            loyaltyDiscount = loyaltyPointsUsed * 0.1;
        }

        // Calculate final total
        const totalAmount = courtFee + coachFee + snacksFee + amenitiesFee - discount - loyaltyDiscount;

        // Prepare coach data if selected
        const coachData = selectedCoach ? {
            id: selectedCoach.id,
            name: selectedCoach.name,
            rate: selectedCoach.rate
        } : null;

        // Prepare booking data according to your Firestore structure
        const bookingData = {
            amenities: selectedAmenities.length > 0 ? selectedAmenities : [],
            amount: parseFloat(totalAmount.toFixed(2)),
            capacity: selectedFacility.capacity || 50,
            coach: coachData,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            date: selectedDate, // Format as "YYYY-MM-DD"
            description: selectedFacility.description || "Your dream tennis court where you can achieve success.",
            duration: "1 hour",
            facilityId: selectedFacility.id,
            facilityName: selectedFacility.name,
            imageUrl: selectedFacility.imageUrl || "https://bestshoeswomen.com/wp-content/uploads/2022/07/New-Balance-Court-Shoes.jpg",
            location: selectedFacility.location || "Maple,Malaysia",
            locationLink: selectedFacility.locationLink || "",
            loyaltyPointsUsed: loyaltyPointsUsed,
            maxBookings: selectedFacility.maxBookings || 1,
            name: selectedFacility.name,
            price: selectedFacility.price || 180,
            promo: selectedFacility.promo || "NEWUSER10",
            slots: selectedFacility.slots || ["5-6 PM"],
            snacks: selectedSnacks.length > 0 ? selectedSnacks : null,
            sportType: selectedFacility.type || "Tennis Court",
            status: "approved", // Start as approved, can be changed to "completed" later
            time: selectedTimeSlot,
            type: selectedFacility.type || "Tennis Court",
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            userEmail: currentUser.email,
            userId: currentUser.uid,
            userName: currentUser.displayName || "User"
        };

        // Add booking to Firestore
        const bookingRef = await db.collection('bookings').add(bookingData);

        // Update user's loyalty points if used
        if (loyaltyPointsUsed > 0) {
            const newLoyaltyPoints = userLoyaltyPoints - loyaltyPointsUsed;
            await db.collection('users').doc(currentUser.uid).update({
                loyaltyPoints: newLoyaltyPoints,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            // Update local variable
            userLoyaltyPoints = newLoyaltyPoints;
        }

        showToast('Booking submitted successfully!', 'success');
        bookingInProgress = false;
        // Send confirmation email
                emailjs.send(
          "service_n0uxxcp",
          "template_wv5zmmb",
          {
            to_email: currentUser.email,              // üî• THIS IS THE KEY
            user_name: currentUser.displayName || "User",
            slot: selectedTimeSlot,
            date: `${selectedDate.getFullYear()}-${String(selectedDate.getMonth()+1).padStart(2,'0')}-${String(selectedDate.getDate()).padStart(2,'0')}`,
            location: selectedFacility.location
          }
        )
        .then(() => {
          console.log("üìß Email sent to", currentUser.email);
        })
        .catch(err => {
          console.error("‚ùå EmailJS error:", err);
        });

        // Reset booking process
        resetBookingProcess();

        // Reload dashboard stats to reflect new booking
        if (currentUser) {
            await updateDashboardStats(currentUser.uid);
        }
        // ‚úÖ After booking is successfully saved
        setTimeout(() => {
  window.location.href = "user-dashboard.html?page=my-bookings";
}, 1200);

    } catch (error) {
        console.error('Error submitting booking:', error);
        showToast('Error submitting booking: ' + error.message, 'danger');
    }
}
//Find friends page
function loadFindFriendsPage() {
      return `
        <div class="row mb-4">
          <div class="col-md-12">
            <div class="form-card">
              <h4>Find Friends</h4>
              <div class="row">
                <div class="col-md-6">
                  <div class="input-group">
                    <input type="text" class="form-control" id="friendSearch" placeholder="Search by name, skill level, or sport...">
                    <button class="btn btn-primary" type="button" id="searchFriendsBtn">
                      <i class="fas fa-search"></i> Search
                    </button>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <select class="form-select" id="friendFilter">
                      <option value="all">All Users</option>
                      <option value="sameSport">Same Sport</option>
                      <option value="sameLevel">Same Skill Level</option>
                      <option value="sameLocation">Same Location</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-8">
            <div class="table-card">
              <h5>All Users</h5>
              <div id="allUsersList">
                <!-- All users will be loaded here -->
              </div>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="table-card">
              <h5>Suggested Friends</h5>
              <div id="suggestedFriends">
                <!-- Suggested friends will be loaded here -->
              </div>
            </div>
            
            <div class="table-card mt-4">
              <h5>Active Chats</h5>
              <div id="activeChats">
                <!-- Active chats will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Load all users except current user and admins
    async function loadAllUsers(searchTerm = '', filter = 'all') {
      try {
        const usersSnapshot = await db.collection('users').get();
        const allUsersList = document.getElementById('allUsersList');
        allUsersList.innerHTML = '';

        if (usersSnapshot.empty) {
          allUsersList.innerHTML = '<div class="text-center p-3">No users found</div>';
          return;
        }

        const currentUserData = window.userProfileData || {};
        const users = [];

        usersSnapshot.forEach(doc => {
          const userData = doc.data();
          // Skip current user and admins
          if (doc.id !== currentUser.uid && userData.role !== 'admin') {
            users.push({
              id: doc.id,
              ...userData
            });
          }
        });
        // Get all chats of current user
    const chatsSnap = await db.collection('chats')
      .where('participants', 'array-contains', currentUser.uid)
      .get();

    const chattedUserIds = new Set();
    chatsSnap.forEach(doc => {
      const participants = doc.data().participants || [];
      participants.forEach(uid => {
        if (uid !== currentUser.uid) chattedUserIds.add(uid);
      });
    });
        let filteredUsers = users.filter(user => {
  // Skip hidden users
  const hidden = window.userProfileData.hiddenUsers || [];
  if (hidden.includes(user.id)) return false;

  // Only show users with chats initially
  return chattedUserIds.has(user.id);
});

// Apply search filter
if (searchTerm) {
  filteredUsers = users.filter(user => {
    const matchesSearch = user.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                          user.primarySport?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                          user.skillLevel?.toLowerCase().includes(searchTerm.toLower());
    return matchesSearch;
  });
}
if (searchTerm) {
  const searchResults = users.filter(user => {
    return user.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
           user.primarySport?.toLowerCase().includes(searchTerm.toLowerCase()) ||
           user.skillLevel?.toLowerCase().includes(searchTerm.toLowerCase());
  });

  searchResults.forEach(user => addUserCardToAllUsers(user));
  return; // skip normal rendering
}

          let matchesFilter = true;
          if (filter === 'sameSport' && currentUserData.primarySport) {
             return matchesFilter = user.primarySport === currentUserData.primarySport;
          } else if (filter === 'sameLevel' && currentUserData.skillLevel) {
            return matchesFilter = user.skillLevel === currentUserData.skillLevel;
          } else if (filter === 'sameLocation' && currentUserData.location) {
            return matchesFilter = user.location === currentUserData.location;
          }

        if (filteredUsers.length === 0) {
          allUsersList.innerHTML = '<div class="text-center p-3">No users match your criteria</div>';
          return;
        }

        // Render users
        filteredUsers.forEach(user => {
          const userCard = createUserCard(user, false);
          allUsersList.appendChild(userCard);
        });

      } catch (error) {
        console.error('Error loading users:', error);
        showToast('User not found', 'danger');
      }
    }
    function addUserCardToAllUsers(user) {
  const allUsersList = document.getElementById('allUsersList');
  // Prevent duplicate
  if (!allUsersList.querySelector(`.friend-card[data-user-id="${user.id}"]`)) {
    const card = createUserCard(user, false);
    allUsersList.appendChild(card);
  }
}

    // Load suggested friends based on similarities
    async function loadSuggestedFriends() {
      try {
        const usersSnapshot = await db.collection('users').get();
        const suggestedFriendsEl = document.getElementById('suggestedFriends');
        suggestedFriendsEl.innerHTML = '';

        if (usersSnapshot.empty) {
          suggestedFriendsEl.innerHTML = '<div class="text-center p-3">No suggestions available</div>';
          return;
        }

        const currentUserData = window.userProfileData || {};
        const users = [];

        usersSnapshot.forEach(doc => {
          const userData = doc.data();
          // Skip current user and admins
          if (doc.id !== currentUser.uid && userData.role !== 'admin') {
            users.push({
              id: doc.id,
              ...userData,
              similarityScore: calculateSimilarityScore(currentUserData, userData)
            });
          }
        });

        // Sort by similarity score and take top 5
        const suggestedUsers = users
          .sort((a, b) => b.similarityScore - a.similarityScore)
          .slice(0, 5);

        if (suggestedUsers.length === 0) {
          suggestedFriendsEl.innerHTML = '<div class="text-center p-3">No suggestions available</div>';
          return;
        }

        // Render suggested friends
        suggestedUsers.forEach(user => {
          const userCard = createUserCard(user, true);
          suggestedFriendsEl.appendChild(userCard);
        });

      } catch (error) {
        console.error('Error loading suggested friends:', error);
      }
    }

    // Calculate similarity score between current user and another user
    function calculateSimilarityScore(currentUser, otherUser) {
      let score = 0;

      // Same sport (highest weight)
      if (currentUser.primarySport && otherUser.primarySport &&
        currentUser.primarySport === otherUser.primarySport) {
        score += 40;
      }

      // Same skill level
      if (currentUser.skillLevel && otherUser.skillLevel &&
        currentUser.skillLevel === otherUser.skillLevel) {
        score += 30;
      }

      // Same location
      if (currentUser.location && otherUser.location &&
        currentUser.location === otherUser.location) {
        score += 20;
      }

      // Similar age (within 5 years)
      if (currentUser.age && otherUser.age) {
        const ageDiff = Math.abs(currentUser.age - otherUser.age);
        if (ageDiff <= 5) {
          score += 10;
        }
      }

      return score;
    }
async function hideUserPermanently(userId) {
  if (!userId) return;

  try {
    // Add userId to currentUser hiddenUsers array
    const userRef = db.collection('users').doc(currentUser.uid);
    await userRef.update({
      hiddenUsers: firebase.firestore.FieldValue.arrayUnion(userId)
    });

    // Remove from UI
    const card = document.querySelector(`.friend-card[data-user-id="${userId}"]`);
    if (card) card.remove();

    // Update local copy
    if (!window.userProfileData.hiddenUsers) window.userProfileData.hiddenUsers = [];
    window.userProfileData.hiddenUsers.push(userId);

    showToast("User hidden successfully", "success");

  } catch (err) {
    console.error("Error hiding user:", err);
    showToast("Failed to hide user", "danger");
  }
}

    function createUserCard(user, isSuggested = false) {
  const userCard = document.createElement('div');
  userCard.className = 'friend-card';
  userCard.dataset.userId = user.id;

  const skillLevelClass = user.skillLevel ?
    `skill-level ${user.skillLevel.toLowerCase()}` : 'skill-level beginner';
  const skillLevelText = user.skillLevel ?
    user.skillLevel.charAt(0).toUpperCase() + user.skillLevel.slice(1) : 'Beginner';
  const avatarUrl = user.photoURL || 'https://via.placeholder.com/60';

  userCard.innerHTML = `
    <div class="d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center">
        <img src="${avatarUrl}" 
             class="friend-avatar me-3" alt="${user.name}" 
             style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%;"
             onerror="this.src='https://via.placeholder.com/60'">
        <div>
          <h6 class="mb-1">${user.name || 'User'}</h6>
          <p class="mb-1 text-muted">
            <i class="fas fa-map-marker-alt me-1"></i>
            ${user.location || 'Location not set'}
          </p>
          <p class="mb-1">
            <span class="${skillLevelClass}">${skillLevelText}</span>
            ${user.primarySport ? `<span class="badge bg-secondary ms-1">${user.primarySport}</span>` : ''}
          </p>
          ${isSuggested ? `<small class="text-success"><i class="fas fa-star me-1"></i>Suggested</small>` : ''}
        </div>
      </div>
      <div class="d-flex flex-column align-items-end">
        <button class="btn btn-sm btn-outline-primary mb-1 start-chat-btn" 
                data-user-id="${user.id}" data-user-name="${user.name || 'User'}">
          <i class="fas fa-comment"></i> Chat
        </button>
        <button class="btn btn-sm btn-outline-danger remove-user-card-btn" title="Remove User">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  `;

  // Remove card from interface only
  userCard.querySelector('.remove-user-card-btn').addEventListener('click', () => {
  hideUserPermanently(user.id);
});

  return userCard;
}

    // Handle friend search and filtering
    function handleFriendSearch() {
      const searchTerm = document.getElementById('friendSearch').value;
      const filter = document.getElementById('friendFilter').value;
      loadAllUsers(searchTerm, filter);
    }

    // Load active chats for current user
    async function loadActiveChats() {
      try {
        const activeChatsEl = document.getElementById('activeChats');
        activeChatsEl.innerHTML = '';

        // Get all chats where current user is a participant
        const chatsSnapshot = await db.collection('chats')
          .where('participants', 'array-contains', currentUser.uid)
          .orderBy('lastMessageAt', 'desc')
          .limit(5)
          .get();

        if (chatsSnapshot.empty) {
          activeChatsEl.innerHTML = '<div class="text-center p-3">No active chats</div>';
          return;
        }

        // Get user data for each chat participant
        const chatPromises = chatsSnapshot.docs.map(async (doc) => {
          const chatData = doc.data();
          const otherParticipantId = chatData.participants.find(id => id !== currentUser.uid);

          if (otherParticipantId) {
            const userDoc = await db.collection('users').doc(otherParticipantId).get();
            return {
              chatId: doc.id,
              otherUserId: otherParticipantId,
              otherUser: userDoc.exists ? userDoc.data() : { name: 'Unknown User' },
              lastMessage: chatData.lastMessage,
              lastMessageAt: chatData.lastMessageAt
            };
          }
          return null;
        });

        const chats = (await Promise.all(chatPromises)).filter(chat => chat !== null);

        // Render active chats ‚Äî ensure we pass receiverId (string), not whole object
chats.forEach(chat => {
  const chatItem = document.createElement('div');
  chatItem.className = 'list-group-item list-group-item-action';
  chatItem.style.cursor = 'pointer';

  const lastMessageTime = chat.lastMessageAt ? formatMessageTime(chat.lastMessageAt.toDate()) : 'No messages';

  chatItem.innerHTML = `
    <div class="d-flex align-items-center">
      <img src="${chat.otherUser.photoURL || 'https://via.placeholder.com/40'}" 
           class="rounded-circle me-3" width="40" height="40" style="object-fit: cover;" 
           onerror="this.src='https://via.placeholder.com/40'">
      <div class="flex-grow-1">
        <h6 class="mb-1">${chat.otherUser.name || 'User'}</h6>
        <p class="mb-1 text-muted small">${chat.lastMessage || 'Start a conversation'}</p>
        <small class="text-muted">${lastMessageTime}</small>
      </div>
    </div>
  `;

  // IMPORTANT: pass the chatId and the other user's id (string)
  chatItem.addEventListener('click', () => openChat(chat.chatId, chat.otherUserId));
  activeChatsEl.appendChild(chatItem);
});

      } catch (error) {
        console.error('Error loading active chats:', error);
      }
    }

    // Format message time
    function formatMessageTime(timestamp) {
      const now = new Date();
      const messageTime = new Date(timestamp);
      const diffInHours = (now - messageTime) / (1000 * 60 * 60);

      if (diffInHours < 1) {
        return 'Just now';
      } else if (diffInHours < 24) {
        return `${Math.floor(diffInHours)}h ago`;
      } else {
        return messageTime.toLocaleDateString();
      }
    }

    async function openChat(chatId, receiver) {
  try {
    // receiver may be either a string (userId) or an object { id, name }
    let receiverId = null;

    if (!chatId) {
      console.error("openChat: missing chatId");
      return;
    }

    if (!receiver) {
      receiverId = null;
    } else if (typeof receiver === 'string') {
      receiverId = receiver;
    } else if (typeof receiver === 'object' && receiver.id) {
      receiverId = receiver.id;
    } else {
      // fallback: try to read assumed id property
      receiverId = receiver?.uid || null;
    }

    // Stop previous listener
    if (typeof activeChatListener === 'function') {
      activeChatListener();
      activeChatListener = null;
    }

    activeChatId = chatId;
    activeReceiverId = receiverId;

    // If receiverId not provided (null), fetch from chat doc
    if (!receiverId) {
      const chatDoc = await db.collection('chats').doc(chatId).get();
      if (!chatDoc.exists) {
        console.warn('openChat: chat doc not found');
      } else {
        const data = chatDoc.data();
        // determine participant id that is not current user
        const other = (data.participants || []).find(id => id !== currentUser.uid);
        receiverId = other || null;
        activeReceiverId = receiverId;
      }
    }

    // Load receiver info for header if we have an id
    if (receiverId) {
      const userSnap = await db.collection('users').doc(receiverId).get();
      if (userSnap.exists) {
        const u = userSnap.data();
        document.getElementById("chatUserName").textContent = u.name || "Unknown";
        document.getElementById("chatUserAvatar").src = u.photoURL || u.photoUrl || "https://via.placeholder.com/150";
      }
    }

    // Start message listener (setupChatListener or loadMessages ‚Äî use whichever you have)
    if (typeof setupChatListener === 'function') {
      setupChatListener(chatId);
    } else {
      loadMessages(chatId);
    }
    // Finally open the modal
    const modalEl = document.getElementById("chatModal");
    if (modalEl) {
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    } else {
      console.warn('openChat: chatModal element not found in DOM');
    }
    await markNotificationAsRead(chatId); 

  } catch (e) {
    console.error("openChat error:", e);
    showToast('Unable to open chat', 'danger');
  }
}
async function deleteEntireChat(chatId) {
  try {
    if (!chatId) return;

    const confirmDelete = confirm("Are you sure you want to clear this chat?");
    if (!confirmDelete) return;

    // 1Ô∏è‚É£ Delete all messages under this chat
    const messagesSnap = await db.collection("messages")
      .where("chatId", "==", chatId)
      .get();

    const batch = db.batch();
    messagesSnap.forEach(doc => batch.delete(doc.ref));
    await batch.commit();

    // 2Ô∏è‚É£ Reset chat metadata
    await db.collection("chats").doc(chatId).update({
      lastMessage: "",
      lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // 3Ô∏è‚É£ Clear UI
    document.getElementById("chatMessages").innerHTML =
      `<div class="text-center text-muted mt-3">Chat cleared</div>`;

    showToast("Chat cleared successfully", "success");

  } catch (err) {
    console.error("Delete chat error:", err);
    showToast("Failed to clear chat", "danger");
  }
}
document.getElementById("deleteChatBtn").addEventListener("click", () => {
  if (!activeChatId) {
    showToast("No chat selected", "warning");
    return;
  }
  deleteEntireChat(activeChatId);
});
// generate stable chatId for a pair of users
function generateChatId(user1, user2) {
  return [user1, user2].sort().join("_");
}
    // Start (or reuse) a chat between currentUser and friendId
async function startNewChat(friendId, friendName = '') {
  try {
    if (!currentUser || !friendId) return;

    // Use deterministic chatId so we don't need to query all chats
    const chatId = generateChatId(currentUser.uid, friendId);

    // Create/ensure chat doc (merge so it won't overwrite existing data)
    await db.collection('chats').doc(chatId).set({
      participants: [currentUser.uid, friendId],
      lastMessage: '',
      lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });

    // Open the chat modal by passing chatId and receiverId (string)
    openChat(chatId, friendId);
  } catch (error) {
    console.error('Error starting chat:', error);
    showToast('Error starting chat', 'danger');
  }
}


    function loadMessages(chatId) {
      const chatBox = document.getElementById("chatMessages");
      chatBox.innerHTML = "";

      activeChatListener = db.collection("messages")
        .where("chatId", "==", chatId)
        .orderBy("timestamp")
        .onSnapshot((snapshot) => {
          chatBox.innerHTML = ""; // prevent duplicates
        
          snapshot.forEach((doc) => {
            const msg = doc.data();
            const div = document.createElement("div");
            div.className = msg.senderId === currentUser.uid ? "sent" : "received";
            div.textContent = msg.text;
            chatBox.appendChild(div);
          });
        
          // auto scroll
          chatBox.scrollTop = chatBox.scrollHeight;
        });
    }

    // Add date separator
    function addDateSeparator(date) {
      const chatMessages = document.getElementById('chatMessages');
      const separator = document.createElement('div');
      separator.className = 'chat-date-separator';

      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      let dateText;
      if (date.toDateString() === today.toDateString()) {
        dateText = 'Today';
      } else if (date.toDateString() === yesterday.toDateString()) {
        dateText = 'Yesterday';
      } else {
        dateText = date.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      }

      separator.innerHTML = `<span>${dateText}</span>`;
      chatMessages.appendChild(separator);
    }

    // Typing indicator functionality
    function setupTypingListener(chatId) {
      const typingRef = db.collection('chats').doc(chatId);

      // Listen for typing indicators
      typingRef.onSnapshot((doc) => {
        const data = doc.data();
        if (data && data.typing && data.typing.userId !== currentUser.uid) {
          showTypingIndicator(data.typing.userName);
        } else {
          hideTypingIndicator();
        }
      });
    }

    function showTypingIndicator(userName) {
      const typingIndicator = document.getElementById('typingIndicator');
      const typingUserName = document.getElementById('typingUserName');

      typingUserName.textContent = userName;
      typingIndicator.style.display = 'block';

      // Add animated dots
      const dots = document.createElement('span');
      dots.className = 'typing-dots';
      dots.innerHTML = `
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      `;

      typingIndicator.querySelector('small').appendChild(dots);
    }

    function hideTypingIndicator() {
      const typingIndicator = document.getElementById('typingIndicator');
      typingIndicator.style.display = 'none';
    }

    // Enhanced send message with typing indicator
    let typingTimer;
    const TYPING_TIMEOUT = 3000;

    let unsubscribeMessages = null;

function setupChatListener(chatId) {
    try {
        // stop old listener if exists
        if (unsubscribeMessages) {
            unsubscribeMessages();
            unsubscribeMessages = null;
        }

        // start new listener
        unsubscribeMessages = db.collection("messages")
            .where("chatId", "==", chatId)
            .orderBy("timestamp", "asc")
            .onSnapshot(snapshot => {

                const chatMessages = document.getElementById("chatMessages");
                if (!chatMessages) return;

                chatMessages.innerHTML = "";

                snapshot.forEach(doc => {
                    addMessageToChat(doc.data(), doc.id);
                });

                chatMessages.scrollTop = chatMessages.scrollHeight;
            });

    } catch (err) {
        console.error("setupChatListener ERROR:", err);
    }
}


    // Enhanced message display
    function addMessageToChat(message, messageId) {
      const chatMessages = document.getElementById('chatMessages');

      // Remove empty state if present
      const emptyState = chatMessages.querySelector('.text-center');
      if (emptyState) {
        emptyState.remove();
      }

      const messageContainer = document.createElement('div');
      messageContainer.className = `message-container ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;

      const messageBubble = document.createElement('div');
      messageBubble.className = `message-bubble ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;

      const messageTime = formatMessageTime(message.timestamp?.toDate());
      const statusIcon = message.senderId === currentUser.uid ?
        '<i class="fas fa-check message-status"></i>' : '';

      messageBubble.innerHTML = `
        <div class="message-text">${message.text}</div>
        ${message.fileUrl ? `
          <div class="message-file">
            ${message.fileUrl.endsWith('.mp4') || message.fileUrl.endsWith('.mov') ?
              `<video controls style="max-width: 200px; border-radius: 10px;">
                 <source src="${message.fileUrl}">
               </video>` :
              `<img src="${message.fileUrl}" style="max-width: 200px; border-radius: 10px;">`
            }
          </div>
        ` : ''}
        <div class="message-time">
          ${messageTime}
          ${statusIcon}
        </div>
        ${message.reactions ? `
          <div class="message-reactions">
            ${Object.entries(message.reactions).map(([emoji, users]) =>
        `<span class="reaction" title="${users.join(', ')}">${emoji} ${users.length}</span>`
      ).join('')}
          </div>
        ` : ''}
      `;

      messageContainer.appendChild(messageBubble);
      chatMessages.appendChild(messageContainer);

      // Auto-scroll to bottom for new messages
      if (message.senderId === currentUser.uid || !chatMessages.scrollTop) {
        scrollToBottom();
      }
    }

    // Scroll to bottom of chat
    function scrollToBottom() {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    //-------------------------------------------------------------------
// Helper: Get other user from chatId
//-------------------------------------------------------------------
function getChatPartnerId(chatId) {
    const parts = chatId.split("_");
    return parts[0] === currentUser.uid ? parts[1] : parts[0];
}

async function sendMessage() {
    const messageInput = document.getElementById("messageInput");
    const messageText = messageInput.value.trim();

    // Don't send if both text and file are empty
    if (!messageText && !selectedFileUrl) return;

    if (!activeChatId) {
        console.warn("No active chat selected");
        return;
    }

    // Determine receiver ID from chatId
    const receiverId = getChatPartnerId(activeChatId);

    const messageData = {
        chatId: activeChatId,
        senderId: currentUser.uid,
        receiverId: receiverId,
        text: messageText || "",
        fileUrl: selectedFileUrl || null,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
        // Save message to Firestore
        await db.collection("messages").add(messageData);

        // Send notification to receiver
        await createNotification(
            receiverId,
            "new_message",
            window.userProfileData?.name || "Message",
            messageText || "[Attachment]",
            { chatId: activeChatId }
        );

        // Clear input and reset attachment
        messageInput.value = "";
        selectedFileUrl = null;

    } catch (err) {
        console.error("Error sending message:", err);
        showToast("Failed to send message", "danger");
    }
}

// -------------------------------
// Press Enter to send message
// -------------------------------
document.getElementById("messageInput").addEventListener("keydown", function (e) {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault(); // prevent newline
        sendMessage();
    }
});


// -------------------------------
// Handle file attachment
// -------------------------------
document.getElementById('attachBtn').addEventListener('click', () => {
    document.getElementById('chatAttachmentInput').click();
});

document.getElementById("chatAttachmentInput").addEventListener("change", async function () {
    const file = this.files[0];
    if (!file) return;

    try {
        const url = await uploadToCloudinary(file);

        // Assign uploaded file URL to global variable
        selectedFileUrl = url;

        // Optionally: auto-send attachment immediately
        sendMessage();

    } catch (err) {
        console.error("File upload failed:", err);
        showToast("File upload failed", "danger");
    } finally {
        // Reset input value so same file can be selected again
        this.value = "";
    }
});

    // Enhanced message time formatting
    function formatMessageTime(timestamp) {
      if (!timestamp) return '';

      const now = new Date();
      const messageTime = new Date(timestamp);
      const diffInMinutes = (now - messageTime) / (1000 * 60);

      if (diffInMinutes < 1) {
        return 'Just now';
      } else if (diffInMinutes < 60) {
        return `${Math.floor(diffInMinutes)}m ago`;
      } else if (diffInMinutes < 1440) {
        return messageTime.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
      } else {
        return messageTime.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric'
        });
      }
    }

    // Add event listeners for chat actions
    document.getElementById('callBtn').addEventListener('click', function () {
      showToast('Voice call feature coming soon!', 'info');
    });

    document.getElementById('videoCallBtn').addEventListener('click', function () {
      showToast('Video call feature coming soon!', 'info');
    });

    // Typing indicator management
    async function updateTypingIndicator(isTyping) {
      if (!window.currentChat) return;

      try {
        await db.collection('chats')
          .doc(window.currentChat.chatId)
          .update({
            typing: isTyping ? {
              userId: currentUser.uid,
              userName: currentUser.displayName || 'User',
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            } : null
          });
      } catch (error) {
        console.error('Error updating typing indicator:', error);
      }
    }

    // Add typing detection
    document.getElementById('messageInput').addEventListener('input', function () {
      if (!window.currentChat) return;

      // Clear existing timer
      clearTimeout(typingTimer);

      // Start typing indicator
      updateTypingIndicator(true);

      // Set timer to stop typing indicator
      typingTimer = setTimeout(() => {
        updateTypingIndicator(false);
      }, TYPING_TIMEOUT);
    });
    // Initialize Find Friends Page
    async function initializeFindFriendsPage() {
      await loadAllUsers();
      await loadSuggestedFriends();
      await loadActiveChats();

      // Search functionality
      document.getElementById('searchFriendsBtn').addEventListener('click', handleFriendSearch);
      document.getElementById('friendSearch').addEventListener('input', handleFriendSearch);
      document.getElementById('friendFilter').addEventListener('change', handleFriendSearch);

      // Add event listener for chat buttons
      document.addEventListener('click', function (e) {
        if (e.target && e.target.classList.contains('start-chat-btn')) {
          const userId = e.target.getAttribute('data-user-id');
          const userName = e.target.getAttribute('data-user-name');
          startNewChat(userId, userName);
        }
      });

      // Working JavaScript
document.addEventListener('click', (e) => {
  const emojiBtn = document.getElementById('emojiBtn');
  const emojiPicker = document.getElementById('emojiPicker');
  const messageInput = document.getElementById('messageInput');

  if (!emojiBtn || !emojiPicker || !messageInput) return;

  // Toggle emoji picker when button clicked
  if (e.target.closest('#emojiBtn')) {
    e.stopPropagation(); // Prevent immediate close
    emojiPicker.classList.toggle('show');
    return;
  }

  // Close emoji picker when clicking outside
  if (!e.target.closest('#emojiPicker')) {
    emojiPicker.classList.remove('show');
  }

  // Add emoji to input if clicked
  if (e.target.classList.contains('emoji-option')) {
    const emojiChar = e.target.getAttribute('data-emoji');
    messageInput.value += emojiChar;
    emojiPicker.classList.remove('show');
    messageInput.focus();
  }
});
    }
  //My bookings page
  function loadMyBookingsPage() {
      return `
        <div class="row">
          <div class="col-md-12">
            <div class="table-card">
              <h4>My Bookings</h4>
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Facility</th>
                      <th>Date</th>
                      <th>Time</th>
                      <th>Status</th>
                      <th>Locate</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="allBookings">
                    <!-- All bookings will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;
    }
// Initialize My Bookings Page
    async function initializeMyBookingsPage() {
  firebase.auth().onAuthStateChanged(async (user) => {
    if (!user) {
      console.warn("Auth not ready yet");
      return;
    }

    currentUser = user; // ‚úÖ ensure global user is set
    await loadAllBookings();
  });
}
// Fixed version of loadAllBookings
async function loadAllBookings() {
   if (!currentUser || !currentUser.uid) {
    console.warn("loadAllBookings called without user");
    return;
  }

  try {
    const bookingsSnapshot = await db.collection('bookings')
      .where('userId', '==', currentUser.uid)
      .orderBy('date', 'desc')
      .get();

    const bookingsTable = document.getElementById('allBookings');
    if (!bookingsTable) return;

    bookingsTable.innerHTML = '';

    if (bookingsSnapshot.empty) {
      bookingsTable.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No bookings found</td></tr>';
      return;
    }

    const bookingsData = [];

    bookingsSnapshot.forEach(doc => {
      const booking = doc.data();
      bookingsData.push({ id: doc.id, ...booking });
    });

    // Render bookings
    bookingsData.forEach(booking => {
      const row = document.createElement('tr');

      // Format date - handle different date formats
      let formattedDate = 'Date not set';
      if (booking.date) {
        try {
           const bookingDate = booking.date.toDate ? booking.date.toDate() : new Date(booking.date);
        formattedDate = bookingDate.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      } catch (error) {
        console.error('Error formatting date:', error);
        formattedDate = 'Invalid date';
      }
      } 

      // Get facility name from different possible fields
      const facilityName = booking.facilityName || booking.facility?.name || booking.name || 'Facility';

      // Get time from different possible fields
      const time = booking.time || booking.slot || (booking.slots && booking.slots.length > 0 ? booking.slots[0] : 'Time not set');

      // Create status badge with better error handling
      let statusClass = 'badge-pending';
      let statusText = 'pending';

      if (booking.status) {
        const status = booking.status.toLowerCase();
        if (status === 'confirmed' || status === 'approved') {
          statusClass = 'badge-confirmed';
          statusText = 'confirmed';
        } else if (status === 'completed') {
          statusClass = 'badge-completed';
          statusText = 'completed';
        } else if (status === 'cancelled' || status === 'rejected') {
          statusClass = 'badge-cancelled';
          statusText = 'cancelled';
        } else if (status === 'active') {
          statusClass = 'badge-confirmed';
          statusText = 'active';
        } else {
          statusText = status;
        }
      }

      // Only show cancel button for pending or confirmed bookings
      const canCancel = statusText === 'approved';

      row.innerHTML = `
        <td>${facilityName}</td>
        <td>${formattedDate}</td>
        <td>${time}</td>
        <td><span class="badge badge-status ${statusClass}">${statusText}</span></td>
        <td><a href="${booking.locationLink}" target="_blank" class="text-decoration-none">
            <i class="bi bi-geo-alt"></i>
            </a></td>
        <td>
          <button class="btn btn-sm btn-outline-primary view-booking-btn" data-id="${booking.id}">
            <i class="fas fa-eye"></i> View
          </button>
          ${canCancel ? `
            <button class="btn btn-sm btn-outline-danger cancel-booking-btn" data-id="${booking.id}">
              <i class="fas fa-times"></i> Cancel
            </button>
          ` : ''}
        </td>
      `;

      bookingsTable.appendChild(row);
    });

    // Add event listeners to booking buttons
document.querySelectorAll('.view-booking-btn').forEach(btn => {
  btn.addEventListener('click', function (e) {
    e.preventDefault();
    e.stopPropagation();
    const bookingId = this.getAttribute('data-id');
    console.log('View button clicked for booking:', bookingId);
    viewBookingDetails(bookingId);
  });
});

    document.querySelectorAll('.cancel-booking-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const bookingId = this.getAttribute('data-id');
        cancelBooking(bookingId);
      });
    });

  } catch (error) {
    console.error('Error loading bookings:', error);
    const bookingsTable = document.getElementById('allBookings');
    if (bookingsTable) {
      bookingsTable.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Error loading bookings</td></tr>';
    }
  }
}

    // Fixed View Booking Details Function
async function viewBookingDetails(bookingId) {
  try {
    console.log('Loading booking details for:', bookingId);
    
    const bookingDoc = await db.collection('bookings').doc(bookingId).get();

    if (!bookingDoc.exists) {
      showToast('Booking not found', 'danger');
      return;
    }

    const booking = bookingDoc.data();
    console.log('Booking data:', booking);

    // Format date for display with proper error handling
    let formattedDate = 'Date not set';
    if (booking.date) {
      try {
        const bookingDate = booking.date.toDate ? booking.date.toDate() : new Date(booking.date);
        formattedDate = bookingDate.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      } catch (error) {
        console.error('Error formatting date:', error);
        formattedDate = 'Invalid date';
      }
    }

    // Get facility name from various possible fields
    const facilityName = booking.facilityName || booking.facility?.name || booking.name || 'Facility';

    // Get time from various possible fields
    const time = booking.time || booking.slot || (booking.slots && booking.slots.length > 0 ? booking.slots[0] : 'Time not set');

    // Get location
    const location = booking.location || booking.facility?.location || 'Location not specified';

    // Get sport type
    const sportType = booking.sportType || booking.facility?.sportType || 'Not specified';

    // Get duration
    const duration = booking.duration || '1 hour';

    // Get status with proper formatting
    const status = booking.status || 'pending';
    const statusBadgeClass = getStatusBadgeClass(status);
    const statusText = status.charAt(0).toUpperCase() + status.slice(1);

    // Calculate total amount
    const courtFee = booking.courtFee || booking.amount || booking.price || 0;
    const coachFee = booking.coach?.rate || 0;
    const snacksFee = booking.snacks ? booking.snacks.reduce((total, snack) => total + (snack.price || 0), 0) : 0;
    const totalAmount = courtFee + coachFee + snacksFee;

    // Create modal HTML
    const modalHtml = `
      <div class="modal fade" id="bookingDetailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title">Booking Details</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-header">
                      <h6 class="card-title mb-0">Facility Information</h6>
                    </div>
                    <div class="card-body">
                      <p><strong>Name:</strong> ${facilityName}</p>
                      <p><strong>Location:</strong> ${location}</p>
                      <p><strong>Sport Type:</strong> ${sportType}</p>
                      <p><strong>Duration:</strong> ${duration}</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-header">
                      <h6 class="card-title mb-0">Booking Details</h6>
                    </div>
                    <div class="card-body">
                      <p><strong>Date:</strong> ${formattedDate}</p>
                      <p><strong>Time:</strong> ${time}</p>
                      <p><strong>Status:</strong> <span class="badge ${statusBadgeClass}">${statusText}</span></p>
                      <p><strong>Booking ID:</strong> <small class="text-muted">${bookingId}</small></p>
                    </div>
                  </div>
                </div>
              </div>
              
              ${booking.coach ? `
              <div class="row mt-3">
                <div class="col-12">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="card-title mb-0">Coach Information</h6>
                    </div>
                    <div class="card-body">
                      <div class="d-flex align-items-center">
                        ${booking.coach.photoURL ? `
                          <img src="${booking.coach.photoURL}" class="rounded-circle me-3" width="60" height="60" style="object-fit: cover;">
                        ` : ''}
                        <div>
                          <p class="mb-1"><strong>Coach:</strong> ${booking.coach.name || 'N/A'}</p>
                          <p class="mb-1"><strong>Experience:</strong> ${booking.coach.experience || 'N/A'} years</p>
                          <p class="mb-0"><strong>Rate:</strong> RM${booking.coach.rate || '0'}/hour</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              ` : ''}
              
              ${booking.snacks && booking.snacks.length > 0 ? `
              <div class="row mt-3">
                <div class="col-12">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="card-title mb-0">Snacks Ordered</h6>
                    </div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table table-sm">
                          <thead>
                            <tr>
                              <th>Item</th>
                              <th>Price</th>
                            </tr>
                          </thead>
                          <tbody>
                            ${booking.snacks.map(snack => `
                              <tr>
                                <td>${snack.name || 'Snack'}</td>
                                <td>RM${snack.price || '0'}</td>
                              </tr>
                            `).join('')}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              ` : ''}
              
              <div class="row mt-3">
                <div class="col-12">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="card-title mb-0">Payment Information</h6>
                    </div>
                    <div class="card-body">
                      <div class="row">
                        <div class="col-md-6">
                          <p><strong>Court Fee:</strong> RM${courtFee}</p>
                          ${coachFee > 0 ? `<p><strong>Coach Fee:</strong> RM${coachFee}</p>` : ''}
                          ${snacksFee > 0 ? `<p><strong>Snacks Fee:</strong> RM${snacksFee}</p>` : ''}
                          ${booking.promoDiscount ? `<p><strong>Promo Discount:</strong> -RM${booking.promoDiscount}</p>` : ''}
                          ${booking.loyaltyPointsUsed ? `<p><strong>Loyalty Points Used:</strong> ${booking.loyaltyPointsUsed} points</p>` : ''}
                        </div>
                        <div class="col-md-6">
                          <div class="border-start ps-3">
                            <p class="h5 text-primary"><strong>Total Amount: RM${totalAmount}</strong></p>
                            <p class="mb-0"><strong>Payment Method:</strong> ${booking.paymentMethod || 'Online Payment'}</p>
                            <p class="mb-0"><strong>Payment Status:</strong> <span class="badge bg-success">Paid</span></p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              ${booking.notes ? `
              <div class="row mt-3">
                <div class="col-12">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="card-title mb-0">Additional Notes</h6>
                    </div>
                    <div class="card-body">
                      <p class="mb-0">${booking.notes}</p>
                    </div>
                  </div>
                </div>
              </div>
              ` : ''}
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" onclick="printBookingDetails('${bookingId}')">
                <i class="fas fa-print me-1"></i> Print Receipt
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    // Remove any existing modal
    const existingModal = document.getElementById('bookingDetailsModal');
    if (existingModal) {
      existingModal.remove();
    }

    // Add modal to DOM
    const modalContainer = document.createElement('div');
    modalContainer.innerHTML = modalHtml;
    document.body.appendChild(modalContainer);

    // Show modal
    const modalElement = document.getElementById('bookingDetailsModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();

    // Remove modal from DOM after it's hidden
    modalElement.addEventListener('hidden.bs.modal', function () {
      modalContainer.remove();
    });

  } catch (error) {
    console.error('Error viewing booking details:', error);
    showToast('Error loading booking details: ' + error.message, 'danger');
  }
}

// Helper function for canceling from modal
function cancelBookingFromModal(bookingId) {
  const modal = bootstrap.Modal.getInstance(document.getElementById('bookingDetailsModal'));
  if (modal) {
    modal.hide();
  }
  setTimeout(() => {
    cancelBooking(bookingId);
  }, 300);
}
// Fixed Print Booking Details Function
async function printBookingDetails(bookingId) {
  try {
    console.log('Printing booking details for:', bookingId);
    
    // Fetch fresh booking data
    const bookingDoc = await db.collection('bookings').doc(bookingId).get();
    if (!bookingDoc.exists) {
      showToast('Booking not found', 'danger');
      return;
    }

    const booking = bookingDoc.data();
    console.log('Booking data for print:', booking);

    // Fetch user and facility details
    let userDetails = {};
    let facilityDetails = {};

    if (booking.userId) {
      try {
        const userDoc = await db.collection('users').doc(booking.userId).get();
        if (userDoc.exists) userDetails = userDoc.data();
      } catch (error) {
        console.error('Error fetching user details:', error);
      }
    }

    if (booking.facilityId) {
      try {
        const facilityDoc = await db.collection('facilities').doc(booking.facilityId).get();
        if (facilityDoc.exists) facilityDetails = facilityDoc.data();
      } catch (error) {
        console.error('Error fetching facility details:', error);
      }
    }

    // Format dates and times with proper error handling
    let bookingDateFormatted = 'Date not set';
    let bookingDateTime = 'N/A';
    let createdDateFormatted = 'N/A';
    
    try {
      if (booking.date) {
        const bookingDate = booking.date.toDate ? booking.date.toDate() : new Date(booking.date);
        bookingDateFormatted = bookingDate.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          weekday: 'long'
        });
      }
      
      if (booking.createdAt) {
        const createdDate = booking.createdAt.toDate ? booking.createdAt.toDate() : new Date(booking.createdAt);
        createdDateFormatted = createdDate.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
      
      if (booking.timestamp) {
        const timestampDate = booking.timestamp.toDate ? booking.timestamp.toDate() : new Date(booking.timestamp);
        bookingDateTime = timestampDate.toLocaleString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
    } catch (error) {
      console.error('Error formatting dates:', error);
    }

    const timeSlot = booking.time || booking.slot || (booking.slots && booking.slots.length > 0 ? booking.slots[0] : 'Time not set');
    const printDate = new Date().toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    // Calculate amounts
    const courtFee = booking.courtFee || booking.amount || booking.price || 0;
    const coachFee = booking.coach?.rate || 0;
    const snacksFee = booking.snacks ? booking.snacks.reduce((total, snack) => total + (snack.price || 0), 0) : 0;
    const promoDiscount = booking.promoDiscount || 0;
    const loyaltyDiscount = booking.loyaltyPointsUsed ? (booking.loyaltyPointsUsed * 0.1) : 0; // 1 point = RM0.10
    const subtotal = courtFee + coachFee + snacksFee;
    const totalAmount = subtotal - promoDiscount - loyaltyDiscount;

    // Create print content
    const printContent = `
      <!DOCTYPE html>
      <html lang="en">
      <head>
          <title>Booking Confirmation - Sportova</title>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <style>
              body {
                  font-family: 'Arial', sans-serif;
                  line-height: 1.6;
                  color: #333;
                  max-width: 800px;
                  margin: 0 auto;
                  padding: 20px;
                  background: white;
              }
              .header {
                  text-align: center;
                  border-bottom: 3px solid #4361ee;
                  padding-bottom: 20px;
                  margin-bottom: 30px;
              }
              .logo {
                  max-width: 150px;
                  height: auto;
                  margin-bottom: 15px;
              }
              .company-name {
                  font-size: 28px;
                  font-weight: bold;
                  color: #4361ee;
                  margin-bottom: 5px;
              }
              .document-title {
                  text-align: center;
                  margin: 30px 0;
                  background: #f8f9fa;
                  padding: 20px;
                  border-radius: 10px;
              }
              .info-grid {
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 20px;
                  margin-bottom: 30px;
              }
              .info-section {
                  background: #f8f9fa;
                  padding: 20px;
                  border-radius: 8px;
                  border-left: 4px solid #4361ee;
              }
              .info-section h3 {
                  color: #4361ee;
                  margin-bottom: 15px;
                  font-size: 16px;
                  border-bottom: 1px solid #dee2e6;
                  padding-bottom: 8px;
              }
              .info-item {
                  margin-bottom: 10px;
                  display: flex;
                  justify-content: space-between;
              }
              .summary-section {
                  background: #4361ee;
                  color: white;
                  padding: 25px;
                  border-radius: 10px;
                  margin: 25px 0;
              }
              .summary-section h3 {
                  color: white;
                  margin-bottom: 20px;
                  text-align: center;
              }
              .amount-grid {
                  display: grid;
                  grid-template-columns: 1fr 1fr 1fr;
                  gap: 15px;
                  text-align: center;
              }
              .amount-item {
                  padding: 15px;
              }
              .amount-value {
                  font-size: 24px;
                  font-weight: bold;
                  margin-bottom: 5px;
              }
              .status-badge {
                  padding: 6px 12px;
                  border-radius: 20px;
                  font-size: 12px;
                  font-weight: bold;
                  text-transform: uppercase;
              }
              .status-pending { background: #fff3cd; color: #856404; }
              .status-confirmed { background: #d1edff; color: #004085; }
              .status-approved { background: #d4edda; color: #155724; }
              .status-completed { background: #d1ecf1; color: #0c5460; }
              .status-cancelled { background: #f8d7da; color: #721c24; }
              .footer {
                  margin-top: 40px;
                  padding-top: 20px;
                  border-top: 2px solid #dee2e6;
                  text-align: center;
                  font-size: 12px;
                  color: #666;
              }
              .breakdown {
                  background: #f8f9fa;
                  padding: 15px;
                  border-radius: 8px;
                  margin: 15px 0;
              }
              .breakdown-item {
                  display: flex;
                  justify-content: space-between;
                  padding: 5px 0;
                  border-bottom: 1px solid #dee2e6;
              }
              .breakdown-item:last-child {
                  border-bottom: none;
              }
              .total-amount {
                  font-size: 20px;
                  font-weight: bold;
                  color: #4361ee;
                  text-align: right;
                  margin-top: 10px;
                  padding-top: 10px;
                  border-top: 2px solid #4361ee;
              }
              @media print {
                  body { 
                      padding: 0; 
                      margin: 0;
                  }
                  .no-print { 
                      display: none; 
                  }
                  .header {
                      margin-bottom: 20px;
                  }
                  .info-grid {
                      gap: 10px;
                  }
              }
              @media screen {
                  body {
                      box-shadow: 0 0 20px rgba(0,0,0,0.1);
                      margin: 20px auto;
                  }
              }
          </style>
      </head>
      <body>
          <div class="header">
              <img src="img/logo.jpg" alt="Sportova Logo" class="logo">
              <div>Premium Sports Facility Management</div>
              <small>Booking Confirmation Receipt</small>
          </div>

          <div class="document-title">
              <h1>BOOKING CONFIRMATION</h1>
              <p>Reference: #${bookingId.substring(0, 8).toUpperCase()}</p>
              <small>Generated on: ${printDate}</small>
          </div>

          <div class="info-grid">
              <div class="info-section">
                  <h3>CUSTOMER INFORMATION</h3>
                  <div class="info-item">
                      <span>Name:</span>
                      <span>${booking.userName || userDetails.name || currentUser.displayName || 'Customer'}</span>
                  </div>
                  <div class="info-item">
                      <span>Email:</span>
                      <span>${userDetails.email || currentUser.email || 'N/A'}</span>
                  </div>
                  <div class="info-item">
                      <span>Phone:</span>
                      <span>${userDetails.phone || 'N/A'}</span>
                  </div>
                  <div class="info-item">
                      <span>Member Since:</span>
                      <span>${userDetails.createdAt ? new Date(userDetails.createdAt.toDate()).getFullYear() : 'N/A'}</span>
                  </div>
              </div>

              <div class="info-section">
                  <h3>BOOKING DETAILS</h3>
                  <div class="info-item">
                      <span>Facility:</span>
                      <span>${booking.facilityName || facilityDetails.name || 'Facility'}</span>
                  </div>
                  <div class="info-item">
                      <span>Date:</span>
                      <span>${bookingDateFormatted}</span>
                  </div>
                  <div class="info-item">
                      <span>Time Slot:</span>
                      <span>${timeSlot}</span>
                  </div>
                  <div class="info-item">
                      <span>Duration:</span>
                      <span>${booking.duration || '1 hour'}</span>
                  </div>
                  <div class="info-item">
                      <span>Status:</span>
                      <span class="status-badge status-${(booking.status || 'pending').toLowerCase()}">${(booking.status || 'pending').toUpperCase()}</span>
                  </div>
              </div>
          </div>

          ${booking.coach ? `
          <div class="info-section">
              <h3>COACH INFORMATION</h3>
              <div class="info-item">
                  <span>Coach Name:</span>
                  <span>${booking.coach.name || 'N/A'}</span>
              </div>
              <div class="info-item">
                  <span>Experience:</span>
                  <span>${booking.coach.experience || 'N/A'} years</span>
              </div>
              <div class="info-item">
                  <span>Specialty:</span>
                  <span>${booking.coach.specialties ? booking.coach.specialties.join(', ') : 'N/A'}</span>
              </div>
          </div>
          ` : ''}

          ${booking.snacks && booking.snacks.length > 0 ? `
          <div class="info-section">
              <h3>SNACKS ORDERED</h3>
              ${booking.snacks.map(snack => `
                  <div class="info-item">
                      <span>${snack.name || 'Snack'}:</span>
                      <span>RM${snack.price || '0'}</span>
                  </div>
              `).join('')}
          </div>
          ` : ''}

          <div class="summary-section">
              <h3>PAYMENT SUMMARY</h3>
              <div class="breakdown">
                  <div class="breakdown-item">
                      <span>Court Fee:</span>
                      <span>RM${courtFee.toFixed(2)}</span>
                  </div>
                  ${coachFee > 0 ? `
                  <div class="breakdown-item">
                      <span>Coach Fee:</span>
                      <span>RM${coachFee.toFixed(2)}</span>
                  </div>
                  ` : ''}
                  ${snacksFee > 0 ? `
                  <div class="breakdown-item">
                      <span>Snacks Fee:</span>
                      <span>RM${snacksFee.toFixed(2)}</span>
                  </div>
                  ` : ''}
                  ${promoDiscount > 0 ? `
                  <div class="breakdown-item">
                      <span>Promo Discount:</span>
                      <span>-RM${promoDiscount.toFixed(2)}</span>
                  </div>
                  ` : ''}
                  ${loyaltyDiscount > 0 ? `
                  <div class="breakdown-item">
                      <span>Loyalty Discount:</span>
                      <span>-RM${loyaltyDiscount.toFixed(2)}</span>
                  </div>
                  ` : ''}
                  <div class="total-amount">
                      <span>Total Amount:</span>
                      <span>RM${totalAmount.toFixed(2)}</span>
                  </div>
              </div>
              
              <div class="amount-grid">
                  <div class="amount-item">
                      <div class="amount-value">RM${totalAmount.toFixed(2)}</div>
                      <div>Total Amount</div>
                  </div>
                  <div class="amount-item">
                      <div class="amount-value">${booking.paymentMethod || 'Online'}</div>
                      <div>Payment Method</div>
                  </div>
                  <div class="amount-item">
                      <div class="amount-value">Paid</div>
                      <div>Payment Status</div>
                  </div>
              </div>
          </div>

          <div class="info-grid">
              <div class="info-section">
                  <h3>FACILITY INFORMATION</h3>
                  <div class="info-item">
                      <span>Facility Type:</span>
                      <span>${facilityDetails.type || booking.sportType || 'Sports Facility'}</span>
                  </div>
                  <div class="info-item">
                      <span>Location:</span>
                      <span>${facilityDetails.location || booking.location || 'N/A'}</span>
                  </div>
                  <div class="info-item">
  <span>Amenities Included</span>
  <span>
    ${
      Array.isArray(facilityDetails.amenities) &&
      facilityDetails.amenities.length > 0
        ? facilityDetails.amenities
            .map(a => a.amenity || a.title || a)
            .join(', ')
        : 'Standard amenities'
    }
  </span>
</div>
              </div>

              <div class="info-section">
                  <h3>BOOKING TIMELINE</h3>
                  <div class="info-item">
                      <span>Booking Created:</span>
                      <span>${createdDateFormatted}</span>
                  </div>
                  <div class="info-item">
                      <span>Last Updated:</span>
                      <span>${booking.updatedAt ? (booking.updatedAt.toDate ? booking.updatedAt.toDate().toLocaleDateString() : 'N/A') : 'N/A'}</span>
                  </div>
                  <div class="info-item">
                      <span>Booking Reference:</span>
                      <span>#${bookingId.substring(0, 8).toUpperCase()}</span>
                  </div>
              </div>
          </div>

          <div class="footer">
              <div style="margin-bottom: 15px;">
                  <strong>Sportova Sports Facilities</strong><br>
                  Email: support@sportova.com | Phone: +1 (555) 123-SPORT<br>
                  Website: www.sportova.com | Address: Penang, Malaysia
              </div>
              <div>
                  <strong>Terms & Conditions:</strong><br>
                  ‚Ä¢ Cancellations must be made at least 24 hours in advance for a full refund<br>
                  ‚Ä¢ Late arrivals may result in reduced playing time<br>
                  ‚Ä¢ Please bring valid ID for verification<br>
                  ‚Ä¢ Sports equipment may be rented at the facility
              </div>
              <div style="margin-top: 15px;">
                  Thank you for choosing Sportova! This is a computer-generated document.
              </div>
          </div>
      </body>
      </html>
    `;

    // Open print window
    const printWindow = window.open('', '_blank', 'width=900,height=700');
    if (!printWindow) {
      showToast('Please allow popups to print receipt', 'warning');
      return;
    }

    printWindow.document.write(printContent);
    printWindow.document.close();

    // Wait for content to load and then print
    printWindow.onload = function () {
      setTimeout(() => {
        printWindow.print();
        // Optional: Close window after printing
        // printWindow.onafterprint = function() {
        //   printWindow.close();
        // };
      }, 500);
    };

  } catch (error) {
    console.error('Error printing booking details:', error);
    showToast('Error generating print document: ' + error.message, 'danger');
  }
}

    // Helper function for status badge classes
function getStatusBadgeClass(status) {
  if (!status) return 'bg-secondary';
  
  const statusLower = status.toLowerCase();
  const statusClasses = {
    'pending': 'bg-warning',
    'confirmed': 'bg-success',
    'approved': 'bg-success',
    'completed': 'bg-info',
    'active': 'bg-primary',
    'cancelled': 'bg-danger',
    'rejected': 'bg-danger'
  };
  
  return statusClasses[statusLower] || 'bg-secondary';
}

    // Cancel a booking
    async function cancelBooking(bookingId) {
      if (!confirm('Are you sure you want to cancel this booking?')) return;

      try {
        await db.collection('bookings').doc(bookingId).update({
          status: 'cancelled',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('Booking cancelled successfully', 'success');

        // Reload bookings
        await loadAllBookings();

      } catch (error) {
        console.error('Error cancelling booking:', error);
        showToast('Error cancelling booking', 'danger');
      }
    }
//Marketplace page
function loadMarketplacePage() {
      return `
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="form-card">
          <h4>Sell Your Equipment</h4>
          <div class="row">
            <div class="col-md-4">
              <div class="form-group">
                <label class="form-label">Item Name</label>
                <input type="text" class="form-control" id="itemName" placeholder="e.g. Tennis Racket">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label class="form-label">Price (RM)</label>
                <input type="number" class="form-control" id="itemPrice" placeholder="e.g. 150">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label class="form-label">Condition</label>
                <select class="form-select" id="itemCondition">
                  <option value="new">New</option>
                  <option value="excellent">Excellent</option>
                  <option value="good">Good</option>
                  <option value="fair">Fair</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group mb-3">
              <label class="form-label">Upload Image</label>

              <input type="file" id="itemImageFile" multiple
                     accept="image/*"
                     class="form-control">

              <img id="itemImagePreview"
                   style="max-height: 150px; display:none; margin-top:10px;"
                   class="d-flex mt-2 rounded" />
            </div>

            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="itemCategory">
                  <option value="tennis">Tennis</option>
                  <option value="badminton">Badminton</option>
                  <option value="basketball">Basketball</option>
                  <option value="football">Football</option>
                  <option value="fitness">Fitness</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">Your Contact Number</label>
                <input type="tel" class="form-control" id="contactNumber" placeholder="+6012-345-6789">
                <small class="form-text text-muted">This will be shown to potential buyers</small>
              </div>
            </div>
            <div class="col-md-12">
              <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="itemDescription" rows="3" placeholder="Describe your item"></textarea>
              </div>
            </div>
            <div class="col-md-12">
              <button class="btn btn-primary" id="listItemBtn">
                <i class="fas fa-plus"></i> List Item
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-12">
        <div class="form-card">
          <h4>Filter Items</h4>
          <div class="row">
            <div class="col-md-3">
              <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="filterCategory">
                  <option value="all">All Categories</option>
                  <option value="tennis">Tennis</option>
                  <option value="badminton">Badminton</option>
                  <option value="basketball">Basketball</option>
                  <option value="football">Football</option>
                  <option value="fitness">Fitness</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label class="form-label">Condition</label>
                <select class="form-select" id="filterCondition">
                  <option value="all">All Conditions</option>
                  <option value="new">New</option>
                  <option value="excellent">Excellent</option>
                  <option value="good">Good</option>
                  <option value="fair">Fair</option>
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label class="form-label">Price Range</label>
                <select class="form-select" id="filterPrice">
                  <option value="all">All Prices</option>
                  <option value="0-50">RM 0 - 50</option>
                  <option value="51-100">RM 51 - 100</option>
                  <option value="101-200">RM 101 - 200</option>
                  <option value="201-500">RM 201 - 500</option>
                  <option value="501+">RM 501+</option>
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-select" id="filterStatus">
                  <option value="available">Available</option>
                  <option value="sold">Sold</option>
                  <option value="all">All</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row" id="marketplaceItems">
      <!-- Marketplace items will be loaded dynamically -->
    </div>
    <!-- marketplace model -->
    <div class="modal fade" id="productModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
        
          <div class="modal-header">
            <h5 class="modal-title" id="modalProductTitle"></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
        
          <div class="modal-body">
            <!-- Image Carousel -->
            <div id="productCarousel" class="carousel slide mb-3" data-bs-ride="carousel">
              <div class="carousel-inner" id="carouselImages"></div>
            
              <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon"></span>
              </button>
              <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon"></span>
              </button>
            </div>
          
            <p id="modalProductDesc"></p>
            <h5 id="modalProductPrice"></h5>
          </div>
        
        </div>
      </div>
    </div>
  `;
    // Image preview
      document.getElementById("itemImageFile").addEventListener("change", function (e) {
      const preview = document.getElementById("itemImagePreview");
      preview.innerHTML = "";
      
      Array.from(e.target.files).forEach(file => {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.style.maxHeight = "80px";
        img.style.marginRight = "5px";
        img.classList.add("rounded");
        preview.appendChild(img);
      });
    
      preview.style.display = "flex";
    });

    };
async function openProductModal(productId) {
  const doc = await db.collection("marketplace").doc(productId).get();
  if (!doc.exists) return;

  const product = doc.data();

  document.getElementById("modalProductTitle").innerText = product.name;
  document.getElementById("modalProductDesc").innerText = product.description;
  document.getElementById("modalProductPrice").innerText = `RM${product.price}`;

  const carousel = document.getElementById("carouselImages");
  carousel.innerHTML = "";

  product.images.forEach((img, index) => {
    carousel.innerHTML += `
      <div class="carousel-item ${index === 0 ? 'active' : ''}">
        <img src="${img}" class="d-block w-100"
             style="max-height:400px; object-fit:contain;">
      </div>
    `;
  });

  new bootstrap.Modal(document.getElementById("productModal")).show();
}
// Initialize Marketplace Page
    async function initializeMarketplacePage() {
      try {
        await loadMarketplaceItems();

        // Set up event listeners
        document.getElementById('listItemBtn').addEventListener('click', listNewItem);
        document.getElementById('filterCategory').addEventListener('change', filterItems);
        document.getElementById('filterCondition').addEventListener('change', filterItems);
        document.getElementById('filterPrice').addEventListener('change', filterItems);
        document.getElementById('filterStatus').addEventListener('change', filterItems);

      } catch (error) {
        console.error('Error initializing marketplace:', error);
        showToast('Error initializing marketplace', 'danger');
      }
    }

    // Load marketplace items from Firestore
    async function loadMarketplaceItems(filters = {}) {
      try {
        console.log('Loading marketplace items with filters:', filters);

        let itemsQuery = db.collection('marketplace');

        // Apply filters
        if (filters.category && filters.category !== 'all') {
          itemsQuery = itemsQuery.where('category', '==', filters.category);
        }

        if (filters.condition && filters.condition !== 'all') {
          itemsQuery = itemsQuery.where('condition', '==', filters.condition);
        }

        if (filters.status && filters.status !== 'all') {
          itemsQuery = itemsQuery.where('status', '==', filters.status);
        } else {
          // Default to available items
          itemsQuery = itemsQuery.where('status', '==', 'available');
        }

        const itemsSnapshot = await itemsQuery.orderBy('createdAt', 'desc').get();
        const marketplaceItems = document.getElementById('marketplaceItems');

        if (!marketplaceItems) {
          console.error('Marketplace items container not found');
          return;
        }

        marketplaceItems.innerHTML = '';

        if (itemsSnapshot.empty) {
          console.log('No marketplace items found');
          marketplaceItems.innerHTML = `
        <div class="col-12 text-center">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No items found. Be the first to list an item!
          </div>
        </div>
      `;
          return;
        }

        const itemsData = [];

        itemsSnapshot.forEach(doc => {
          const item = doc.data();
          itemsData.push({
            id: doc.id,
            ...item,
            // Ensure all required fields have default values
            name: item.name || 'Unnamed Item',
            price: item.price || 0,
            condition: item.condition || 'good',
            category: item.category || 'other',
            description: item.description || 'No description provided',
            sellerName: item.sellerName || 'Unknown Seller',
            sellerContact: item.sellerContact || 'Not provided',
            status: item.status || 'available'
          });
        });

        // Apply price filter
        let filteredItems = itemsData;
        if (filters.price && filters.price !== 'all') {
          filteredItems = itemsData.filter(item => {
            const price = item.price || 0;
            switch (filters.price) {
              case '0-50': return price <= 50;
              case '51-100': return price >= 51 && price <= 100;
              case '101-200': return price >= 101 && price <= 200;
              case '201-500': return price >= 201 && price <= 500;
              case '501+': return price >= 501;
              default: return true;
            }
          });
        }

        if (filteredItems.length === 0) {
          marketplaceItems.innerHTML = `
        <div class="col-12 text-center">
          <div class="alert alert-warning">
            <i class="fas fa-search me-2"></i>
            No items match your filters.
          </div>
        </div>
      `;
          return;
        }

        // Render items
        renderMarketplaceItems(filteredItems);
        // After rendering all items:
        addMarketplaceEventListeners();

      } catch (error) {
        console.error('Error loading marketplace items:', error);
        const marketplaceItems = document.getElementById('marketplaceItems');
        if (marketplaceItems) {
          marketplaceItems.innerHTML = `
        <div class="col-12 text-center">
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Error loading marketplace items: ${error.message}
          </div>
        </div>
      `;
        }
        showToast('Error loading marketplace items', 'danger');
      }
    }

    // In the renderMarketplaceItems function, update the contact section:
    function renderMarketplaceItems(items) {
      const marketplaceItems = document.getElementById('marketplaceItems');
      marketplaceItems.innerHTML = '';

      items.forEach(item => {
        const col = document.createElement('div');
        col.className = 'col-md-4 mb-4';

        const isOwner = item.sellerId === currentUser.uid;
        const isSold = item.status === 'sold';
        const firstImage = item.images?.[0]

        col.innerHTML = `
      <div class="product-card card ${isSold ? 'opacity-75' : ''}"
          onclick="openProductModal('${item.id}')"
          style="cursor:pointer">
        ${isSold ? '<div class="sold-badge">SOLD</div>' : ''}
        <div class="product-img-wrapper position-relative">
          <img src="${firstImage}" class="product-img" alt="product">

          <!-- IMAGE COUNT BADGE -->
          ${item.images && item.images.length > 1 ? `
            <span class="badge bg-dark position-absolute bottom-0 end-0 m-2">
              ${item.images.length} photos
            </span>
          ` : ''}
        </div>
        <div class="card-body d-flex flex-column">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="card-title">${item.name}</h5>
            <span class="badge bg-secondary text-capitalize">${item.category}</span>
          </div>
          <p class="card-text flex-grow-1">${item.description}</p>
          <div class="mb-2">
            <span class="badge ${getConditionBadgeClass(item.condition)} text-capitalize">${item.condition}</span>
            <small class="text-muted ms-2"><i class="fas fa-user"></i> ${item.sellerName}</small>
          </div>
          
          <!-- Contact Details -->
          <div class="contact-details">
            <div class="contact-label">Contact:</div>
            <div>${item.sellerContact || 'Not provided'}</div>
            ${!isOwner && !isSold && item.sellerContact ? `
              <div class="mt-2">
                <button class="btn btn-sm btn-success whatsapp-btn" 
                        data-contact="${item.sellerContact}" 
                        data-item="${item.name}"
                        data-seller="${item.sellerName}">
                  <i class="fab fa-whatsapp me-1"></i> Contact via WhatsApp
                </button>
              </div>
            ` : ''}
          </div>
          
          ${isSold && item.buyerContact ? `
          <div class="contact-details mt-2">
            <div class="contact-label">Buyer Contact:</div>
            <div>${item.buyerContact}</div>
            ${isOwner ? `
              <div class="mt-2">
                <button class="btn btn-sm btn-success whatsapp-btn" 
                        data-contact="${item.buyerContact}" 
                        data-item="${item.name}"
                        data-buyer="${item.buyerName}">
                  <i class="fab fa-whatsapp me-1"></i> Contact Buyer
                </button>
              </div>
            ` : ''}
          </div>
          ` : ''}
          
          <div class="mt-auto">
            <div class="d-flex justify-content-between align-items-center">
              <span class="h5 text-primary mb-0">RM${item.price}</span>
              <div>
                ${isOwner ? `
                  ${!isSold ? `
                    <button class="btn btn-sm btn-success mark-sold-btn" data-id="${item.id}">
                      <i class="fas fa-check"></i> Mark Sold
                    </button>
                  ` : ''}
                  <button class="btn btn-sm btn-outline-danger delete-item-btn" data-id="${item.id}">
                    <i class="fas fa-trash"></i>
                  </button>
                ` : `
                  ${!isSold ? `
                    <button class="btn btn-sm btn-primary buy-item-btn" data-id="${item.id}">
                      <i class="fas fa-shopping-cart"></i> Buy
                    </button>
                  ` : `
                    <span class="badge bg-danger">Sold</span>
                  `}
                `}
              </div>
            </div>
            ${item.createdAt ? `
              <small class="text-muted">
                Listed ${formatTimeAgo(item.createdAt.toDate())}
              </small>
            ` : ''}
          </div>
        </div>
      </div>
    `;

        marketplaceItems.appendChild(col);
      });

      // Add event listeners to WhatsApp buttons
      addWhatsAppEventListeners();
    }
    // Add event listeners to marketplace buttons
    function addMarketplaceEventListeners() {
      // Buy item buttons
      document.querySelectorAll('.buy-item-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const itemId = this.getAttribute('data-id');
          buyItem(itemId);
        });
      });

      // Mark as sold buttons
      document.querySelectorAll('.mark-sold-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const itemId = this.getAttribute('data-id');
          markItemAsSold(itemId);
        });
      });

      // Delete item buttons
      document.querySelectorAll('.delete-item-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const itemId = this.getAttribute('data-id');
          deleteItem(itemId);
        });
      });
    }

    // Helper function for condition badge classes
    function getConditionBadgeClass(condition) {
      const conditionClasses = {
        'new': 'bg-success',
        'excellent': 'bg-info',
        'good': 'bg-primary',
        'fair': 'bg-warning'
      };
      return conditionClasses[condition] || 'bg-secondary';
    }

    function formatTimeAgo(date) {
  if (!date) return '';
  const diff = (Date.now() - date.getTime()) / 1000; // seconds
  if (diff < 60) return 'Just now';
  if (diff < 3600) return Math.floor(diff/60) + 'm ago';
  if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
  return date.toLocaleDateString();
}

    // List a new item in marketplace
    async function listNewItem() {
      try {
        const itemName = document.getElementById('itemName').value.trim();
        const itemPrice = parseFloat(document.getElementById('itemPrice').value);
        const itemCondition = document.getElementById('itemCondition').value;
        const itemCategory = document.getElementById('itemCategory').value;
        // Handle MULTIPLE image upload
        const imageFiles = document.getElementById("itemImageFile").files;
        let imageUrls = [];

        if (imageFiles.length > 0) {
          for (const file of imageFiles) {
            const url = await uploadToCloudinary(file);
            imageUrls.push(url);
          }
        } else {
          imageUrls.push("https://via.placeholder.com/300x200?text=No+Image");
        }

        const itemDescription = document.getElementById('itemDescription').value.trim();
        const contactNumber = document.getElementById('contactNumber').value.trim();

        // Validation
        if (!itemName) {
          showToast('Please enter item name', 'warning');
          return;
        }

        if (!itemPrice || itemPrice <= 0) {
          showToast('Please enter a valid price greater than 0', 'warning');
          return;
        }

        if (!itemDescription) {
          showToast('Please enter item description', 'warning');
          return;
        }

        if (!contactNumber) {
          showToast('Please enter your contact number', 'warning');
          return;
        }

        const itemData = {
          name: itemName,
          price: itemPrice,
          condition: itemCondition,
          category: itemCategory,
          images: imageUrls,
          description: itemDescription,
          sellerId: currentUser.uid,
          sellerName: currentUser.displayName || 'User',
          sellerContact: contactNumber,
          status: 'available',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('marketplace').add(itemData);

        showToast('Item listed successfully!', 'success');

        // Clear form
        document.getElementById('itemName').value = '';
        document.getElementById('itemPrice').value = '';
        document.getElementById('itemImageFile').value = '';
        document.getElementById('itemDescription').value = '';
        document.getElementById('contactNumber').value = '';

        await loadMarketplaceItems();

      } catch (error) {
        console.error('Error listing item:', error);
        showToast('Error listing item: ' + error.message, 'danger');
      }
    }

    // Update the buyItem function
    async function buyItem(itemId) {
      try {
        const itemDoc = await db.collection('marketplace').doc(itemId).get();
        if (!itemDoc.exists) {
          showToast('Item not found', 'danger');
          return;
        }

        const item = itemDoc.data();

        if (item.sellerId === currentUser.uid) {
          showToast('You cannot buy your own item', 'warning');
          return;
        }

        if (item.status === 'sold') {
          showToast('This item has already been sold', 'warning');
          return;
        }

        // Get buyer contact number
        const buyerContact = prompt('Please enter your contact number for the seller:');
        if (!buyerContact) {
          showToast('Contact number is required to complete purchase', 'warning');
          return;
        }

        const confirmBuy = confirm(`Are you sure you want to buy "${item.name}" for RM${item.price}?`);
        if (!confirmBuy) return;

        // Update item status
        await db.collection('marketplace').doc(itemId).update({
          status: 'sold',
          buyerId: currentUser.uid,
          buyerName: currentUser.displayName || 'User',
          buyerContact: buyerContact,
          soldAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Create transaction record
        await db.collection('transactions').add({
          itemId: itemId,
          itemName: item.name,
          sellerId: item.sellerId,
          sellerName: item.sellerName,
          buyerId: currentUser.uid,
          buyerName: currentUser.displayName || 'User',
          price: item.price,
          status: 'completed',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('Purchase successful! Contact the seller to arrange pickup/delivery.', 'success');

        // Auto-open WhatsApp to contact seller
        if (item.sellerContact) {
          const confirmWhatsApp = confirm('Would you like to contact the seller via WhatsApp to arrange pickup/delivery?');
          if (confirmWhatsApp) {
            const message = `Hi ${item.sellerName}! I just purchased your "${item.name}" on Sportova Marketplace. My contact number is ${buyerContact}. Let's arrange for pickup/delivery.`;
            openWhatsAppWithMessage(item.sellerContact, message);
          }
        }

        // Reload items
        await loadMarketplaceItems();

      } catch (error) {
        console.error('Error buying item:', error);
        showToast('Error processing purchase', 'danger');
      }
    }
    // Add this function to handle WhatsApp button clicks
    function addWhatsAppEventListeners() {
      document.querySelectorAll('.whatsapp-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const contact = this.getAttribute('data-contact');
          const itemName = this.getAttribute('data-item');
          const sellerName = this.getAttribute('data-seller');
          const buyerName = this.getAttribute('data-buyer');

          const contactName = sellerName || buyerName;
          openWhatsApp(contact, itemName, contactName);
        });
      });
    }

    // Function to open WhatsApp with pre-filled message
    function openWhatsApp(contactNumber, itemName, contactName) {
      // Clean the contact number (remove spaces, dashes, etc.)
      const cleanNumber = contactNumber.replace(/[\s\-\(\)\+]/g, '');

      // Create the message
      const message = `Hi${contactName ? ' ' + contactName : ''}! I'm interested in your item "${itemName}" on Sportova Marketplace. Could you provide more details?`;

      // Encode the message for URL
      const encodedMessage = encodeURIComponent(message);

      // Create WhatsApp URL
      const whatsappUrl = `https://wa.me/${cleanNumber}?text=${encodedMessage}`;

      // Open in new tab
      window.open(whatsappUrl, '_blank');
    }

    // Helper function for WhatsApp with custom message
    function openWhatsAppWithMessage(contactNumber, message) {
      const cleanNumber = contactNumber.replace(/[\s\-\(\)\+]/g, '');
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/${cleanNumber}?text=${encodedMessage}`;
      window.open(whatsappUrl, '_blank');
    }

    // Mark item as sold (for sellers)
    async function markItemAsSold(itemId) {
      try {
        const itemDoc = await db.collection('marketplace').doc(itemId).get();
        if (!itemDoc.exists) {
          showToast('Item not found', 'danger');
          return;
        }

        const item = itemDoc.data();

        if (item.sellerId !== currentUser.uid) {
          showToast('You can only mark your own items as sold', 'warning');
          return;
        }

        const confirmSold = confirm('Mark this item as sold?');
        if (!confirmSold) return;

        await db.collection('marketplace').doc(itemId).update({
          status: 'sold',
          soldAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('Item marked as sold', 'success');
        await loadMarketplaceItems();

      } catch (error) {
        console.error('Error marking item as sold:', error);
        showToast('Error updating item', 'danger');
      }
    }

    // Delete item (for sellers)
    async function deleteItem(itemId) {
      try {
        const itemDoc = await db.collection('marketplace').doc(itemId).get();
        if (!itemDoc.exists) {
          showToast('Item not found', 'danger');
          return;
        }

        const item = itemDoc.data();

        if (item.sellerId !== currentUser.uid) {
          showToast('You can only delete your own items', 'warning');
          return;
        }

        const confirmDelete = confirm('Are you sure you want to delete this item?');
        if (!confirmDelete) return;

        await db.collection('marketplace').doc(itemId).delete();
        showToast('Item deleted successfully', 'success');
        await loadMarketplaceItems();

      } catch (error) {
        console.error('Error deleting item:', error);
        showToast('Error deleting item', 'danger');
      }
    }

    // Filter items
    async function filterItems() {
      const filters = {
        category: document.getElementById('filterCategory').value,
        condition: document.getElementById('filterCondition').value,
        price: document.getElementById('filterPrice').value,
        status: document.getElementById('filterStatus').value
      };

      await loadMarketplaceItems(filters);
    }
    //community page
    // Updated Community Page Loader
    function loadCommunityPage() {
      return `
    <div class="row mb-4">
  <div class="col-md-12">
    <div class="form-card p-3 shadow-sm rounded">
      <h4>Create a Post</h4>
      <div class="form-group mb-3">
        <textarea class="form-control" id="postContent" rows="3" placeholder="What's on your mind?"></textarea>
      </div>

      <div class="form-group mb-3">
        <label class="form-label">Upload Photos</label>
        <input type="file" id="postPhotoFile" accept="image/*" multiple class="form-control">
        <div id="postPhotoPreview" class="d-flex flex-wrap mt-2 gap-2"></div>
      </div>

      <div class="d-flex justify-content-end mt-3">
        <button class="btn btn-primary" id="createPostBtn">Post</button>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="col-md-8" id="communityPosts">
    <!-- Community posts will be loaded dynamically -->
  </div>

  <div class="col-md-4">
    <div class="table-card p-3 shadow-sm rounded">
      <h5>Community Stats</h5>
      <ul class="list-group">
        <li class="list-group-item d-flex justify-content-between align-items-center">
          Active Members
          <span class="badge bg-primary rounded-pill" id="activeMembers">0</span>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
          Posts This Week
          <span class="badge bg-primary rounded-pill" id="postsThisWeek">0</span>
        </li>
        <li class="list-group-item d-flex justify-content-between align-items-center">
          Events Created
          <span class="badge bg-primary rounded-pill" id="eventsCreated">0</span>
        </li>
      </ul>
    </div>

    <div class="table-card p-3 shadow-sm rounded mt-4">
      <h5>Top Players</h5>
      <div class="list-group" id="topPlayers">
        <!-- Top players will be loaded dynamically -->
      </div>
    </div>
  </div>
</div>
<!-- Post Modal -->
<div class="modal fade" id="postModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="postModalUser">User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Carousel for multiple images -->
        <div id="postModalCarousel" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-inner" id="postModalCarouselInner"></div>

          <button class="carousel-control-prev" type="button" data-bs-target="#postModalCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#postModalCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
          </button>
        </div>

        <p class="mt-3" id="postModalContent"></p>
      </div>
    </div>
  </div>
</div>
  `;
      document.getElementById("postPhotoFile").addEventListener("change", (e) => {
      const preview = document.getElementById("postPhotoPreview");
      preview.innerHTML = "";
      
      Array.from(e.target.files).forEach(file => {
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.style.height = "80px";
        img.style.marginRight = "8px";
        img.className = "rounded mb-2";
        preview.appendChild(img);
      });
    });
    }
// Initialize Community Page
    async function initializeCommunityPage() {
      try {
        await loadCommunityPosts();
        await loadCommunityStats();
        await loadTopPlayers();

        // Set up event listeners
        document.getElementById('createPostBtn').addEventListener('click', createPost);

      } catch (error) {
        console.error('Error initializing community page:', error);
        showToast('Error loading community posts', 'danger');
      }
    }

    // Load community posts
    async function loadCommunityPosts() {
      try {
        const postsSnapshot = await db.collection('posts')
          .orderBy('createdAt', 'desc')
          .get();

        const communityPosts = document.getElementById('communityPosts');
        communityPosts.innerHTML = '';

        if (postsSnapshot.empty) {
          communityPosts.innerHTML = `
        <div class="col-12 text-center">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No posts yet. Be the first to share something!
          </div>
        </div>
      `;
          return;
        }

        const postsData = [];

        postsSnapshot.forEach(doc => {
          const post = doc.data();
          postsData.push({
            id: doc.id,
            ...post
          });
        });

        // Render posts
        postsData.forEach(post => {
          const postElement = createPostElement(post);
          communityPosts.appendChild(postElement);
        });

      } catch (error) {
        console.error('Error loading posts:', error);
        showToast('Error loading posts', 'danger');
      }
    }
async function openPostModalById(postId) {
  const doc = await db.collection('posts').doc(postId).get();
  if (!doc.exists) return;
  openPostModal({ id: doc.id, ...doc.data() });
}
    function openPostModal(post) {
  const modalUser = document.getElementById("postModalUser");
  const modalContent = document.getElementById("postModalContent");
  const carouselInner = document.getElementById("postModalCarouselInner");

  // Set user and content
  modalUser.textContent = post.userName || "User";
  modalContent.textContent = post.content || "";

  // Build carousel
  carouselInner.innerHTML = "";
  if (post.images && post.images.length > 0) {
    post.images.forEach((img, index) => {
      const itemDiv = document.createElement("div");
      itemDiv.className = "carousel-item" + (index === 0 ? " active" : "");
      itemDiv.innerHTML = `<img src="${img}" class="d-block w-100" style="max-height:400px; object-fit:contain;">`;
      carouselInner.appendChild(itemDiv);
    });
  } else {
    carouselInner.innerHTML = `<div class="carousel-item active">
      <img src="placeholder.png" class="d-block w-100" style="max-height:400px; object-fit:contain;">
    </div>`;
  }

  // Show Bootstrap modal
  const postModal = new bootstrap.Modal(document.getElementById("postModal"));
  postModal.show();
}

    // Create post element with emoji reactions
    function createPostElement(post) {
      const postDiv = document.createElement('div');
      postDiv.className = 'post-card';
      postDiv.id = `post-${post.id}`;

      const mediaHtml = post.images && post.images.length > 0 ? `
<div id="postCarousel-${post.id}" class="carousel slide mb-3">
  <div class="carousel-inner">
    ${post.images.map((img, index) => `
      <div class="carousel-item ${index === 0 ? 'active' : ''}">
        <img src="${img}"
             class="d-block w-100 rounded post-image"
             style="max-height:350px; object-fit:contain; cursor:pointer"
             onclick="openPostModalById('${post.id}')">
      </div>
    `).join('')}
  </div>
</div>
` : '';

      // Get user's current reaction if any
      const userReaction = post.reactions ?
        Object.keys(post.reactions).find(emoji => post.reactions[emoji].includes(currentUser.uid)) : null;

      postDiv.innerHTML = `
    <div class="user-info d-flex align-items-center mb-3">
      <img src="${post.userPhotoUrl}">
      <div>
        <h6 class="mb-0">${post.userName || 'User'}</h6>
        <small class="text-muted">${formatTimeAgo(post.createdAt?.toDate())}</small>
      </div>
    </div>
    
    <div class="post-content-section mb-3">
      <!-- Carousel or main image -->
      ${mediaHtml}
      <p class="post-content">${post.content}</p>
    </div>
    
    <!-- Reactions Section -->
    <div class="reactions-section mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <div class="reactions-display">
          ${post.reactions ? Object.entries(post.reactions).map(([emoji, users]) =>
        users.length > 0 ? `<span class="reaction-badge">${emoji} ${users.length}</span>` : ''
      ).join('') : ''}
        </div>
        <button class="btn btn-sm btn-outline-secondary reaction-btn" data-post-id="${post.id}">
          <i class="fas fa-smile me-1"></i> React
        </button>
      </div>
      
      <!-- Emoji Picker (Hidden by default) -->
      <div class="emoji-picker mt-2" id="emoji-picker-${post.id}" style="display: none;">
        <div class="emoji-option" data-emoji="üëç">üëç</div>
        <div class="emoji-option" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</div>
        <div class="emoji-option" data-emoji="üòÇ">üòÇ</div>
        <div class="emoji-option" data-emoji="üòÆ">üòÆ</div>
        <div class="emoji-option" data-emoji="üò¢">üò¢</div>
        <div class="emoji-option" data-emoji="üéâ">üéâ</div>
        <div class="emoji-option" data-emoji="üî•">üî•</div>
        <div class="emoji-option" data-emoji="‚≠ê">‚≠ê</div>
      </div>
    </div>
    
    <div class="post-actions">
      <button class="post-action-btn like-btn ${post.likes && post.likes.includes(currentUser.uid) ? 'active' : ''}" 
              data-post-id="${post.id}">
        <i class="fas fa-heart me-1"></i>
        <span class="like-count">${post.likes ? post.likes.length : 0}</span>
      </button>
      <button class="post-action-btn comment-btn" data-post-id="${post.id}">
        <i class="fas fa-comment me-1"></i>
        <span class="comment-count">${post.comments ? post.comments.length : 0}</span>
      </button>
    </div>
    
    <div class="comments-section" id="comments-${post.id}" style="display: none;">
      <div class="comment-form mb-3">
        <div class="input-group">
          <input type="text" class="form-control comment-input" placeholder="Write a comment..." 
                 data-post-id="${post.id}">
          <button class="btn btn-primary add-comment-btn" data-post-id="${post.id}">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
      <div class="comments-list" id="comments-list-${post.id}">
        ${post.comments ? post.comments.map(comment => `
          <div class="comment mb-3 p-2 border rounded">
            <div class="d-flex align-items-center mb-1">
              <img src="${comment.userPhotoUrl || generateDefaultAvatar(comment.userName || 'User')}" 
                   class="rounded-circle me-2" width="30" height="30" style="object-fit: cover;"
                   onerror="this.src='https://via.placeholder.com/30'">
              <div class="flex-grow-1">
                <span class="comment-user fw-bold">${comment.userName}:</span>
                <span class="comment-text">${comment.text}</span>
              </div>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-1">
              <small class="text-muted">${comment.timestamp ? formatTimeAgo(comment.timestamp.toDate()) : 'Recently'}</small>
              <button class="btn btn-sm btn-outline-secondary comment-reaction-btn" 
                      data-post-id="${post.id}" data-comment-id="${comment.id}">
                <i class="fas fa-smile"></i>
              </button>
            </div>
            
            <!-- Comment Reactions -->
            <div class="comment-reactions mt-1">
              ${comment.reactions ? Object.entries(comment.reactions).map(([emoji, users]) =>
        users.length > 0 ? `<span class="reaction-badge small">${emoji} ${users.length}</span>` : ''
      ).join('') : ''}
            </div>
          </div>
        `).join('') : ''}
      </div>
    </div>
  `;

      // Add event listeners
      const likeBtn = postDiv.querySelector('.like-btn');
      const commentBtn = postDiv.querySelector('.comment-btn');
      const addCommentBtn = postDiv.querySelector('.add-comment-btn');
      const commentInput = postDiv.querySelector('.comment-input');
      const reactionBtn = postDiv.querySelector('.reaction-btn');
      const emojiPicker = postDiv.querySelector(`#emoji-picker-${post.id}`);
      const commentReactionBtns = postDiv.querySelectorAll('.comment-reaction-btn');

      likeBtn.addEventListener('click', () => toggleLike(post.id));
      commentBtn.addEventListener('click', () => toggleComments(post.id));
      addCommentBtn.addEventListener('click', () => addComment(post.id));
      commentInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addComment(post.id);
        }
      });

      // Reaction button event listener
      reactionBtn.addEventListener('click', () => {
        emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
      });

      // Emoji picker event listeners
      emojiPicker.querySelectorAll('.emoji-option').forEach(emoji => {
        emoji.addEventListener('click', function () {
          const emojiChar = this.getAttribute('data-emoji');
          addReaction(post.id, emojiChar);
          emojiPicker.style.display = 'none';
        });
      });

      // Comment reaction buttons
      commentReactionBtns.forEach(btn => {
        btn.addEventListener('click', function () {
          const postId = this.getAttribute('data-post-id');
          const commentId = this.getAttribute('data-comment-id');
          showCommentEmojiPicker(postId, commentId, this);
        });
      });

      return postDiv;
    }

    // Add reaction to a post
    async function addReaction(postId, emoji) {
      try {
        const postDoc = await db.collection('posts').doc(postId).get();
        if (!postDoc.exists) return;

        const post = postDoc.data();
        const reactions = post.reactions || {};

        // Remove user from any existing reaction
        Object.keys(reactions).forEach(existingEmoji => {
          if (reactions[existingEmoji].includes(currentUser.uid)) {
            reactions[existingEmoji] = reactions[existingEmoji].filter(id => id !== currentUser.uid);
          }
        });

        // Add user to the new reaction
        if (!reactions[emoji]) {
          reactions[emoji] = [];
        }

        // Toggle reaction - if user already has this reaction, remove it
        if (reactions[emoji].includes(currentUser.uid)) {
          reactions[emoji] = reactions[emoji].filter(id => id !== currentUser.uid);
        } else {
          reactions[emoji].push(currentUser.uid);
        }

        // Remove empty reaction arrays
        Object.keys(reactions).forEach(emojiKey => {
          if (reactions[emojiKey].length === 0) {
            delete reactions[emojiKey];
          }
        });

        await db.collection('posts').doc(postId).update({
          reactions: reactions,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Update UI
        await loadCommunityPosts();

      } catch (error) {
        console.error('Error adding reaction:', error);
        showToast('Error adding reaction', 'danger');
      }
    }

    // Show emoji picker for comment reactions
    function showCommentEmojiPicker(postId, commentId, buttonElement) {
      // Create or show emoji picker for comments
      let emojiPicker = document.getElementById(`comment-emoji-picker-${commentId}`);

      if (!emojiPicker) {
        emojiPicker = document.createElement('div');
        emojiPicker.id = `comment-emoji-picker-${commentId}`;
        emojiPicker.className = 'emoji-picker';
        emojiPicker.innerHTML = `
      <div class="emoji-option" data-emoji="üëç">üëç</div>
      <div class="emoji-option" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</div>
      <div class="emoji-option" data-emoji="üòÇ">üòÇ</div>
      <div class="emoji-option" data-emoji="üòÆ">üòÆ</div>
    `;

        // Position near the button
        const rect = buttonElement.getBoundingClientRect();
        emojiPicker.style.position = 'absolute';
        emojiPicker.style.top = `${rect.bottom + window.scrollY}px`;
        emojiPicker.style.left = `${rect.left + window.scrollX}px`;
        emojiPicker.style.zIndex = '1000';

        document.body.appendChild(emojiPicker);

        // Add event listeners to emoji options
        emojiPicker.querySelectorAll('.emoji-option').forEach(emoji => {
          emoji.addEventListener('click', function () {
            const emojiChar = this.getAttribute('data-emoji');
            addCommentReaction(postId, commentId, emojiChar);
            emojiPicker.remove();
          });
        });

        // Close emoji picker when clicking outside
        setTimeout(() => {
          const closePicker = (e) => {
            if (!emojiPicker.contains(e.target) && e.target !== buttonElement) {
              emojiPicker.remove();
              document.removeEventListener('click', closePicker);
            }
          };
          document.addEventListener('click', closePicker);
        }, 100);
      } else {
        emojiPicker.remove();
      }
    }

    // Add reaction to a comment
    async function addCommentReaction(postId, commentId, emoji) {
      try {
        const postDoc = await db.collection('posts').doc(postId).get();
        if (!postDoc.exists) return;

        const post = postDoc.data();
        const comments = post.comments || [];

        // Find the comment and update its reactions
        const updatedComments = comments.map(comment => {
          if (comment.id === commentId) {
            const reactions = comment.reactions || {};

            // Initialize array for this emoji if it doesn't exist
            if (!reactions[emoji]) {
              reactions[emoji] = [];
            }

            // Toggle user reaction
            if (reactions[emoji].includes(currentUser.uid)) {
              reactions[emoji] = reactions[emoji].filter(id => id !== currentUser.uid);
            } else {
              reactions[emoji].push(currentUser.uid);
            }

            // Remove empty reaction arrays
            Object.keys(reactions).forEach(emojiKey => {
              if (reactions[emojiKey].length === 0) {
                delete reactions[emojiKey];
              }
            });

            return {
              ...comment,
              reactions: reactions
            };
          }
          return comment;
        });

        await db.collection('posts').doc(postId).update({
          comments: updatedComments,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Update UI
        await loadCommunityPosts();

      } catch (error) {
        console.error('Error adding comment reaction:', error);
        showToast('Error adding reaction', 'danger');
      }
    }

    // Load community stats
    async function loadCommunityStats() {
      try {
        // Get total users count
        const usersSnapshot = await db.collection('users').get();
        const activeMembers = usersSnapshot.size;

        // Get posts from this week
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

        const postsSnapshot = await db.collection('posts')
          .where('createdAt', '>=', oneWeekAgo)
          .get();
        const postsThisWeek = postsSnapshot.size;

        // Get events count
        const eventsSnapshot = await db.collection('events').get();
        const eventsCreated = eventsSnapshot.size;

        // Update UI
        document.getElementById('activeMembers').textContent = activeMembers;
        document.getElementById('postsThisWeek').textContent = postsThisWeek;
        document.getElementById('eventsCreated').textContent = eventsCreated;

      } catch (error) {
        console.error('Error loading community stats:', error);
      }
    }

    // Load top players
    async function loadTopPlayers() {
      try {
        const usersSnapshot = await db.collection('users').get();
        const topPlayersEl = document.getElementById('topPlayers');
        topPlayersEl.innerHTML = '';

        if (usersSnapshot.empty) {
          topPlayersEl.innerHTML = '<div class="text-center p-3">No players found</div>';
          return;
        }

        const users = [];

        usersSnapshot.forEach(doc => {
          const userData = doc.data();
          // Skip admins
          if (userData.role !== 'admin') {
            users.push({
              id: doc.id,
              ...userData,
              // Calculate a score based on various factors
              score: calculatePlayerScore(userData)
            });
          }
        });

        // Sort by score and take top 5
        const topPlayers = users
          .sort((a, b) => b.score - a.score)
          .slice(0, 5);

        // Render top players
        topPlayers.forEach((player, index) => {
          const playerItem = document.createElement('a');
          playerItem.href = '#';
          playerItem.className = 'list-group-item list-group-item-action';

          playerItem.innerHTML = `
        <div class="d-flex align-items-center">
          <span class="badge bg-primary me-2">${index + 1}</span>
          <img src="${player.photoURL || generateDefaultAvatar(player.name || 'User')}" 
               class="rounded-circle me-3" width="40" height="40" style="object-fit: cover;"
               onerror="this.src='https://via.placeholder.com/40'">
          <div class="flex-grow-1">
            <h6 class="mb-0">${player.name || 'User'}</h6>
            <small class="text-muted">${player.primarySport || 'Sports'} ‚Ä¢ ${player.skillLevel || 'Beginner'}</small>
          </div>
          <span class="badge bg-success">${player.score} pts</span>
        </div>
      `;

          topPlayersEl.appendChild(playerItem);
        });

      } catch (error) {
        console.error('Error loading top players:', error);
      }
    }

    // Calculate player score based on various factors
    function calculatePlayerScore(userData) {
      let score = 0;

      // Base points for being active
      score += 10;

      // Points for skill level
      const skillPoints = {
        'beginner': 10,
        'intermediate': 20,
        'advanced': 30,
        'expert': 40
      };
      score += skillPoints[userData.skillLevel] || 0;

      // Points for loyalty points
      score += (userData.loyaltyPoints || 0) * 0.1;

      // Additional points for profile completeness
      if (userData.bio) score += 5;
      if (userData.location) score += 5;
      if (userData.primarySport) score += 5;

      return Math.round(score);
    }
let userProfileCache = null;

async function getUserProfile() {
  if (userProfileCache) return userProfileCache;

  const doc = await db.collection('users').doc(currentUser.uid).get();
  userProfileCache = doc.exists ? doc.data() : {};
  return userProfileCache;
}

    // Create a new post - FIXED VERSION
    async function createPost() {
      try {
        const content = document.getElementById('postContent').value.trim();
        const photoFiles = document.getElementById("postPhotoFile").files;
        let imageUrls = [];

        if (photoFiles.length > 0) {
          for (const file of photoFiles) {
            const url = await uploadToCloudinary(file, "image");
            imageUrls.push(url);
          }
        }
        if (!content) {
          showToast('Please enter post content', 'warning');
          return;
        }

        // Get user data properly
        const userData = await getUserProfile();
        const userPhotoUrl = userData.photoURL;

        const postData = {
          content: content,
          images: imageUrls,
          userId: currentUser.uid,
          userName: currentUser.displayName || 'User',
          userPhotoUrl: userPhotoUrl,
          likes: [],
          comments: [],
          reactions: {},
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('posts').add(postData);

        showToast('Post created successfully!', 'success');

        // Clear form
        document.getElementById('postContent').value = '';
        document.getElementById('postPhotoFile').value = '';

        // Reload posts and stats
        await loadCommunityPosts();
        await loadCommunityStats();

      } catch (error) {
        console.error('Error creating post:', error);
        showToast('Error creating post', 'danger');
      }
    }

    // Toggle like on a post
    async function toggleLike(postId) {
      try {
        const postDoc = await db.collection('posts').doc(postId).get();
        if (!postDoc.exists) return;

        const post = postDoc.data();
        const likes = post.likes || [];
        const hasLiked = likes.includes(currentUser.uid);

        if (hasLiked) {
          // Unlike
          await db.collection('posts').doc(postId).update({
            likes: firebase.firestore.FieldValue.arrayRemove(currentUser.uid),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        } else {
          // Like
          await db.collection('posts').doc(postId).update({
            likes: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        // Update UI
        await loadCommunityPosts();

      } catch (error) {
        console.error('Error toggling like:', error);
        showToast('Error updating like', 'danger');
      }
    }

    // Toggle comments section
    function toggleComments(postId) {
      const commentsSection = document.getElementById(`comments-${postId}`);
      commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
    }

    // Add comment to a post - FIXED VERSION
    async function addComment(postId) {
      try {
        const commentInput = document.querySelector(`#comments-${postId} .comment-input`);
        const commentText = commentInput.value.trim();

        if (!commentText) {
          showToast('Please enter a comment', 'warning');
          return;
        }

        // Get user data properly
        const userData = window.userProfileData || {};
        const userPhotoUrl = userData.photoURL || currentUser.photoURL || '';

        const comment = {
          id: generateId(), // Generate a unique ID for the comment
          text: commentText,
          userId: currentUser.uid,
          userName: currentUser.displayName || 'User',
          userPhotoUrl: userPhotoUrl,
          timestamp: new Date(), // Use regular Date object instead of FieldValue
          reactions: {}
        };

        // Get the current post
        const postDoc = await db.collection('posts').doc(postId).get();
        if (!postDoc.exists) {
          showToast('Post not found', 'danger');
          return;
        }

        const post = postDoc.data();
        const comments = post.comments || [];

        // Add the new comment
        comments.push(comment);

        // Update the post with the new comments array
        await db.collection('posts').doc(postId).update({
          comments: comments,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp() // This is fine here, outside the array
        });

        // Clear input
        commentInput.value = '';

        showToast('Comment added successfully!', 'success');

        // Update UI
        await loadCommunityPosts();

        // Keep comments section open
        const commentsSection = document.getElementById(`comments-${postId}`);
        if (commentsSection) {
          commentsSection.style.display = 'block';
        }

      } catch (error) {
        console.error('Error adding comment:', error);
        console.error('Error details:', error.message);
        showToast('Error adding comment: ' + error.message, 'danger');
      }
    }

    // Helper function to generate unique ID
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // Add CSS for reactions
    const reactionStyles = `
  .reactions-section {
    border-top: 1px solid #e9ecef;
    border-bottom: 1px solid #e9ecef;
    padding: 10px 0;
  }
  
  .reaction-badge {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 15px;
    padding: 2px 8px;
    margin-right: 5px;
    font-size: 0.85rem;
  }
  
  .reaction-badge.small {
    font-size: 0.75rem;
    padding: 1px 6px;
  }
  
  .comment-reactions {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
  }
  
  .comment-reaction-btn {
    padding: 2px 6px;
    font-size: 0.75rem;
  }
  
  .comment {
    background-color: #f8f9fa;
    border-radius: 8px;
  }
`;

    // Add the styles to the document
    const styleSheet = document.createElement('style');
    styleSheet.textContent = reactionStyles;
    document.head.appendChild(styleSheet);

    // Other page initializations (simplified for this example)
    function initializeEventsPage() {
      // Event page initialization code would go here
    }
//events page
function loadEventsPage() {
      return `
        <div class="row mb-4">
          <div class="col-md-12">
            <div class="form-card">
              <h4>Create New Event</h4>
              <form id="createEventForm">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Event Name</label>
                      <input type="text" class="form-control" id="eventName" required placeholder="e.g. Tennis Tournament">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Sport Type</label>
                      <select class="form-select" id="eventSport" required>
                        <option value="tennis">Tennis</option>
                        <option value="badminton">Badminton</option>
                        <option value="basketball">Basketball</option>
                        <option value="football">Football</option>
                        <option value="volleyball">Volleyball</option>
                        <option value="swimming">Swimming</option>
                        <option value="other">Other</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group">
                      <label class="form-label">Start Date</label>
                      <input type="date" class="form-control" id="eventStartDate" required min="${new Date().toISOString().split('T')[0]}">
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group">
                      <label class="form-label">End Date</label>
                      <input type="date" class="form-control" id="eventEndDate">
                      <small class="text-muted">Leave empty if single day event</small>
                    </div>
                  </div>
                  <div class="col-md-4">
                    <div class="form-group">
                      <label class="form-label">Start Time</label>
                      <input
                        type="time"
                        class="form-control"
                        id="eventStartTime"
                        required
                      >
                    </div>
                  </div>

                  <div class="col-md-4">
                    <div class="form-group">
                      <label class="form-label">End Time</label>
                      <input
                        type="time"
                        class="form-control"
                        id="eventEndTime"
                        required
                      >
                    </div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">State</label>
                    <select class="form-select" id="eventState" required></select>
                  </div>

                  <div class="col-md-4">
                    <label class="form-label">District</label>
                    <select class="form-select" id="eventDistrict" required disabled></select>
                  </div>

                  <div class="col-md-4">
                    <label class="form-label">Venue Name</label>
                    <input type="text" class="form-control" id="eventLocation" placeholder="Court / Stadium name">
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Max Participants</label>
                      <input type="number" class="form-control" id="eventMaxParticipants" min="2" placeholder="Leave empty for unlimited">
                    </div>
                  </div>
                  <div class="col-md-12">
                    <div class="form-group">
                      <label class="form-label">Event Description</label>
                      <textarea class="form-control" id="eventDescription" rows="3" placeholder="Describe your event..."></textarea>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label class="form-label">Event Image</label>
                      <input type="file" id="eventImageFile" accept="image/*" class="form-control">
                      <img id="eventImagePreview" class="img-fluid mt-2 rounded" style="max-height: 200px; display:none;" />
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Contact Information</label>
                      <input type="text" class="form-control" id="eventContact" placeholder="Your contact number or email">
                    </div>
                    <div class="form-group">
                      <label class="form-label">Event Type</label>
                      <select class="form-select" id="eventType">
                        <option value="tournament">Tournament</option>
                        <option value="friendly">Friendly Match</option>
                        <option value="training">Training Session</option>
                        <option value="social">Social Gathering</option>
                        <option value="other">Other</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-12">
                    <div class="d-flex justify-content-end">
                      <button type="button" class="btn btn-secondary me-2" onclick="clearEventForm()">Clear</button>
                      <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus-circle me-2"></i> Create Event
                      </button>
                    </div>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      
        <div class="row mb-4">
          <div class="col-md-12">
            <div class="form-card">
              <h4>Filter Events</h4>
              <div class="row">
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Sport Type</label>
                    <select class="form-select" id="filterEventSport">
                      <option value="all">All Sports</option>
                      <option value="tennis">Tennis</option>
                      <option value="badminton">Badminton</option>
                      <option value="basketball">Basketball</option>
                      <option value="football">Football</option>
                      <option value="other">Other</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Event Type</label>
                    <select class="form-select" id="filterEventType">
                      <option value="all">All Types</option>
                      <option value="tournament">Tournament</option>
                      <option value="friendly">Friendly Match</option>
                      <option value="training">Training Session</option>
                      <option value="social">Social Gathering</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Date Range</label>
                    <select class="form-select" id="filterEventDate">
                      <option value="all">All Dates</option>
                      <option value="today">Today</option>
                      <option value="week">This Week</option>
                      <option value="month">This Month</option>
                      <option value="upcoming">Upcoming</option>
                      <option value="past">Past Events</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Show</label>
                    <select class="form-select" id="filterEventShow">
                      <option value="all">All Events</option>
                      <option value="my">My Events</option>
                      <option value="registered">Registered Events</option>
                      <option value="available">Available to Join</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-md-3">
                  <label class="form-label">State</label>
                  <select class="form-select" id="filterEventState">
                    <option value="all">All States</option>
                  </select>
                </div>
              
                <div class="col-md-3">
                  <label class="form-label">District</label>
                  <select class="form-select" id="filterEventDistrict" disabled>
                    <option value="all">All Districts</option>
                  </select>
                </div>
              </div>
              <div class="row mt-3">
                <div class="col-md-12">
                  <div class="d-flex justify-content-between">
                    <button class="btn btn-primary" id="filterEventsBtn">
                      <i class="fas fa-filter me-2"></i> Apply Filters
                    </button>
                    <button class="btn btn-outline-secondary" id="clearEventFiltersBtn">
                      <i class="fas fa-times me-2"></i> Clear Filters
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      
        <div class="row" id="eventsList">
          <!-- Events will be loaded dynamically -->
          <div class="col-12 text-center">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading events...</span>
            </div>
          </div>
        </div>
      `;
      document.getElementById("eventStartTime").addEventListener("change", () => {
        const start = document.getElementById("eventStartTime").value;
        const endInput = document.getElementById("eventEndTime");

        if (start) {
          endInput.min = start;
        }
      });
    }
    function initEventCreateLocation() {
  const stateEl = document.getElementById("eventState");
  const districtEl = document.getElementById("eventDistrict");

  if (!stateEl || !districtEl) return;

  stateEl.innerHTML = `<option value="">Select State</option>`;
  districtEl.innerHTML = `<option value="">Select District</option>`;

  Object.keys(MALAYSIA_LOCATIONS).forEach(state => {
    stateEl.innerHTML += `<option value="${state}">${state}</option>`;
  });

  stateEl.onchange = () => {
    districtEl.disabled = false;
    districtEl.innerHTML = `<option value="">Select District</option>`;

    MALAYSIA_LOCATIONS[stateEl.value].forEach(d => {
      districtEl.innerHTML += `<option value="${d}">${d}</option>`;
    });
  };
}
function initEventFilterLocation() {
  const stateEl = document.getElementById("filterEventState");
  const districtEl = document.getElementById("filterEventDistrict");

  Object.keys(MALAYSIA_LOCATIONS).forEach(state => {
    stateEl.innerHTML += `<option value="${state}">${state}</option>`;
  });

  stateEl.onchange = () => {
    districtEl.disabled = stateEl.value === "all";
    districtEl.innerHTML = `<option value="all">All Districts</option>`;

    if (stateEl.value !== "all") {
      MALAYSIA_LOCATIONS[stateEl.value].forEach(d => {
        districtEl.innerHTML += `<option value="${d}">${d}</option>`;
      });
    }
  };
}
async function initializeEventsPage() {
  // Image preview
  document.getElementById('eventImageFile')?.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      const preview = document.getElementById('eventImagePreview');
      preview.src = URL.createObjectURL(file);
      preview.style.display = 'block';
    }
  });

  // Form submission
  document.getElementById('createEventForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    await createEvent();
  });

  // Filter buttons
  document.getElementById('filterEventsBtn')?.addEventListener('click', () => {
    filterEvents();
  });

  document.getElementById('clearEventFiltersBtn')?.addEventListener('click', () => {
    clearEventFilters();
  });

  // Load all events initially
  await loadEvents();
  initEventCreateLocation();
  initEventFilterLocation();
}
// Clear event form
function clearEventForm() {
  document.getElementById('createEventForm').reset();
  const preview = document.getElementById('eventImagePreview');
  preview.style.display = 'none';
  preview.src = '';
}

// Create new event
async function createEvent() {
  try {
    const eventData = {
      name: document.getElementById('eventName').value.trim(),
      sport: document.getElementById('eventSport').value,
      startDate: document.getElementById('eventStartDate').value,
      endDate: document.getElementById('eventEndDate').value || document.getElementById('eventStartDate').value,
      startTime: document.getElementById('eventStartTime').value,
      endTime: document.getElementById('eventEndTime').value,
      state: document.getElementById("eventState").value,
      district: document.getElementById("eventDistrict").value,
      location: document.getElementById('eventLocation').value.trim(),
      maxParticipants: document.getElementById('eventMaxParticipants').value ? parseInt(document.getElementById('eventMaxParticipants').value) : null,
      description: document.getElementById('eventDescription').value.trim(),
      contactInfo: document.getElementById('eventContact').value.trim(),
      type: document.getElementById('eventType').value,
      creatorId: currentUser.uid,
      creatorName: window.userProfileData?.name || currentUser.displayName || 'User',
      participants: [], // Empty array initially
      status: 'upcoming',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // Upload image if selected
    const imageFile = document.getElementById('eventImageFile').files[0];
    if (imageFile) {
      const imageUrl = await uploadToCloudinary(imageFile);
      eventData.imageUrl = imageUrl;
    }

    // Save to Firestore
    await db.collection('events').add(eventData);

    showToast('Event created successfully!', 'success');
    clearEventForm();
    await loadEvents(); // Reload events list

  } catch (error) {
    console.error('Error creating event:', error);
    showToast('Error creating event: ' + error.message, 'danger');
  }
}

// Load events with filters
async function loadEvents(filters = {}) {
  try {
    const eventsList = document.getElementById('eventsList');
    eventsList.innerHTML = '<div class="col-12 text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading events...</span></div></div>';

    let eventsQuery = db.collection('events').orderBy('startDate', 'asc');
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Apply filters
    if (filters.dateRange) {
      if (filters.dateRange === 'today') {
        eventsQuery = eventsQuery.where('startDate', '==', today.toISOString().split('T')[0]);
      } else if (filters.dateRange === 'upcoming') {
        eventsQuery = eventsQuery.where('startDate', '>=', today);
      } else if (filters.dateRange === 'past') {
        eventsQuery = eventsQuery.where('startDate', '<', today);
      }
    }

    const eventsSnapshot = await eventsQuery.get();
    
    let events = [];
    eventsSnapshot.forEach(doc => {
      const event = {
        id: doc.id,
        ...doc.data()
      };
      events.push(event);
    });

    // Apply additional filters client-side
    if (filters.sport && filters.sport !== 'all') {
      events = events.filter(event => event.sport === filters.sport);
    }

    if (filters.eventType && filters.eventType !== 'all') {
      events = events.filter(event => event.type === filters.eventType);
    }

    if (filters.show === 'my') {
      events = events.filter(event => event.creatorId === currentUser.uid);
    } else if (filters.show === 'registered') {
      events = events.filter(event => 
        event.participants && event.participants.includes(currentUser.uid)
      );
    } else if (filters.show === 'available') {
      events = events.filter(event => {
        const isFull = event.maxParticipants && 
                      event.participants && 
                      event.participants.length >= event.maxParticipants;
        const isRegistered = event.participants && 
                           event.participants.includes(currentUser.uid);
        return !isFull && !isRegistered && event.creatorId !== currentUser.uid;
      });
    }

    // Filter by date for week/month
    if (filters.dateRange === 'week') {
      const nextWeek = new Date();
      nextWeek.setDate(nextWeek.getDate() + 7);
      events = events.filter(event => {
        const eventDate = new Date(event.startDate);
        return eventDate >= today && eventDate <= nextWeek;
      });
    } else if (filters.dateRange === 'month') {
      const nextMonth = new Date();
      nextMonth.setMonth(nextMonth.getMonth() + 1);
      events = events.filter(event => {
        const eventDate = new Date(event.startDate);
        return eventDate >= today && eventDate <= nextMonth;
      });
    }
    if (filters.state && filters.state !== "all") {
      events = events.filter(e => e.state === filters.state);
    }

    if (filters.district && filters.district !== "all") {
      events = events.filter(e => e.district === filters.district);
    }

    renderEvents(events);

  } catch (error) {
    console.error('Error loading events:', error);
    const eventsList = document.getElementById('eventsList');
    eventsList.innerHTML = `
      <div class="col-12 text-center">
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Error loading events: ${error.message}
        </div>
      </div>
    `;
  }
}
async function resolveEventLocation(event) {
  // Priority 1: direct event location
  if (event.location) {
    return event.location;
  }

  // Priority 2: facility-based location
  if (event.facilityId) {
    const facilityDoc = await db
      .collection("facilities")
      .doc(event.facilityId)
      .get();

    if (facilityDoc.exists) {
      return facilityDoc.data().location || "";
    }
  }

  return "";
}
async function resolveEventCreatorName(event) {
  // Priority 1: direct event location
  if (event.creatorName) {
    return event.creatorName;
  }

  // Priority 2: facility-based location
  if (event.creatorId) {
    const usersDoc = await db
      .collection("users")
      .doc(event.creatorId)
      .get();

    if (usersDoc.exists) {
      return usersDoc.data().name || "";
    }
  }

  return "";
}
// Render events list
async function renderEvents(events) {
  const eventsList = document.getElementById('eventsList');
  eventsList.innerHTML = '';

  if (events.length === 0) {
    eventsList.innerHTML = `
      <div class="col-12 text-center">
        <div class="alert alert-info">
          <i class="fas fa-info-circle me-2"></i>
          No events found matching your criteria.
        </div>
      </div>
    `;
    return;
  }

  for (const event of events) {
    const col = document.createElement('div');
    col.className = 'col-md-4 mb-4';
    
    // Check if user is registered
    const isRegistered = event.participants && 
                        event.participants.includes(currentUser.uid);
    const isCreator = event.creatorId === currentUser.uid;
    const isFull = event.maxParticipants && 
                   event.participants && 
                   event.participants.length >= event.maxParticipants;
    
    // Format date
    const startDate = new Date(event.startDate);
    const formattedDate = startDate.toLocaleDateString('en-US', {
      weekday: 'short',
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });

    // Calculate participants info
    const participantsCount = event.participants ? event.participants.length : 0;
    const spotsLeft = event.maxParticipants ? 
                     event.maxParticipants - participantsCount : 'Unlimited';
    const locationText = await resolveEventLocation(event);
    const creatorNames = await resolveEventCreatorName(event);

    col.innerHTML = `
      <div class="card h-100 event-card">
        <img src="${event.imageUrl || 'https://via.placeholder.com/300x200?text=Event'}" 
             class="card-img-top" alt="${event.name}"
             style="height: 200px; object-fit: cover;"
             onerror="this.src='https://via.placeholder.com/300x200?text=Event'">
        <div class="card-body d-flex flex-column">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="card-title">${event.name}</h5>
            <span class="badge bg-primary text-capitalize">${event.type}</span>
          </div>
          <p class="card-text flex-grow-1">${event.description || 'No description provided'}</p>
          
          <div class="mb-3">
            <p class="mb-1">
              <i class="fas fa-calendar-alt me-2"></i>
              ${formattedDate}
              ${event.time ? `<br><small><i class="fas fa-clock me-2"></i>${event.time}</small>` : ''}
            </p>
            <p class="mb-1">
              <i class="fas fa-map-marker-alt me-2"></i>
              ${event.location || ''},${event.district || ''}, ${event.state || ''}
            </p>
            <p class="mb-1">
              <i class="fas fa-users me-2"></i>
              ${participantsCount} participants
              ${event.maxParticipants ? `<br><small>${spotsLeft} spots left</small>` : ''}
            </p>
            <p class="mb-0">
              <i class="fas fa-basketball-ball me-2"></i>
              ${event.sport}
            </p>
          </div>

          <div class="mt-auto">
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">
                By: ${creatorNames}
              </small>
              
              ${isCreator ? `
                <span class="badge bg-success">Created by You</span>
              ` : isRegistered ? `
                <span class="badge bg-info">Registered</span>
              ` : isFull ? `
                <span class="badge bg-danger">Full</span>
              ` : `
                <button class="btn btn-sm btn-primary register-event-btn" 
                        data-event-id="${event.id}">
                  <i class="fas fa-user-plus me-1"></i> Register
                </button>
              `}
            </div>
            
            <div class="mt-2">
              <button class="btn btn-sm btn-outline-secondary view-event-btn w-100" 
                      data-event-id="${event.id}">
                <i class="fas fa-eye me-1"></i> View Details
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

    eventsList.appendChild(col);
  };

  // Add event listeners
  addEventListeners();
}

// Add event listeners for register and view buttons
function addEventListeners() {
  // Register buttons
  document.querySelectorAll('.register-event-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const eventId = this.getAttribute('data-event-id');
      registerForEventFromList(eventId);
    });
  });

  // View details buttons
  document.querySelectorAll('.view-event-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const eventId = this.getAttribute('data-event-id');
      viewEventDetails(eventId);
    });
  });
}

// Register for event from events list
async function registerForEventFromList(eventId) {
  try {
    const eventDoc = await db.collection('events').doc(eventId).get();
    if (!eventDoc.exists) {
      showToast('Event not found', 'danger');
      return;
    }

    const event = eventDoc.data();
    
    // Check if already registered
    if (event.participants && event.participants.includes(currentUser.uid)) {
      showToast('You are already registered for this event', 'warning');
      return;
    }

    // Check if event is full
    if (event.maxParticipants && event.participants && 
        event.participants.length >= event.maxParticipants) {
      showToast('This event is already full', 'warning');
      return;
    }

    // Register user
    await db.collection('events').doc(eventId).update({
      participants: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showToast('Successfully registered for the event!', 'success');
    await loadEvents(); // Reload events

  } catch (error) {
    console.error('Error registering for event:', error);
    showToast('Error registering for event: ' + error.message, 'danger');
  }
}

// View event details
async function viewEventDetails(eventId) {
  try {
    const eventDoc = await db.collection('events').doc(eventId).get();
    if (!eventDoc.exists) {
      showToast('Event not found', 'danger');
      return;
    }

    const event = eventDoc.data();
    const isRegistered = event.participants && 
                        event.participants.includes(currentUser.uid);
    const isCreator = event.creatorId === currentUser.uid;
    const locationText = await resolveEventLocation(event);
    const creatorNames = await resolveEventCreatorName(event);

    // Format dates
    const startDate = new Date(event.startDate);
    const formattedStartDate = startDate.toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    let formattedEndDate = '';
    if (event.endDate && event.endDate !== event.startDate) {
      const endDate = new Date(event.endDate);
      formattedEndDate = endDate.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    }

    // Get participants list
    let participantsList = [];
    if (event.participants && event.participants.length > 0) {
      const participantPromises = event.participants.map(async (userId) => {
        const userDoc = await db.collection('users').doc(userId).get();
        return userDoc.exists ? userDoc.data().name || 'User' : 'User';
      });
      participantsList = await Promise.all(participantPromises);
    }

    // Create modal
    const modalHtml = `
      <div class="modal fade" id="eventDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title">Event Details</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6">
                  <img src="${event.imageUrl || 'https://via.placeholder.com/500x300?text=Event'}" 
                       class="img-fluid rounded mb-3" alt="${event.name}"
                       onerror="this.src='https://via.placeholder.com/500x300?text=Event'">
                </div>
                <div class="col-md-6">
                  <h4>${event.name}</h4>
                  <p class="text-muted">${event.type.charAt(0).toUpperCase() + event.type.slice(1)} ‚Ä¢ ${event.sport}</p>
                  
                  <div class="mb-4">
                    <h6>Event Information</h6>
                    <p><strong>Date:</strong> ${formattedStartDate}</p>
                    ${formattedEndDate ? `<p><strong>End Date:</strong> ${formattedEndDate}</p>` : ''}
                    ${event.startTime ? `<p><strong>Time:</strong> ${event.startTime}` : ''} - 
                    ${event.endTime ? `${event.endTime}</p>` : ''}
                    <p><strong>Location:</strong> ${event.location},${event.district},${event.state}</p>
                    ${event.contactInfo ? `<p><strong>Contact:</strong> ${event.contactInfo}</p>` : ''}
                  </div>
                </div>
              </div>
              
              <div class="row mt-4">
                <div class="col-md-12">
                  <h6>Description</h6>
                  <p>${event.description || 'No description provided.'}</p>
                </div>
              </div>
              
              <div class="row mt-4">
                <div class="col-md-6">
                  <h6>Participants (${participantsList.length}${event.maxParticipants ? '/' + event.maxParticipants : ''})</h6>
                  ${participantsList.length > 0 ? 
                    `<ul class="list-group">
                      ${participantsList.map(participant => `<li class="list-group-item">${participant}</li>`).join('')}
                    </ul>` :
                    `<p class="text-muted">No participants yet.</p>`
                  }
                </div>
                
                <div class="col-md-6">
                  <h6>Event Details</h6>
                  <ul class="list-group">
                    <li class="list-group-item d-flex justify-content-between">
                      <span>Organizer:</span>
                      <span>${creatorNames}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>Status:</span>
                      <span class="badge ${event.status === 'upcoming' ? 'bg-primary' : 'bg-success'}">
                        ${event.status}
                      </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                      <span>Spots Available:</span>
                      <span>${event.maxParticipants ? 
                             (event.maxParticipants - participantsList.length) + ' remaining' : 
                             'Unlimited'}</span>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              
              ${!isCreator && !isRegistered && 
                (!event.maxParticipants || participantsList.length < event.maxParticipants) ? `
                <button type="button" class="btn btn-primary" onclick="registerForEventFromModal('${eventId}')">
                  <i class="fas fa-user-plus me-2"></i> Register Now
                </button>
              ` : isRegistered ? `
                <button type="button" class="btn btn-warning" onclick="unregisterFromEvent('${eventId}')">
                  <i class="fas fa-user-minus me-2"></i> Unregister
                </button>
              ` : ''}
              
              ${isCreator ? `
                <button type="button" class="btn btn-danger" onclick="deleteEvent('${eventId}')">
                  <i class="fas fa-trash me-2"></i> Delete Event
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      </div>
    `;

    // Remove existing modal
    const existingModal = document.getElementById('eventDetailsModal');
    if (existingModal) existingModal.remove();

    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('eventDetailsModal'));
    modal.show();

    // Remove modal when hidden
    document.getElementById('eventDetailsModal').addEventListener('hidden.bs.modal', function() {
      this.remove();
    });

  } catch (error) {
    console.error('Error viewing event details:', error);
    showToast('Error loading event details', 'danger');
  }
}

// Register from modal
async function registerForEventFromModal(eventId) {
  await registerForEventFromList(eventId);
  
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('eventDetailsModal'));
  if (modal) modal.hide();
}

// Unregister from event
async function unregisterFromEvent(eventId) {
  if (!confirm('Are you sure you want to unregister from this event?')) return;

  try {
    await db.collection('events').doc(eventId).update({
      participants: firebase.firestore.FieldValue.arrayRemove(currentUser.uid),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showToast('Successfully unregistered from event', 'success');
    await loadEvents(); // Reload events
    
    // Close modal if open
    const modal = bootstrap.Modal.getInstance(document.getElementById('eventDetailsModal'));
    if (modal) modal.hide();

  } catch (error) {
    console.error('Error unregistering from event:', error);
    showToast('Error unregistering from event', 'danger');
  }
}

// Delete event (creator only)
async function deleteEvent(eventId) {
  if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) return;

  try {
    await db.collection('events').doc(eventId).delete();
    showToast('Event deleted successfully', 'success');
    await loadEvents(); // Reload events
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('eventDetailsModal'));
    if (modal) modal.hide();

  } catch (error) {
    console.error('Error deleting event:', error);
    showToast('Error deleting event', 'danger');
  }
}

// Filter events
function filterEvents() {
  const filters = {
    sport: document.getElementById('filterEventSport').value,
    eventType: document.getElementById('filterEventType').value,
    dateRange: document.getElementById('filterEventDate').value,
    show: document.getElementById('filterEventShow').value,
    state: document.getElementById('filterEventState').value,
    district: document.getElementById('filterEventDistrict').value
  };

  loadEvents(filters);
}

// Clear event filters
function clearEventFilters() {
  document.getElementById('filterEventSport').value = 'all';
  document.getElementById('filterEventType').value = 'all';
  document.getElementById('filterEventDate').value = 'all';
  document.getElementById('filterEventShow').value = 'all';
  
  loadEvents(); // Load all events
}
//profile page
function loadProfilePage() {
      return `
        <div class="row">
          <div class="col-md-4">
            <div class="form-card text-center">
              <img src="https://via.placeholder.com/150" class="rounded-circle mb-3" alt="Profile" style="width: 150px; height: 150px; object-fit: cover;" id="profileImage">
              <h4 id="profileName">${currentUser ? currentUser.displayName || 'User' : 'User'}</h4>
              <p class="text-muted" id="profileSport">Tennis Enthusiast</p>
              <div class="form-group mt-3 text-center">
  <label class="form-label">Change Profile Picture</label>
  <input type="file" id="profileImageFile" accept="image/*" class="form-control">
</div>
            </div>

            <div class="form-card mt-4">
              <h5>Statistics</h5>
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Total Bookings
                  <span class="badge bg-primary rounded-pill" id="profileTotalBookings">0</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Friends
                  <span class="badge bg-primary rounded-pill" id="profileTotalFriends">0</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Events Attended
                  <span class="badge bg-primary rounded-pill" id="profileEventsAttended">0</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Loyalty Points
                  <span class="badge bg-primary rounded-pill" id="profileLoyaltyPoints">0</span>
                </li>
              </ul>
            </div>
          </div>
          <div class="col-md-8">
            <div class="form-card">
              <h5>Personal Information</h5>
              <form id="profileForm">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Full Name</label>
                      <input type="text" class="form-control" id="profileFullName" value="${currentUser ? currentUser.displayName || '' : ''}">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Email</label>
                      <input type="email" class="form-control" id="profileEmail" value="${currentUser ? currentUser.email || '' : ''}" readonly>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Phone</label>
                      <input type="tel" class="form-control" id="profilePhone" placeholder="+6012-345-6789">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Location</label>
                      <input type="text" class="form-control" id="profileLocation" placeholder="Kuala Lumpur">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Primary Sport</label>
                      <select class="form-select" id="profilePrimarySport">
                        <option value="tennis" selected>Tennis</option>
                        <option value="badminton">Badminton</option>
                        <option value="basketball">Basketball</option>
                        <option value="football">Football</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Skill Level</label>
                      <select class="form-select" id="profileSkillLevel">
                        <option value="beginner">Beginner</option>
                        <option value="intermediate" selected>Intermediate</option>
                        <option value="advanced">Advanced</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-group">
                      <label class="form-label">Bio</label>
                      <textarea class="form-control" id="profileBio" rows="3" placeholder="Tell us about yourself"></textarea>
                    </div>
                  </div>
                  <div class="col-12">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
    }
// Initialize Profile Page
    async function initializeProfilePage() {
      // Load profile data from Firestore
      const userData = window.userProfileData || {};

      // Update profile image with photoUrl from users collection
      const profileImage = document.getElementById('profileImage');
      if (userData.photoURL) {
        profileImage.src = userData.photoURL;
      } else if (currentUser.photoURL) {
        profileImage.src = currentUser.photoURL;
      } else {
        profileImage.src = generateDefaultAvatar(userData.name || currentUser.displayName || currentUser.email);
      }

      // Update profile form fields
      document.getElementById('profileFullName').value = userData.name || currentUser.displayName || '';
      document.getElementById('profilePhone').value = userData.phone || '';
      document.getElementById('profileLocation').value = userData.location || '';
      document.getElementById('profilePrimarySport').value = userData.primarySport || 'tennis';
      document.getElementById('profileSkillLevel').value = userData.skillLevel || 'intermediate';
      document.getElementById('profileBio').value = userData.bio || '';

      // Update profile statistics
      document.getElementById('profileTotalBookings').textContent = await calculateUserBookings(currentUser.uid);
      document.getElementById('profileTotalFriends').textContent = await calculateUserFriends(currentUser.uid);
      document.getElementById('profileLoyaltyPoints').textContent = userData.loyaltyPoints || 0;

      // Set up profile form submission
      document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await updateProfile();
      });
    }

    async function updateProfile() {
  try {
    // Collect text values
    const profileData = {
      name: document.getElementById('profileFullName').value,
      phone: document.getElementById('profilePhone').value,
      location: document.getElementById('profileLocation').value,
      primarySport: document.getElementById('profilePrimarySport').value,
      skillLevel: document.getElementById('profileSkillLevel').value,
      bio: document.getElementById('profileBio').value,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    // Image upload logic
    const imageFile = document.getElementById("profileImageFile").files[0];

    if (imageFile) {
      // Upload to Cloudinary
      const uploadedUrl = await uploadToCloudinary(imageFile);
      profileData.photoURL = uploadedUrl;  // Save new photo
    }

    // Update Firestore
    await db.collection('users').doc(currentUser.uid).update(profileData);

    // Update Firebase Auth display name
    await currentUser.updateProfile({
      displayName: profileData.name,
      photoURL: profileData.photoURL || currentUser.photoURL
    });

    // Update UI instantly
    if (profileData.photoURL) {
      document.getElementById('profileImage').src = profileData.photoURL;
    }

    // Update global data
    window.userProfileData = { ...window.userProfileData, ...profileData };

    showToast('Profile updated successfully', 'success');

  } catch (error) {
    console.error('Error updating profile:', error);
    showToast('Error updating profile', 'danger');
  }
}
  </script>
</body>

</html>